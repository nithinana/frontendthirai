<!DOCTYPE html>
<html lang="en">
<head>

  <script async src="https://www.googletagmanager.com/gtag/js?id=G-HKV7GQ766F"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-HKV7GQ766F');
</script>

<script>
  // CAPTURE ORIGINAL URL BEFORE REWRITING
  const ORIGINAL_SEARCH_PARAMS = window.location.search;

  (function() {
    const urlParams = new URLSearchParams(window.location.search);
    const movieCode = urlParams.get('film');

    if (movieCode) {
      const formID = "1FAIpQLSeg_JCKjxY_5W977CB5-hFqLpemBCw_o477qV-6vlDKFFJ_VQ";
      const entryID = "entry.132457679"; 

      const finalURL = `https://docs.google.com/forms/d/e/${formID}/formResponse?${entryID}=${encodeURIComponent(movieCode)}&submit=Submit`;

      if (navigator.sendBeacon) {
        navigator.sendBeacon(finalURL);
      } else {
        fetch(finalURL, { mode: 'no-cors' });
      }
      console.log("Tracking sent: " + movieCode);
    }
  })();
</script>
 
<script>
    (function() {
        try {
            const urlParams = new URLSearchParams(window.location.search);
            const movieUrl = urlParams.get('url');
            let needsRewrite = false;

            if (movieUrl) {
                needsRewrite = true;
                const movieCodeMatch = movieUrl.match(/\/watch\/([a-zA-Z0-9]+)/);

                if (movieCodeMatch && movieCodeMatch[1]) {
                    const movieCode = movieCodeMatch[1];
                    urlParams.set('film', movieCode);
                    urlParams.delete('url');
                }
            }
            
            if (urlParams.has('title')) {
                needsRewrite = true;
                urlParams.delete('title');
            }

            if(needsRewrite) {
                const newUrl = `${window.location.pathname}?${urlParams.toString()}`;
                window.history.replaceState({ path: newUrl }, '', newUrl);
                console.log('URL has been rewritten.');
            }

        } catch (error) {
            console.error('Error rewriting URL:', error);
        }
    })();
</script>

    <script src="https://www.gstatic.com/cv/js/sender/v1/cast_sender.js?loadCastFramework=1"></script>

    <meta name="screen-orientation" content="landscape">
    <link rel="manifest" href="/manifest.json">

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Thirai">

<link rel="apple-touch-icon" href="/static/ios/icon-192x192.png">
<link rel="apple-touch-icon" sizes="152x152" href="/static/ios/icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="/static/ios/icon-180x180.png">
<link rel="apple-touch-icon" sizes="167x167" href="/static/ios/icon-167x167.png">

<link rel="apple-touch-startup-image" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2)" href="/static/splash/launch-750x1334.png">
<link rel="apple-touch-startup-image" media="(device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3)" href="/static/splash/launch-1242x2208.png">
<link rel="apple-touch-startup-image" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3)" href="/static/splash/launch-1125x2436.png">
<link rel="apple-touch-startup-image" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2)" href="/static/splash/launch-828x1792.png">
<link rel="apple-touch-startup-image" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3)" href="/static/splash/launch-1242x2688.png">
<link rel="apple-touch-startup-image" media="(device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3)" href="/static/splash/launch-1080x2340.png">
<link rel="apple-touch-startup-image" media="(device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3)" href="/static/splash/launch-1170x2532.png">
<link rel="apple-touch-startup-image" media="(device-width: 428px) and (device-height: 926px) and (-webkit-device-pixel-ratio: 3)" href="/static/splash/launch-1284x2778.png">

    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Thirai</title>
    <link rel="icon" type="image/png" href="/static/favicon.png"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"/>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: black;
            font-family: 'Inter', sans-serif;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        .video-player-wrapper {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: black;
        }

        #moviePlayer {
            transform: scale(1);
            transform-origin: center center;
            transition: transform 0.3s ease-in-out;
            position: relative;
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: block;
            controls: none;
        }

        .video-player-wrapper video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
            controls: none;
        }

        video::-webkit-media-controls { display: none !important; }
        video::-webkit-media-controls-enclosure { display: none !important; }
        video::-moz-range-track { background: transparent; }
        video::-moz-range-thumb { background: transparent; }

        .custom-controls-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            background: rgba(0, 0, 0, 0.4);
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 10;
            pointer-events: none;
        }

        .custom-controls-overlay.visible {
            opacity: 1;
            pointer-events: auto;
        }

        .top-controls {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem 1.5rem 1rem;
            box-sizing: border-box;
        }

        .movie-title-display {
            color: white;
            font-size: 1.2rem;
            font-weight: bold;
            text-align: center;
            flex-grow: 1;
            margin: 0 1rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 1.5rem;
        }

        .center-controls {
            display: flex;
            align-items: center;
            gap: 2rem;
        }

        .bottom-controls {
            width: 100%;
            padding: 1rem 1.5rem 2rem;
            box-sizing: border-box;
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: center;
            gap: 1rem;
        }

        .control-button {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 2.2rem;
            cursor: pointer;
            padding: 0.8rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s ease, transform 0.1s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            -webkit-tap-highlight-color: transparent;
        }

        .control-button:hover:not(:disabled) {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }

        .control-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            box-shadow: none;
        }

        #playPauseButton {
            font-size: 3.5rem;
            padding: 1.2rem;
        }

        .progress-bar-container {
            flex-grow: 1;
            height: 8px;
            background-color: rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            cursor: grab;
            position: relative;
            margin: 0 1rem;
        }

        .progress-bar {
            height: 100%;
            width: 0%;
            background-color: #0d6efd;
            border-radius: 10px;
            transition: width 0.1s linear;
        }

        .progress-bar-handle {
            position: absolute;
            top: 50%;
            left: 0%;
            transform: translate(-50%, -50%);
            width: 20px;
            height: 20px;
            background-color: white;
            border-radius: 50%;
            display: none;
            box-shadow: 0 0 8px rgba(0,0,0,0.6);
            transition: transform 0.1s ease;
        }
        .progress-bar-container:hover .progress-bar-handle,
        .progress-bar-container.dragging .progress-bar-handle {
            display: block;
            transform: translate(-50%, -50%) scale(1.1);
        }

        .time-display {
            color: white;
            font-size: 1rem;
            white-space: nowrap;
            order: 2;
        }
        .progress-bar-container {
            order: 1;
        }

        .spinner-border {
            width: 2rem;
            height: 2rem;
            color: white;
            border-width: 0.25em;
            vertical-align: middle;
            border-radius: 50%;
            animation: spinner-border .75s linear infinite;
            border-right-color: transparent;
            display: inline-block;
        }
        @keyframes spinner-border {
            to { transform: rotate(360deg); }
        }

        .top-button {
            background: transparent;
            border: none;
            color: white;
            font-size: 1.5rem;
            padding: 0.7rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            -webkit-tap-highlight-color: transparent;
        }
        .top-button:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        .top-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .visually-hidden {
            position: absolute;
            width: 1px;
            height: 1px;
            margin: -1px;
            padding: 0;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            border: 0;
        }

        #fullscreenButton {
            background: transparent;
            box-shadow: none;
            padding: 0.5rem;
            font-size: 1.8rem;
            order: 10;
        }

        #fullscreenButton:hover:not(:disabled) {
            background: rgba(255, 255, 255, 0.1);
            transform: scale(1.1);
        }

        .volume-container {
            display: flex;
            align-items: center;
            order: 4;
            position: relative;
        }

        #volumeButton {
            background: transparent;
            box-shadow: none;
            padding: 0.5rem;
            font-size: 1.8rem;
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        #volumeButton:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: scale(1.1);
        }

        .volume-slider {
            -webkit-appearance: none;
            appearance: none;
            width: 0px;
            height: 4px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 2px;
            outline: none;
            opacity: 0;
            transition: width 0.3s ease, opacity 0.3s ease;
            cursor: pointer;
            margin-left: 0.5rem;
        }

        .volume-container:hover .volume-slider,
        .volume-slider:active,
        .volume-slider:focus {
            width: 70px;
            opacity: 1;
        }

        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
        }

        .volume-slider::-moz-range-thumb {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            border: none;
        }

    
        /* --- WATCH PARTY UI --- */
        .party-modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.65);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        .party-modal-backdrop.show { display: flex; }
        .party-modal {
            width: min(520px, 92vw);
            background: rgba(20,20,20,0.98);
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 16px;
            padding: 18px;
            color: #fff;
            box-shadow: 0 20px 80px rgba(0,0,0,0.6);
        }
        .party-modal h2 {
            margin: 0 0 10px;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .party-row { display: flex; gap: 10px; flex-wrap: wrap; }
        .party-field {
            flex: 1 1 200px;
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-top: 10px;
        }
        .party-field label {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        .party-field input {
            height: 44px;
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.18);
            background: rgba(255,255,255,0.06);
            color: white;
            padding: 0 12px;
            outline: none;
            font-size: 1rem;
        }
        .party-field input:focus {
            border-color: rgba(13,110,253,0.9);
        }
        .party-mode {
            display: flex;
            gap: 10px;
            margin-top: 12px;
        }
        .party-mode .party-btn {
            flex: 1;
            justify-content: center;
        }
        .party-actions {
            display: flex;
            gap: 10px;
            margin-top: 14px;
            flex-wrap: wrap;
            justify-content: flex-end;
        }
        .party-btn {
            border: none;
            border-radius: 10px;
            padding: 10px 14px;
            cursor: pointer;
            font-size: 0.95rem;
        }
        .party-btn.primary { background: #0d6efd; color: white; }
        .party-btn.secondary { background: rgba(255,255,255,0.12); color: white; }
        .party-btn.danger { background: rgba(220,53,69,0.9); color: white; }
        .party-hint { opacity: 0.85; font-size: 0.9rem; margin-top: 6px; }
        .party-users {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid rgba(255,255,255,0.12);
            max-height: 180px;
            overflow: auto;
        }
        .party-users .u { padding: 6px 0; opacity: 0.95; }
        .party-status {
            display: none;
            position: fixed;
            left: 12px;
            bottom: 12px;
            z-index: 9998;
            background: rgba(0,0,0,0.6);
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 999px;
            padding: 8px 12px;
            color: white;
            font-size: 0.95rem;
            display: none;
            align-items: center;
            gap: 8px;
        }
        .party-status.show { display: flex; }

    </style>
</head>
<body>
    <div class="video-player-wrapper" id="videoPlayerWrapper">
        <video id="moviePlayer" playsinline webkit-playsinline preload="auto" autoplay>
            </video>

        <div class="custom-controls-overlay" id="customControlsOverlay">
            <div class="top-controls">
                <button id="backButton" class="top-button">
                    <i class="bi bi-arrow-left"></i>
                </button>
                <div class="movie-title-display" id="movieTitleDisplay">Thirai</div>
                <a href="#" id="downloadButton" download="Thirai.mp4" class="top-button" style="display: none;">
                    <i class="bi bi-download"></i>
                </a>
                <button id="magnificationButton" class="top-button">
                    <i class="bi bi-zoom-in"></i> </button>
                <button id="castButton" class="top-button" style="display: none;">
                    <i class="bi bi-cast"></i>
                </button>
            
                <button id="watchPartyButton" class="top-button" title="Watch Party">
                    <i class="bi bi-people-fill"></i>
                </button>
</div>

            <div class="center-controls">
                <button id="rewindButton" class="control-button">
                    <i class="bi bi-arrow-counterclockwise"></i>
                </button>
                <button id="playPauseButton" class="control-button">
                    <i class="bi bi-play-fill"></i>
                    <div class="spinner-border" role="status" style="display: none;">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </button>
                <button id="forwardButton" class="control-button">
                    <i class="bi bi-arrow-clockwise"></i>
                </button>
            </div>

            <div class="bottom-controls">
                <div class="progress-bar-container" id="progressBarContainer">
                    <div class="progress-bar" id="progressBar"></div>
                    <div class="progress-bar-handle" id="progressBarHandle"></div>
                </div>
                <span class="time-display" id="timeDisplay">00:00 / 00:00</span>
                
                <div class="volume-container">
                    <button id="volumeButton">
                        <i class="bi bi-volume-up-fill"></i>
                    </button>
                    <input type="range" id="volumeSlider" class="volume-slider" min="0" max="1" step="0.05" value="1">
                </div>
                <button id="fullscreenButton" class="control-button">
                    <i class="bi bi-arrows-fullscreen"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- WATCH PARTY MODAL -->
    <div class="party-modal-backdrop" id="partyModalBackdrop" aria-hidden="true">
        <div class="party-modal" role="dialog" aria-modal="true" aria-labelledby="partyTitle">
            <h2 id="partyTitle"><i class="bi bi-people-fill"></i> Watch Party</h2>
            <div class="party-hint" id="partyHint">
                Create a party to sync playback, or join with a code.
            </div>

            <div class="party-mode">
                <button class="party-btn primary" id="partyModeHostBtn">Host</button>
                <button class="party-btn primary" id="partyModeJoinBtn">Join</button>
            </div>

            <div class="party-row" id="partyJoinFields" style="display:none;">
                <div class="party-field">
                    <label for="partyCodeInput">Party code</label>
                    <input id="partyCodeInput" placeholder="e.g. 5KUBL8" autocomplete="off" />
                </div>
                <div class="party-field">
                    <label for="partyNameInput">Your name</label>
                    <input id="partyNameInput" placeholder="e.g. Emma" autocomplete="name" />
                </div>
            </div>

            <div class="party-row" id="partyHostFields" style="display:none;">
                <div class="party-field" style="flex:1;">
                    <label for="partyHostNameOnly">Your name</label>
                    <input id="partyHostNameOnly" placeholder="e.g. Emma" autocomplete="name" />
                </div>
                <div class="party-field" style="flex:1;">
                    <label for="partyHostCode">Party code</label>
                    <input id="partyHostCode" placeholder="(generated after create)" readonly />
                </div>
            </div>

            <div class="party-actions">
                <button class="party-btn secondary" id="partyCloseBtn">Close</button>
                <button class="party-btn secondary" id="partyCopyBtn" style="display:none;">Copy link</button>
                <button class="party-btn primary" id="partyJoinBtn" style="display:none;">Join</button>
                <button class="party-btn primary" id="partyCreateBtn" style="display:none;">Create</button>
                <button class="party-btn danger" id="partyEndBtn" style="display:none;">End party</button>
            </div>

            <div class="party-users" id="partyUsers" style="display:none;"></div>
        </div>
    </div>

    <div class="party-status" id="partyStatusPill">
        <i class="bi bi-people-fill"></i>
        <span id="partyStatusText">Not in a party</span>
    </div>

    <!-- Socket.IO client -->
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>

    <script>
        const moviePlayer = document.getElementById('moviePlayer');
        const customControlsOverlay = document.getElementById('customControlsOverlay');
        const playPauseButton = document.getElementById('playPauseButton');
        const playPauseIcon = playPauseButton.querySelector('i');
        const loadingSpinner = playPauseButton.querySelector('.spinner-border');
        const rewindButton = document.getElementById('rewindButton');
        const forwardButton = document.getElementById('forwardButton');
        const progressBarContainer = document.getElementById('progressBarContainer');
        const progressBar = document.getElementById('progressBar');
        const progressBarHandle = document.getElementById('progressBarHandle');
        const timeDisplay = document.getElementById('timeDisplay');
        const backButton = document.getElementById('backButton');
        const videoPlayerWrapper = document.getElementById('videoPlayerWrapper');
        const fullscreenButton = document.getElementById('fullscreenButton');
        const fullscreenIcon = fullscreenButton.querySelector('i');
        const downloadButton = document.getElementById('downloadButton');
        const movieTitleDisplay = document.getElementById('movieTitleDisplay');
        const magnificationButton = document.getElementById('magnificationButton');
        const magnificationIcon = magnificationButton.querySelector('i');
        const castButton = document.getElementById('castButton');
        const volumeButton = document.getElementById('volumeButton');
        const volumeIcon = volumeButton.querySelector('i');
        const volumeSlider = document.getElementById('volumeSlider');

        let zoomLevel = 1;
        let lastVolume = 1;
        let isDraggingProgressBar = false;
        let controlsTimeout;
        const FADE_TIMEOUT_SECONDS = 7;
        let lastTapTime = 0;
        const DOUBLE_TAP_THRESHOLD_MS = 300;
        const SEEK_TIME = 10;
        let movieKey;
        
        // --- CACHE / CONTINUE WATCHING CONSTANTS ---
        const CACHE_KEY = 'thirai_continue_watching';

        function saveToContinueWatching(movie) {
            let history = JSON.parse(localStorage.getItem(CACHE_KEY)) || [];
            // Remove existing entry with same URL to push it to top
            history = history.filter(item => item.url !== movie.url);
            history.unshift(movie);
            // Limit to 20 items
            if (history.length > 20) history.pop();
            localStorage.setItem(CACHE_KEY, JSON.stringify(history));
        }

        function formatTime(seconds) {
            if (isNaN(seconds) || seconds < 0) return "00:00";
            seconds = Math.floor(seconds);
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const remainingSeconds = seconds % 60;
            const pad = (num) => String(num).padStart(2, '0');
            if (hours > 0) {
                return `${pad(hours)}:${pad(minutes)}:${pad(remainingSeconds)}`;
            } else {
                return `${pad(minutes)}:${pad(remainingSeconds)}`;
            }
        }

        function showControls() {
            customControlsOverlay.classList.add('visible');
            clearTimeout(controlsTimeout);
            if (!moviePlayer.paused && !moviePlayer.ended) {
                controlsTimeout = setTimeout(() => {
                    customControlsOverlay.classList.remove('visible');
                }, FADE_TIMEOUT_SECONDS * 1000);
            }
        }

        function hideControls() {
            customControlsOverlay.classList.remove('visible');
            clearTimeout(controlsTimeout);
        }

        function toggleControls() {
            if (customControlsOverlay.classList.contains('visible')) {
                hideControls();
            } else {
                showControls();
            }
        }

        moviePlayer.addEventListener('loadedmetadata', () => {
            if (moviePlayer.paused || moviePlayer.ended || moviePlayer.currentTime === 0) {
                showControls();
            }
            if (moviePlayer.readyState < 3) {
                playPauseIcon.style.display = 'none';
                loadingSpinner.style.display = 'block';
                playPauseButton.disabled = true;
                rewindButton.disabled = true;
                forwardButton.disabled = true;
            }
            // RESUME LOGIC
            if (movieKey) {
                const savedTime = localStorage.getItem(movieKey);
                if (savedTime) {
                    moviePlayer.currentTime = parseFloat(savedTime);
                }
            }
        });

        // CONSTANT RECORDING LOGIC
        moviePlayer.addEventListener('timeupdate', () => {
            updateProgressBar();
            if (movieKey && !moviePlayer.ended && moviePlayer.currentTime > 0) {
                localStorage.setItem(movieKey, moviePlayer.currentTime.toString());
            }
        });

        videoPlayerWrapper.addEventListener('click', (event) => {
            const currentTime = new Date().getTime();
            const clickedOnControl = event.target.closest('.control-button') || 
                                     event.target.closest('.top-button') || 
                                     event.target.closest('.progress-bar-container') || 
                                     event.target.closest('.movie-title-display') ||
                                     event.target.closest('.volume-container');

            if (!clickedOnControl && (currentTime - lastTapTime > DOUBLE_TAP_THRESHOLD_MS)) {
                toggleControls();
            }
        });

        playPauseButton.addEventListener('click', () => {
            if (moviePlayer.paused || moviePlayer.ended) {
                moviePlayer.play();
            } else {
                moviePlayer.pause();
            }
            showControls();
        });

        rewindButton.addEventListener('click', () => {
            if (!rewindButton.disabled) {
                moviePlayer.currentTime = Math.max(0, moviePlayer.currentTime - SEEK_TIME);
                showControls();
            }
        });

        forwardButton.addEventListener('click', () => {
            if (!forwardButton.disabled) {
                moviePlayer.currentTime = Math.min(moviePlayer.duration, moviePlayer.currentTime + SEEK_TIME);
                showControls();
            }
        });

        function updateVolumeIcon(volume) {
            volumeIcon.className = '';
            if (volume === 0 || moviePlayer.muted) {
                volumeIcon.classList.add('bi', 'bi-volume-mute-fill');
            } else if (volume < 0.5) {
                volumeIcon.classList.add('bi', 'bi-volume-down-fill');
            } else {
                volumeIcon.classList.add('bi', 'bi-volume-up-fill');
            }
        }

        volumeSlider.addEventListener('input', (e) => {
            const volume = parseFloat(e.target.value);
            moviePlayer.volume = volume;
            moviePlayer.muted = volume === 0;
            updateVolumeIcon(volume);
            showControls();
        });

        volumeButton.addEventListener('click', () => {
            if (moviePlayer.muted || moviePlayer.volume === 0) {
                moviePlayer.muted = false;
                moviePlayer.volume = lastVolume || 1;
                volumeSlider.value = lastVolume || 1;
            } else {
                lastVolume = moviePlayer.volume;
                moviePlayer.muted = true;
                moviePlayer.volume = 0;
                volumeSlider.value = 0;
            }
            updateVolumeIcon(moviePlayer.volume);
            showControls();
        });

        moviePlayer.addEventListener('waiting', () => {
            playPauseIcon.style.display = 'none';
            loadingSpinner.style.display = 'block';
            playPauseButton.disabled = true;
            rewindButton.disabled = true;
            forwardButton.disabled = true;
            showControls();
        });

        moviePlayer.addEventListener('playing', () => {
            loadingSpinner.style.display = 'none';
            playPauseIcon.style.display = 'block';
            playPauseButton.disabled = false;
            rewindButton.disabled = false;
            forwardButton.disabled = false;
            playPauseIcon.classList.remove('bi-play-fill');
            playPauseIcon.classList.add('bi-pause-fill');
            showControls();
        });

        moviePlayer.addEventListener('canplay', () => {
            if (loadingSpinner.style.display === 'block') {
                loadingSpinner.style.display = 'none';
                playPauseIcon.style.display = 'block';
                playPauseButton.disabled = false;
                rewindButton.disabled = false;
                forwardButton.disabled = false;
            }
            updateProgressBar();
        });

        moviePlayer.addEventListener('play', () => {
            playPauseIcon.classList.remove('bi-play-fill');
            playPauseIcon.classList.add('bi-pause-fill');
            loadingSpinner.style.display = 'none';
            playPauseIcon.style.display = 'block';
            showControls();
        });

        moviePlayer.addEventListener('pause', () => {
            playPauseIcon.classList.remove('bi-pause-fill');
            playPauseIcon.classList.add('bi-play-fill');
            loadingSpinner.style.display = 'none';
            playPauseIcon.style.display = 'block';
            showControls();
        });

        moviePlayer.addEventListener('ended', () => {
            playPauseIcon.classList.remove('bi-pause-fill');
            playPauseIcon.classList.add('bi-play-fill');
            loadingSpinner.style.display = 'none';
            playPauseIcon.style.display = 'block';
            showControls();
            
            if (movieKey) {
                localStorage.removeItem(movieKey);
            }
        });

        function updateProgressBar() {
            if (!isNaN(moviePlayer.duration) && moviePlayer.duration > 0) {
                const progress = (moviePlayer.currentTime / moviePlayer.duration) * 100;
                progressBar.style.width = `${progress}%`;
                progressBarHandle.style.left = `${progress}%`;
            }
            timeDisplay.textContent = `${formatTime(moviePlayer.currentTime)} / ${formatTime(moviePlayer.duration)}`;
        }

        progressBarContainer.addEventListener('mousedown', (e) => {
            if (moviePlayer.readyState >= 2) {
                isDraggingProgressBar = true;
                progressBarContainer.classList.add('dragging');
                updateSeek(e);
                showControls();
            }
        });

        progressBarContainer.addEventListener('touchstart', (e) => {
            if (moviePlayer.readyState >= 2) {
                isDraggingProgressBar = true;
                progressBarContainer.classList.add('dragging');
                updateSeek(e.touches[0]);
                showControls();
            }
        });

        document.addEventListener('mousemove', (e) => {
            if (isDraggingProgressBar) {
                updateSeek(e);
            }
        });

        document.addEventListener('touchmove', (e) => {
            if (isDraggingProgressBar) {
                updateSeek(e.touches[0]);
            }
        });

        document.addEventListener('mouseup', () => {
            if (isDraggingProgressBar) {
                isDraggingProgressBar = false;
                progressBarContainer.classList.remove('dragging');
                showControls();
            }
        });

        document.addEventListener('touchend', () => {
            if (isDraggingProgressBar) {
                isDraggingProgressBar = false;
                progressBarContainer.classList.remove('dragging');
                showControls();
            }
        });

        function updateSeek(e) {
            const rect = progressBarContainer.getBoundingClientRect();
            let clientX = e.clientX || e.pageX;
            clientX = Math.max(rect.left, Math.min(clientX, rect.right));
            const clickX = clientX - rect.left;
            const percent = clickX / rect.width;
            if (!isNaN(moviePlayer.duration)) {
                moviePlayer.currentTime = moviePlayer.duration * percent;
            }
            updateProgressBar();
        }

        backButton.addEventListener('click', () => {
            window.history.back();
        });

        fullscreenButton.addEventListener('click', () => {
            if (document.fullscreenElement) {
                document.exitFullscreen();
            } else {
                if (videoPlayerWrapper.requestFullscreen) {
                    videoPlayerWrapper.requestFullscreen();
                } else if (videoPlayerWrapper.webkitRequestFullscreen) {
                    videoPlayerWrapper.webkitRequestFullscreen();
                } else if (videoPlayerWrapper.msRequestFullscreen) {
                    videoPlayerWrapper.msRequestFullscreen();
                }
            }
            showControls();
        });

        document.addEventListener('fullscreenchange', () => {
            if (document.fullscreenElement) {
                fullscreenIcon.classList.remove('bi-arrows-fullscreen');
                fullscreenIcon.classList.add('bi-arrows-angle-contract');
                if (!moviePlayer.paused) {
                    hideControls();
                }
            } else {
                fullscreenIcon.classList.remove('bi-arrows-angle-contract');
                fullscreenIcon.classList.add('bi-arrows-fullscreen');
                showControls();
            }
        });

        magnificationButton.addEventListener('click', () => {
            switch (zoomLevel) {
                case 1:
                    moviePlayer.style.transform = 'scale(0.9)';
                    magnificationIcon.classList.remove('bi-zoom-in', 'bi-search');
                    magnificationIcon.classList.add('bi-zoom-out');
                    zoomLevel = 0;
                    break;
                case 0:
                    moviePlayer.style.transform = 'scale(1.2)';
                    magnificationIcon.classList.remove('bi-zoom-out');
                    magnificationIcon.classList.add('bi-search');
                    zoomLevel = 2;
                    break;
                case 2:
                    moviePlayer.style.transform = 'scale(1)';
                    magnificationIcon.classList.remove('bi-search');
                    magnificationIcon.classList.add('bi-zoom-in');
                    zoomLevel = 1;
                    break;
            }
            showControls();
        });

        if (window.WebKitPlaybackTargetAvailabilityEvent) {
            moviePlayer.addEventListener('webkitplaybacktargetavailabilitychanged', function(event) {
                switch (event.availability) {
                    case "available":
                        castButton.style.display = 'flex';
                        castButton.onclick = function() {
                            moviePlayer.webkitShowPlaybackTargetPicker();
                        };
                        break;
                    case "not-available":
                        if (!window.chrome || !window.chrome.cast || !window.chrome.cast.isAvailable) {
                             castButton.style.display = 'none';
                        }
                        break;
                }
            });
        }

        window['__onGCastApiAvailable'] = function(isAvailable) {
            if (isAvailable) {
                cast.framework.CastContext.getInstance().setOptions({
                    receiverApplicationId: chrome.cast.media.DEFAULT_MEDIA_RECEIVER_APP_ID,
                    autoJoinPolicy: chrome.cast.AutoJoinPolicy.ORIGIN_SCOPED
                });
                castButton.style.display = 'flex';
                castButton.addEventListener('click', function() {
                    if (!moviePlayer.webkitShowPlaybackTargetPicker) {
                         cast.framework.CastContext.getInstance().requestSession();
                    }
                });
            }
        };

        document.addEventListener('touchend', (event) => {
            const clickedOnControl = event.target.closest('.control-button') ||
                                     event.target.closest('.top-button') ||
                                     event.target.closest('.progress-bar-container') ||
                                     event.target.closest('.movie-title-display') ||
                                     event.target.closest('.volume-container');

            if (clickedOnControl) return;

            if (moviePlayer.paused || moviePlayer.ended || moviePlayer.readyState < 2) {
                const currentTime = new Date().getTime();
                if (currentTime - lastTapTime > DOUBLE_TAP_THRESHOLD_MS) {
                    toggleControls();
                }
                lastTapTime = currentTime;
                return;
            }

            const currentTime = new Date().getTime();
            const tapX = event.changedTouches[0].clientX;

            if (currentTime - lastTapTime < DOUBLE_TAP_THRESHOLD_MS) {
                const videoWidth = videoPlayerWrapper.offsetWidth;
                if (tapX < videoWidth / 2) {
                    moviePlayer.currentTime = Math.max(0, moviePlayer.currentTime - SEEK_TIME);
                } else {
                    moviePlayer.currentTime = Math.min(moviePlayer.duration, moviePlayer.currentTime + SEEK_TIME);
                }
                lastTapTime = 0;
                showControls();
            } else {
                lastTapTime = currentTime;
                toggleControls();
            }
        });

        document.addEventListener('keydown', (event) => {
            const isInputFocused = document.activeElement && (document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'TEXTAREA');
            if (isInputFocused) return;

            switch (event.key) {
                case ' ': 
                    event.preventDefault();
                    playPauseButton.click();
                    break;
                case 'ArrowLeft':
                    event.preventDefault();
                    rewindButton.click();
                    break;
                case 'ArrowRight':
                    event.preventDefault();
                    forwardButton.click();
                    break;
                case 'f':
                case 'F':
                    event.preventDefault();
                    fullscreenButton.click();
                    break;
                case 'm':
                case 'M':
                    event.preventDefault();
                    volumeButton.click();
                    break;
            }
        });
        
        async function fetchMovieSource() {
            playPauseIcon.style.display = 'none';
            loadingSpinner.style.display = 'block';
            playPauseButton.disabled = true;
            rewindButton.disabled = true;
            forwardButton.disabled = true;

            const urlParams = new URLSearchParams(window.location.search);
            const filmCode = urlParams.get('film');
            let movieUrl = urlParams.get('url');

            if (filmCode) {
                movieUrl = `https://einthusan.tv/movie/watch/${filmCode}/`;
            }
            
            if (movieUrl) {
                try {
                    const response = await fetch(`https://api.thirai.me/watch?url=${encodeURIComponent(movieUrl)}`);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const data = await response.json();
                    
                    if (data && data.video_url) {
                        moviePlayer.src = data.video_url;
                        moviePlayer.load();
                        downloadButton.href = data.video_url;
                        downloadButton.style.display = 'flex';
                        movieTitleDisplay.textContent = data.title;
                        document.title = data.title;
                        
                        // --- UPDATED: SAVE ORIGINAL URL TO CACHE ---
                        const currentUrl = `./watch${ORIGINAL_SEARCH_PARAMS}`;
                        const cacheObj = {
                            title: data.title,
                            img: data.img_url || 'https://via.placeholder.com/400x600?text=No+Image', 
                            url: currentUrl
                        };
                        saveToContinueWatching(cacheObj);
                        // ---------------------------------------------
                        
                        movieKey = `movie_progress_${data.title}`;
                        
                        const savedTime = localStorage.getItem(movieKey);
                        if (savedTime) {
                            moviePlayer.currentTime = parseFloat(savedTime);
                        }
                        updateProgressBar();

                    } else {
                        loadingSpinner.style.display = 'none';
                        playPauseIcon.style.display = 'block';
                    }
                } catch (error) {
                    loadingSpinner.style.display = 'none';
                    playPauseIcon.style.display = 'block';
                }
            } else {
                loadingSpinner.style.display = 'none';
                playPauseIcon.style.display = 'block';
            }
        }
        
        document.addEventListener('DOMContentLoaded', fetchMovieSource);
        document.addEventListener('DOMContentLoaded', showControls);

        moviePlayer.addEventListener('canplaythrough', () => {
            if (loadingSpinner.style.display === 'block') {
                loadingSpinner.style.display = 'none';
                playPauseIcon.style.display = 'block';
                playPauseButton.disabled = false;
                rewindButton.disabled = false;
                forwardButton.disabled = false;
            }
        });
    </script>

    <script>
        // ---------------- WATCH PARTY (Socket.IO) ----------------
        (function () {
            const SOCKET_SERVER_URL = 'http://localhost:3000'; // backend hosted on localhost

            // NOTE: We query DOM elements after DOMContentLoaded so listeners always bind.
            let watchPartyButton, backdrop, closeBtn;
            let modeHostBtn, modeJoinBtn;
            let joinFields;
            let hostFields;

            let joinBtn, createBtn, copyBtn, endBtn;

            let codeInput, nameInput, hostNameInput, hostCodeInput;
            let hint;
            let usersBox;

            let statusPill;
            let statusText;

            let socket = null;
            let roomId = null;
            let isHost = false;
            let lastEmitMs = 0;
            let suppressRemote = false;
            let mode = null; // 'host' | 'join'

            function showStatus(text) {
                statusText.textContent = text;
                statusPill.classList.add('show');
            }

            function hideStatus() {
                statusPill.classList.remove('show');
            }

            function openModal() {
                if (!backdrop) return;
                backdrop.classList.add('show');
                backdrop.setAttribute('aria-hidden', 'false');
            }

            function closeModal() {
                if (!backdrop) return;
                backdrop.classList.remove('show');
                backdrop.setAttribute('aria-hidden', 'true');
            }

            function normalizeCode(v) {
                return (v || '').trim().toUpperCase().replace(/[^A-Z0-9]/g, '').slice(0, 12);
            }

            function makeCode(len = 6) {
                const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
                let out = '';
                for (let i = 0; i < len; i++) out += chars[Math.floor(Math.random() * chars.length)];
                return out;
            }

            function setMode(nextMode) {
                mode = nextMode;

                // Reset UI pieces
                if (joinFields) joinFields.style.display = (mode === 'join') ? 'flex' : 'none';
                if (hostFields) hostFields.style.display = (mode === 'host') ? 'flex' : 'none';

                if (joinBtn) joinBtn.style.display = (mode === 'join') ? 'inline-flex' : 'none';
                if (createBtn) createBtn.style.display = (mode === 'host') ? 'inline-flex' : 'none';

                // Copy link only once you're in a party (roomId set) â€” we'll toggle later too
                if (copyBtn) copyBtn.style.display = roomId ? 'inline-flex' : 'none';

                // End button only if host currently in a party
                if (endBtn) endBtn.style.display = (roomId && isHost) ? 'inline-flex' : 'none';

                // Focus sensible field
                if (mode === 'join') {
                    if (codeInput && !codeInput.value) codeInput.focus();
                    else if (nameInput && !nameInput.value) nameInput.focus();
                } else if (mode === 'host') {
                    if (hostNameInput) hostNameInput.focus();
                }
            }

            function refreshActionButtons() {
                if (copyBtn) copyBtn.style.display = roomId ? 'inline-flex' : 'none';
                if (endBtn) endBtn.style.display = (roomId && isHost) ? 'inline-flex' : 'none';
            }

            function ensureSocket() {
                if (socket) return socket;
                if (typeof io === 'undefined') {
                    alert('Socket.IO client failed to load.');
                    return null;
                }
                socket = io(SOCKET_SERVER_URL, { transports: ['websocket', 'polling'] });

                socket.on('connect', () => {
                    // Connected
                });

                socket.on('error', (msg) => {
                    alert(msg || 'Watch Party error');
                });

                socket.on('room-created', (rid) => {
                    roomId = rid;
                    if (codeInput) if (codeInput) codeInput.value = rid;
                if (hostCodeInput) hostCodeInput.value = rid;
                    if (hostCodeInput) hostCodeInput.value = rid;
                    hint.textContent = `Party created. Share this code: ${rid}`;
                    showStatus(`Party: ${rid} (host)`);
                    usersBox.style.display = 'block';
                    refreshActionButtons();
                });

                socket.on('joined-room', (payload) => {
                    hint.textContent = `Joined party: ${roomId}`;
                    showStatus(`Party: ${roomId}${isHost ? ' (host)' : ''}`);
                    usersBox.style.display = 'block';
                    if (codeInput) codeInput.value = roomId || '';
                    if (hostCodeInput) hostCodeInput.value = roomId || '';
                    refreshActionButtons();

                    // If host provided a direct movie URL, load it for joiners
                    try {
                        const movieUrl = payload && payload.movieUrl;
                        if (movieUrl && moviePlayer && moviePlayer.src !== movieUrl) {
                            moviePlayer.src = movieUrl;
                            moviePlayer.load();
                        }
                    } catch (_) {}
                });

                socket.on('user-list', (users) => {
                    if (!Array.isArray(users)) return;
                    usersBox.innerHTML = users.map(u => `<div class="u">â€¢ ${escapeHtml(u.name || 'Guest')}</div>`).join('');
                });

                socket.on('video-update', (data) => {
                    if (!moviePlayer) return;
                    if (isHost) return; // host ignores remote updates
                    if (!data) return;

                    suppressRemote = true;
                    const t = typeof data.time === 'number' ? data.time : parseFloat(data.time);
                    if (!isNaN(t)) moviePlayer.currentTime = t;

                    const state = data.state;
                    if (state === 'play') {
                        moviePlayer.play().catch((err) => {
                        hint.textContent = 'Autoplay blocked. Press play once to enable syncing.';
                    });
                    } else if (state === 'pause') {
                        moviePlayer.pause();
                    } else if (state === 'seek') {
                        // time already set
                    }
                    setTimeout(() => { suppressRemote = false; }, 200);
                });

                socket.on('party-ended', () => {
                    alert('This watch party has ended.');
                    cleanupPartyState();
                });

                return socket;
            }

            function escapeHtml(str) {
                return String(str).replace(/[&<>"']/g, (m) => ({
                    '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
                }[m]));
            }

            function cleanupPartyState() {
                roomId = null;
                isHost = false;

                if (endBtn) endBtn.style.display = 'none';
                if (copyBtn) copyBtn.style.display = 'none';

                usersBox.style.display = 'none';
                usersBox.innerHTML = '';
                hint.textContent = 'Choose Host or Join to start syncing playback.';
                hideStatus();

                // Reset mode UI
                setMode(null);
                if (joinFields) joinFields.style.display = 'none';
                if (hostFields) hostFields.style.display = 'none';

                // Don't force-disconnect socket; user may re-join quickly
            }

            function requireName(forHost = false) {
                const input = forHost ? hostNameInput : nameInput;
                const n = (input && input.value ? input.value : '').trim();
                if (!n) {
                    if (input) input.focus();
                    alert('Please enter your name.');
                    return null;
                }
                return n;
            }

            function emitSync(state, force = false) {
                if (!socket || !roomId || !isHost || !moviePlayer) return;

                const now = Date.now();

                // Never throttle explicit play/pause/seek; only throttle periodic drift sync
                if (!force) {
                    if (now - lastEmitMs < 1200) return;
                }
                lastEmitMs = now;

                socket.emit('sync-video', {
                    roomId,
                    state,
                    time: moviePlayer.currentTime || 0
                });
            });
            }

            // Host -> broadcast playback events
            function hookVideoSync() {
                if (!moviePlayer) return;

                moviePlayer.addEventListener('play', () => {
                    if (suppressRemote) return;
                    if (isHost) emitSync('play', true);
                });

                moviePlayer.addEventListener('pause', () => {
                    if (suppressRemote) return;
                    if (isHost) emitSync('pause', true);
                });

                moviePlayer.addEventListener('seeked', () => {
                    if (suppressRemote) return;
                    if (isHost) emitSync('seek', true);
                });

                // Optional: periodically sync while playing (keeps late-joiners closer)
                moviePlayer.addEventListener('timeupdate', () => {
                    if (suppressRemote) return;
                    if (!isHost) return;
                    if (moviePlayer.paused) return;
                    emitSync('play', false);
                });
            }

            function createParty() {
                const s = ensureSocket();
                if (!s) return;

                const hostName = (hostNameInput && hostNameInput.value ? hostNameInput.value : '').trim() || 'Host';
                const rid = makeCode(6);
                const urlToSync = (moviePlayer && (moviePlayer.currentSrc || moviePlayer.src)) || '';

                roomId = rid;
                isHost = true;

                s.emit('create-room', {
                    roomId: rid,
                    hostName,
                    movieUrl: urlToSync
                });

                if (codeInput) if (codeInput) codeInput.value = rid;
                if (hostCodeInput) hostCodeInput.value = rid;
                    if (hostCodeInput) hostCodeInput.value = rid;
                endBtn.style.display = 'inline-block';
                usersBox.style.display = 'block';
            }

            function joinParty() {
                const s = ensureSocket();
                if (!s) return;

                const code = normalizeCode(codeInput.value);
                if (!code) {
                    codeInput.focus();
                    alert('Enter a party code.');
                    return;
                }

                const userName = requireName();
                if (!userName) return;

                roomId = code;
                isHost = false;

                s.emit('join-room', { roomId: code, userName });
                showStatus(`Joining: ${code}...`);
            }

            function leaveOrEndParty() {
                if (!socket || !roomId) {
                    cleanupPartyState();
                    return;
                }

                if (isHost) {
                    socket.emit('stop-party', roomId);
                } else {
                    socket.emit('leave-room', { roomId });
                }
                cleanupPartyState();
                closeModal();
            }

            function copyLink() {
                const code = normalizeCode(codeInput.value || roomId);
                if (!code) {
                    alert('No party code to copy yet.');
                    return;
                }
                const url = new URL(window.location.href);
                url.searchParams.set('join', code);

                const n = ((isHost ? (hostNameInput && hostNameInput.value) : (nameInput && nameInput.value)) || '').trim();
                if (n) url.searchParams.set('name', n);
                else url.searchParams.delete('name');

                // keep URL tidy: don't leak any previous join/name combos into history
                const text = url.toString();
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(text).then(() => {
                        hint.textContent = 'Link copied to clipboard.';
                    }).catch(() => {
                        prompt('Copy this link:', text);
                    });
                } else {
                    prompt('Copy this link:', text);
                }
            }

            // UI wiring
            if (watchPartyButton) {
                watchPartyButton.addEventListener('click', () => {
                    openModal();

                    // If already in a party, keep current mode view
                    if (roomId) {
                        setMode(isHost ? 'host' : 'join');
                        refreshActionButtons();
                        return;
                    }

                    // Fresh open: show Host/Join chooser
                    hint.textContent = 'Host a party or join an existing one.';
                    setMode(null);
                });

            if (modeHostBtn) {
                modeHostBtn.addEventListener('click', () => {
                    hint.textContent = 'Host mode: enter your name, then create a party.';
                    setMode('host');
                });
            }
            if (modeJoinBtn) {
                modeJoinBtn.addEventListener('click', () => {
                    hint.textContent = 'Join mode: enter the code and your name, then join.';
                    setMode('join');
                });
            }
            }
            closeBtn.addEventListener('click', closeModal);
            backdrop.addEventListener('click', (e) => { if (e.target === backdrop) closeModal(); });
            joinBtn.addEventListener('click', joinParty);
            createBtn.addEventListener('click', () => {
                const userName = requireName(true); // require host name
                if (!userName) return;
                createParty();
            });
            copyBtn.addEventListener('click', copyLink);
            endBtn.addEventListener('click', leaveOrEndParty);

            codeInput.addEventListener('input', () => {
                codeInput.value = normalizeCode(codeInput.value);
            });

            // Parse URL params: watch.html?join=CODE&name=E
            function autoJoinFromUrl() {
                const p = new URLSearchParams(window.location.search);
                const join = p.get('join');
                const name = p.get('name');

                if (!join) return;

                if (codeInput) codeInput.value = normalizeCode(join);
                setMode('join');

                if (name) {
                    nameInput.value = name;
                    // Auto-join when both are present
                    joinParty();
                    closeModal();
                    refreshActionButtons();
                    return;
                }

                // No name parameter: open modal and require user to type name before joining
                openModal();
                nameInput.focus();
                hint.textContent = `Code auto-filled (${normalizeCode(join)}). Enter your name to join.`;
            }

            document.addEventListener('DOMContentLoaded', () => {
                // Bind modal elements now that the DOM is ready
                watchPartyButton = document.getElementById('watchPartyButton');
                backdrop = document.getElementById('partyModalBackdrop');
                closeBtn = document.getElementById('partyCloseBtn');
                modeHostBtn = document.getElementById('partyModeHostBtn');
                modeJoinBtn = document.getElementById('partyModeJoinBtn');

                joinBtn = document.getElementById('partyJoinBtn');
                createBtn = document.getElementById('partyCreateBtn');
                copyBtn = document.getElementById('partyCopyBtn');
                endBtn = document.getElementById('partyEndBtn');

                codeInput = document.getElementById('partyCodeInput');
                nameInput = document.getElementById('partyNameInput');
                hostNameInput = document.getElementById('partyHostNameOnly');
                hostCodeInput = document.getElementById('partyHostCode');
                hint = document.getElementById('partyHint');

                usersBox = document.getElementById('partyUsers');
                joinFields = document.getElementById('partyJoinFields');
                hostFields = document.getElementById('partyHostFields');
                statusPill = document.getElementById('partyStatusPill');
                statusText = document.getElementById('partyStatusText');

                // Wire UI events
                if (watchPartyButton) watchPartyButton.addEventListener('click', () => openModal());
                if (closeBtn) closeBtn.addEventListener('click', closeModal);
                if (backdrop) backdrop.addEventListener('click', (e) => { if (e.target === backdrop) closeModal(); });
                if (modeHostBtn) modeHostBtn.addEventListener('click', () => setMode('host'));
                if (modeJoinBtn) modeJoinBtn.addEventListener('click', () => setMode('join'));
                if (createBtn) createBtn.addEventListener('click', createParty);
                if (joinBtn) joinBtn.addEventListener('click', joinParty);
                if (copyBtn) copyBtn.addEventListener('click', copyInviteLink);
                if (endBtn) endBtn.addEventListener('click', endParty);

                hookVideoSync();
                setMode(null);
                autoJoinFromUrl();
                // Show pill only once you're in a party
            });
        })();
        // ----------------------------------------------------------
    </script>

</body>
</html>
