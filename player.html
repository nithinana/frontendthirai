<script>
        (function() { 
            // --- CONSTANTS ---
            const CORRECT_PIN = "1451"; 
            const MAX_ATTEMPTS = 5;
            const LOCKOUT_DURATION_MS = 15 * 60 * 1000; 
            const AFK_TIMEOUT_MS = 3000; // 3 seconds for inactivity fade
            const TV_PREFIX = 'tv=';
            const BASE_MOVIE_EMBED_URL = "https://www.vidking.net/embed/movie/";
            const BASE_TV_EMBED_URL = "https://www.vidking.net/embed/tv/";

            // --- DOM ELEMENTS ---
            const unlockScreen = document.getElementById('unlock-screen');
            const playerScreen = document.getElementById('player-screen');
            const inputs = document.querySelectorAll('.code-input');
            const unlockButton = document.getElementById('unlockButton');
            const errorMessage = document.getElementById('error-message');
            const backButton = document.querySelector('.back-button'); 
            const logo = document.getElementById('logo'); 

            let lockoutInterval = null;
            let afkTimer; 
            // NEW: Flag to indicate if fullscreen is active
            let isFullscreenActive = false; 
            
            // =================================================================
            // === 1. USER ACTIVITY HANDLER (Modified) =========================
            // =================================================================

            function hideBackButton() {
                // Only hide if the player is visible AND we are NOT in fullscreen
                if (playerScreen.style.display !== 'none' && !isFullscreenActive) {
                     backButton.classList.add('afk-fade');
                }
            }

            function showBackButton() {
                // Always show the button on activity
                backButton.classList.remove('afk-fade');
                clearTimeout(afkTimer);
                
                // Only start the fade timer if the player is visible AND we are NOT in fullscreen
                if (playerScreen.style.display !== 'none' && !isFullscreenActive) {
                    afkTimer = setTimeout(hideBackButton, AFK_TIMEOUT_MS);
                }
            }
            
            function handleUserActivity() {
                showBackButton();
            }

            // =================================================================
            // === 2. PLAYER EMBED LOGIC (Unchanged) ===========================
            // =================================================================

            function displayPlayerError(message) {
                playerScreen.innerHTML = `<h1>Error: Missing or Invalid Data</h1><p id="player-error">${message}</p>`;
                console.error(message);
            }

            function loadEmbed() {
                const queryString = window.location.search.substring(1);
                let fullEmbedUrl = null;
                let contentType = null;

                if (!queryString) {
                    displayPlayerError('No ID provided in the URL. Please use: `?12345` for a movie or `?tv=12345/1/5` for a TV show.');
                    return;
                }

                if (queryString.startsWith(TV_PREFIX)) {
                    contentType = 'TV Show';
                    const tvDetails = queryString.substring(TV_PREFIX.length); 
                    const parts = tvDetails.split('/'); 

                    if (parts.length === 3 && parts.every(p => p)) {
                        const [id, season, episode] = parts;
                        fullEmbedUrl = `${BASE_TV_EMBED_URL}${id}/${season}/${episode}`;
                    } else {
                        displayPlayerError('Invalid TV show format. Please use: `?tv=**ID/SEASON/EPISODE**`. Example: `?tv=12345/1/5`');
                    }
                } else {
                    contentType = 'Movie';
                    const movieId = queryString; 
                    
                    if (movieId) {
                        fullEmbedUrl = `${BASE_MOVIE_EMBED_URL}${movieId}`;
                    } else {
                        displayPlayerError('Movie ID is missing. Please use: `?**12345**`');
                    }
                }

                if (fullEmbedUrl) {
                    const iframe = document.createElement('iframe');
                    iframe.setAttribute('id', 'movie-iframe');
                    iframe.setAttribute('src', fullEmbedUrl);
                    iframe.setAttribute('allowfullscreen', 'true');
                    iframe.setAttribute('sandbox', 'allow-scripts allow-same-origin allow-forms allow-presentation');
                    
                    playerScreen.innerHTML = '';
                    playerScreen.appendChild(iframe);
                    console.log(`Successfully embedded ${contentType} from URL: ${fullEmbedUrl}`);
                }
            }

            // =================================================================
            // === 3. UNLOCK & DISPLAY MANAGER (Unchanged) =====================
            // =================================================================
            
            function updateLogo(isUnlockScreen) {
                logo.src = isUnlockScreen ? "./static/thiraiwhite.png" : "./static/thiraiwhite.png";
            }

            function showPlayer() {
                unlockScreen.style.display = 'none';
                playerScreen.style.display = 'flex';
                loadEmbed();
                
                showBackButton(); 
                updateLogo(false); 
            }

            function showUnlock() {
                playerScreen.style.display = 'none';
                unlockScreen.style.display = 'flex';
                checkLockoutStatus();
                backButton.classList.remove('afk-fade');
                clearTimeout(afkTimer);
                updateLogo(true); 
            }
            
            function checkInputs() {
                let allFilled = true;
                inputs.forEach(input => {
                    if (input.value.length === 0 || !/^\d$/.test(input.value)) {
                        allFilled = false;
                    }
                });
                const isLocked = isLockedOut();
                unlockButton.disabled = !allFilled || isLocked;
                
                if (allFilled && !isLocked) {
                    errorMessage.style.display = 'none';
                }
            }
            
            function isLockedOut() {
                const lockoutTimestamp = localStorage.getItem('lockoutTimestamp');
                if (lockoutTimestamp) {
                    const now = new Date().getTime();
                    const lockoutEnd = parseInt(lockoutTimestamp) + LOCKOUT_DURATION_MS;
                    
                    if (now < lockoutEnd) {
                        const remainingTimeMs = lockoutEnd - now;
                        const totalSeconds = Math.ceil(remainingTimeMs / 1000);
                        const remainingMinutes = Math.floor(totalSeconds / 60);
                        const remainingSeconds = totalSeconds % 60;

                        errorMessage.textContent = `Too many failed attempts. Try again in ${remainingMinutes}:${remainingSeconds.toString().padStart(2, '0')}.`;
                        errorMessage.style.display = 'block';
                        return true;
                    } else {
                        localStorage.removeItem('lockoutTimestamp');
                        localStorage.setItem('attemptCount', '0');
                        clearInterval(lockoutInterval);
                        lockoutInterval = null;
                        errorMessage.style.display = 'none';
                        return false;
                    }
                }
                return false;
            }
            
            function checkLockoutStatus() {
                if (isLockedOut()) {
                    unlockButton.disabled = true;
                    if (!lockoutInterval) {
                        lockoutInterval = setInterval(checkLockoutStatus, 1000); 
                    }
                } else {
                    if (lockoutInterval) {
                        clearInterval(lockoutInterval);
                        lockoutInterval = null;
                    }
                    checkInputs(); 
                }
            }

            // --- Event Listeners for Unlock Form (Unchanged) ---
            
            inputs.forEach((input, index) => {
                input.addEventListener('keyup', (e) => {
                    if (e.key === 'Backspace' && input.value === '') {
                        if (index > 0) inputs[index - 1].focus();
                    }
                    checkInputs();
                });
                
                input.addEventListener('input', () => {
                    let value = input.value.replace(/[^0-9]/g, '').charAt(0);
                    input.value = value;
                    
                    if (input.value.length === 1 && index < inputs.length - 1) {
                        inputs[index + 1].focus();
                    } else if (index === inputs.length - 1) {
                         unlockButton.focus(); 
                    }
                    checkInputs();
                });
                
                input.addEventListener('paste', (e) => {
                    e.preventDefault();
                    const pasteCode = (e.clipboardData || window.clipboardData).getData('text').trim().replace(/[^0-9]/g, '').slice(0, 4);

                    for (let i = 0; i < pasteCode.length; i++) {
                        if (inputs[i]) inputs[i].value = pasteCode[i];
                    }

                    const lastFilledIndex = pasteCode.length > 0 ? pasteCode.length - 1 : 0;
                    if (inputs[lastFilledIndex + 1]) {
                        inputs[lastFilledIndex + 1].focus();
                    } else if (inputs[lastFilledIndex]) {
                        inputs[lastFilledIndex].blur();
                    }
                    checkInputs();
                });
            });

            unlockButton.addEventListener('click', () => {
                if (isLockedOut()) return;
                
                let enteredPin = Array.from(inputs).map(input => input.value).join('');

                if (enteredPin === CORRECT_PIN) {
                    // --- SUCCESS ---
                    localStorage.setItem('isUnlocked', 'true'); 
                    localStorage.setItem('premium_isUnlocked', 'true'); 
                    localStorage.setItem('attemptCount', '0');
                    localStorage.removeItem('lockoutTimestamp');
                    
                    showPlayer();
                } else {
                    // --- FAILURE ---
                    let currentAttempts = parseInt(localStorage.getItem('attemptCount') || '0');
                    currentAttempts++;
                    localStorage.setItem('attemptCount', currentAttempts.toString());
                    
                    if (currentAttempts >= MAX_ATTEMPTS) {
                        localStorage.setItem('lockoutTimestamp', new Date().getTime().toString());
                        errorMessage.textContent = `Maximum attempts reached (${MAX_ATTEMPTS}). Access locked.`;
                        checkLockoutStatus(); 
                    } else {
                        const remaining = MAX_ATTEMPTS - currentAttempts;
                        errorMessage.textContent = `Incorrect PIN. ${remaining} attempts remaining.`;
                        errorMessage.style.display = 'block';
                    }
                    
                    inputs.forEach(input => input.value = '');
                    inputs[0].focus();
                    unlockButton.disabled = true;
                }
            });
            
            // =================================================================
            // === 4. FULLSCREEN HANDLER (NEW) =================================
            // =================================================================

            function handleFullscreenChange() {
                // Check if any element in the document is currently in fullscreen mode
                const isCurrentlyFullscreen = !!document.fullscreenElement; 
                
                if (isCurrentlyFullscreen) {
                    // Entered fullscreen: Stop AFK fade and ensure button is visible
                    isFullscreenActive = true;
                    clearTimeout(afkTimer);
                    backButton.classList.remove('afk-fade');
                } else {
                    // Exited fullscreen: Resume AFK fade logic
                    isFullscreenActive = false;
                    handleUserActivity(); // Restart the AFK timer
                }
            }

            // =================================================================
            // === 5. INITIALIZATION & AFK SETUP (Modified) ====================
            // =================================================================

            document.addEventListener('DOMContentLoaded', () => {
                const isUnlocked = localStorage.getItem('isUnlocked');
                
                if (isUnlocked === 'true') {
                    showPlayer();
                } else {
                    showUnlock();
                }

                // Setup the global event listeners for AFK check
                document.addEventListener('mousemove', handleUserActivity);
                document.addEventListener('keypress', handleUserActivity);
                document.addEventListener('click', handleUserActivity);
                
                // NEW: Listen for fullscreen change events
                document.addEventListener('fullscreenchange', handleFullscreenChange);
            });
        })();
    </script>
