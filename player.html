<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Thirai - Video Player</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"/>
    
    <style>
        /* Base Styles for the entire page */
        body, html {
            margin: 0;
            padding: 0;
            overflow: hidden; 
            height: 100%;
            width: 100%;
            font-family: Arial, sans-serif;
            transition: background-color 0.5s ease, color 0.5s ease;
        }

        /* --- Global Styles: PERMANENT DARK MODE --- */

        body {
            background-color: #121212; /* Dark mode background */
            color: #e0e0e0; /* Dark mode text color */
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        /* --- BACK BUTTON STYLES (MATCHED DARK MODE) --- */
        .back-button {
            position: fixed;
            top: 20px;
            left: 20px;
            font-size: 24px;
            text-decoration: none;
            cursor: pointer;
            z-index: 1000; /* Ensure it's on top of everything */
            color: #ffffff; /* White icon for dark background */
            display: inline-flex; /* Use flex to align icon/text if needed */
            align-items: center;
            justify-content: center;
            transition: opacity 0.5s ease; /* Transition for AFK fade */
        }

        .back-button:hover {
            opacity: 0.7;
        }

        .back-button.afk-fade {
            opacity: 0;
            pointer-events: none; /* Make it unclickable when invisible */
        }
        
        /* --- UNLOCK SCREEN STYLES --- */
        
        #unlock-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            width: 100%;
            padding: 20px;
            box-sizing: border-box;
        }

        #unlock-screen h1 {
            color: #ffffff; 
            margin-bottom: 30px;
        }
        
        #logo-container {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
        }

        #logo {
            width: 150px; 
            height: auto;
        }

        .code-inputs {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
        }

        .code-input {
            width: 50px;
            height: 70px;
            font-size: 32px;
            text-align: center;
            border: 2px solid #555;
            border-radius: 8px;
            background-color: #222;
            color: #ffffff;
            caret-color: #ffffff; /* Make cursor white */
            outline: none;
            transition: border-color 0.3s ease;
        }

        .code-input:focus {
            border-color: #007bff; /* Highlight focus with a primary color */
            box-shadow: 0 0 10px rgba(0, 123, 255, 0.5);
        }

        #unlockButton {
            padding: 12px 30px;
            font-size: 18px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s, opacity 0.3s;
        }

        #unlockButton:hover:not(:disabled) {
            background-color: #0056b3;
        }

        #unlockButton:disabled {
            background-color: #555;
            cursor: not-allowed;
            opacity: 0.6;
        }

        #error-message {
            color: #dc3545;
            margin-top: 15px;
            font-size: 16px;
            display: none;
            text-align: center;
        }
        
        /* --- PLAYER SCREEN STYLES --- */

        #player-screen {
            display: none; /* Hidden by default, shown after unlock */
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #000000; /* Black background for player */
            justify-content: center;
            align-items: center;
        }

        #movie-iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        #player-error {
            color: #dc3545;
            text-align: center;
        }
    </style>
</head>
<body>

    <a href="#" class="back-button" id="backButton">
        <i class="bi bi-arrow-left"></i>
    </a>

    <div id="logo-container">
        <img id="logo" src="./static/thiraiwhite.png" alt="Thirai Logo">
    </div>

    <div id="unlock-screen">
        <h1>Enter PIN to Access Player</h1>
        
        <div class="code-inputs">
            <input type="password" maxlength="1" class="code-input" data-index="0" inputmode="numeric">
            <input type="password" maxlength="1" class="code-input" data-index="1" inputmode="numeric">
            <input type="password" maxlength="1" class="code-input" data-index="2" inputmode="numeric">
            <input type="password" maxlength="1" class="code-input" data-index="3" inputmode="numeric">
        </div>
        
        <button id="unlockButton" disabled>Unlock Player</button>
        
        <p id="error-message"></p>
    </div>

    <div id="player-screen">
        </div>

    <script>
        (function() { 
            // --- CONSTANTS ---
            const CORRECT_PIN = "1451"; 
            const MAX_ATTEMPTS = 5;
            const LOCKOUT_DURATION_MS = 15 * 60 * 1000; 
            const AFK_TIMEOUT_MS = 3000; // 3 seconds for inactivity fade
            const TV_PREFIX = 'tv=';
            const BASE_MOVIE_EMBED_URL = "https://www.vidking.net/embed/movie/";
            const BASE_TV_EMBED_URL = "https://www.vidking.net/embed/tv/";

            // --- DOM ELEMENTS ---
            const unlockScreen = document.getElementById('unlock-screen');
            const playerScreen = document.getElementById('player-screen');
            const inputs = document.querySelectorAll('.code-input');
            const unlockButton = document.getElementById('unlockButton');
            const errorMessage = document.getElementById('error-message');
            const backButton = document.getElementById('backButton'); // Changed to use ID
            const logo = document.getElementById('logo'); 

            let lockoutInterval = null;
            let afkTimer; 
            
            // =================================================================
            // === 1. USER ACTIVITY HANDLER & FULLSCREEN CHECK (Updated) =======
            // =================================================================

            /**
             * Checks if the document is currently in fullscreen mode.
             * @returns {boolean} True if in fullscreen, false otherwise.
             */
            function isDocumentInFullscreen() {
                // Check for standard and vendor-prefixed fullscreen elements
                return document.fullscreenElement || 
                       document.webkitFullscreenElement || 
                       document.mozFullScreenElement || 
                       document.msFullscreenElement;
            }

            /** Hides the back button by adding the AFK fade class. */
            function hideBackButton() {
                // Only hide if the player screen is visible AND we are NOT in fullscreen
                if (playerScreen.style.display !== 'none' && !isDocumentInFullscreen()) {
                     backButton.classList.add('afk-fade');
                }
            }

            /** Shows the back button and resets the AFK timer. */
            function showBackButton() {
                // Only show/manage timer if the player screen is visible AND we are NOT in fullscreen
                if (playerScreen.style.display !== 'none' && !isDocumentInFullscreen()) {
                    backButton.style.display = 'inline-flex'; // Ensure visibility style is correct
                    backButton.classList.remove('afk-fade');
                    clearTimeout(afkTimer);
                    afkTimer = setTimeout(hideBackButton, AFK_TIMEOUT_MS);
                }
            }
            
            /** Handles mouse/key activity to show controls. */
            function handleUserActivity() {
                showBackButton();
            }

            // =================================================================
            // === 2. PLAYER EMBED LOGIC (Unchanged) ===========================
            // =================================================================

            function displayPlayerError(message) {
                playerScreen.innerHTML = `<h1>Error: Missing or Invalid Data</h1><p id="player-error">${message}</p>`;
                console.error(message);
            }

            function loadEmbed() {
                const queryString = window.location.search.substring(1);
                let fullEmbedUrl = null;
                let contentType = null;

                if (!queryString) {
                    displayPlayerError('No ID provided in the URL. Please use: `?12345` for a movie or `?tv=12345/1/5` for a TV show.');
                    return;
                }

                if (queryString.startsWith(TV_PREFIX)) {
                    contentType = 'TV Show';
                    const tvDetails = queryString.substring(TV_PREFIX.length); 
                    const parts = tvDetails.split('/'); 

                    if (parts.length === 3 && parts.every(p => p)) {
                        const [id, season, episode] = parts;
                        fullEmbedUrl = `${BASE_TV_EMBED_URL}${id}/${season}/${episode}`;
                    } else {
                        displayPlayerError('Invalid TV show format. Please use: `?tv=**ID/SEASON/EPISODE**`. Example: `?tv=12345/1/5`');
                    }
                } else {
                    contentType = 'Movie';
                    const movieId = queryString; 
                    
                    if (movieId) {
                        fullEmbedUrl = `${BASE_MOVIE_EMBED_URL}${movieId}`;
                    } else {
                        displayPlayerError('Movie ID is missing. Please use: `?**12345**`');
                    }
                }

                if (fullEmbedUrl) {
                    const iframe = document.createElement('iframe');
                    iframe.setAttribute('id', 'movie-iframe');
                    iframe.setAttribute('src', fullEmbedUrl);
                    // Crucial for allowing fullscreen to be triggered from inside the iframe
                    iframe.setAttribute('allowfullscreen', 'true');
                    iframe.setAttribute('sandbox', 'allow-scripts allow-same-origin allow-forms allow-presentation');
                    
                    playerScreen.innerHTML = '';
                    playerScreen.appendChild(iframe);
                    console.log(`Successfully embedded ${contentType} from URL: ${fullEmbedUrl}`);
                }
            }

            // =================================================================
            // === 3. UNLOCK & DISPLAY MANAGER (Unchanged) =====================
            // =================================================================
            
            function updateLogo(isUnlockScreen) {
                logo.src = "./static/thiraiwhite.png";
            }

            function showPlayer() {
                unlockScreen.style.display = 'none';
                playerScreen.style.display = 'flex';
                loadEmbed();
                
                // Show the back button and start the AFK timer
                backButton.style.display = 'inline-flex';
                showBackButton(); 
                updateLogo(false); // Player screen
            }

            function showUnlock() {
                playerScreen.style.display = 'none';
                unlockScreen.style.display = 'flex';
                checkLockoutStatus();
                
                // Ensure the back button is visible on the unlock screen (no AFK fade)
                backButton.style.display = 'inline-flex';
                backButton.classList.remove('afk-fade');
                clearTimeout(afkTimer);
                updateLogo(true); // Unlock screen
            }
            
            function checkInputs() {
                let allFilled = true;
                inputs.forEach(input => {
                    if (input.value.length === 0 || !/^\d$/.test(input.value)) {
                        allFilled = false;
                    }
                });
                const isLocked = isLockedOut();
                unlockButton.disabled = !allFilled || isLocked;
                
                if (allFilled && !isLocked) {
                    errorMessage.style.display = 'none';
                }
            }
            
            function isLockedOut() {
                const lockoutTimestamp = localStorage.getItem('lockoutTimestamp');
                if (lockoutTimestamp) {
                    const now = new Date().getTime();
                    const lockoutEnd = parseInt(lockoutTimestamp) + LOCKOUT_DURATION_MS;
                    
                    if (now < lockoutEnd) {
                        const remainingTimeMs = lockoutEnd - now;
                        const totalSeconds = Math.ceil(remainingTimeMs / 1000);
                        const remainingMinutes = Math.floor(totalSeconds / 60);
                        const remainingSeconds = totalSeconds % 60;

                        errorMessage.textContent = `Too many failed attempts. Try again in ${remainingMinutes}:${remainingSeconds.toString().padStart(2, '0')}.`;
                        errorMessage.style.display = 'block';
                        return true;
                    } else {
                        localStorage.removeItem('lockoutTimestamp');
                        localStorage.setItem('attemptCount', '0');
                        clearInterval(lockoutInterval);
                        lockoutInterval = null;
                        errorMessage.style.display = 'none';
                        return false;
                    }
                }
                return false;
            }
            
            function checkLockoutStatus() {
                if (isLockedOut()) {
                    unlockButton.disabled = true;
                    if (!lockoutInterval) {
                        lockoutInterval = setInterval(checkLockoutStatus, 1000); 
                    }
                } else {
                    if (lockoutInterval) {
                        clearInterval(lockoutInterval);
                        lockoutInterval = null;
                    }
                    checkInputs(); 
                }
            }

            // --- Event Listeners for Unlock Form (Unchanged) ---
            
            inputs.forEach((input, index) => {
                input.addEventListener('keyup', (e) => {
                    if (e.key === 'Backspace' && input.value === '') {
                        if (index > 0) inputs[index - 1].focus();
                    }
                    checkInputs();
                });
                
                input.addEventListener('input', () => {
                    let value = input.value.replace(/[^0-9]/g, '').charAt(0);
                    input.value = value;
                    
                    if (input.value.length === 1 && index < inputs.length - 1) {
                        inputs[index + 1].focus();
                    } else if (index === inputs.length - 1) {
                         unlockButton.focus(); 
                    }
                    checkInputs();
                });
                
                input.addEventListener('paste', (e) => {
                    e.preventDefault();
                    const pasteCode = (e.clipboardData || window.clipboardData).getData('text').trim().replace(/[^0-9]/g, '').slice(0, 4);

                    for (let i = 0; i < pasteCode.length; i++) {
                        if (inputs[i]) inputs[i].value = pasteCode[i];
                    }

                    const lastFilledIndex = pasteCode.length > 0 ? pasteCode.length - 1 : 0;
                    if (inputs[lastFilledIndex + 1]) {
                        inputs[lastFilledIndex + 1].focus();
                    } else if (inputs[lastFilledIndex]) {
                        inputs[lastFilledIndex].blur();
                    }
                    checkInputs();
                });
            });

            unlockButton.addEventListener('click', () => {
                if (isLockedOut()) return;
                
                let enteredPin = Array.from(inputs).map(input => input.value).join('');

                if (enteredPin === CORRECT_PIN) {
                    // --- SUCCESS ---
                    localStorage.setItem('isUnlocked', 'true'); 
                    localStorage.setItem('attemptCount', '0');
                    localStorage.removeItem('lockoutTimestamp');
                    
                    showPlayer();
                } else {
                    // --- FAILURE ---
                    let currentAttempts = parseInt(localStorage.getItem('attemptCount') || '0');
                    currentAttempts++;
                    localStorage.setItem('attemptCount', currentAttempts.toString());
                    
                    if (currentAttempts >= MAX_ATTEMPTS) {
                        localStorage.setItem('lockoutTimestamp', new Date().getTime().toString());
                        errorMessage.textContent = `Maximum attempts reached (${MAX_ATTEMPTS}). Access locked.`;
                        checkLockoutStatus(); 
                    } else {
                        const remaining = MAX_ATTEMPTS - currentAttempts;
                        errorMessage.textContent = `Incorrect PIN. ${remaining} attempts remaining.`;
                        errorMessage.style.display = 'block';
                    }
                    
                    inputs.forEach(input => input.value = '');
                    inputs[0].focus();
                    unlockButton.disabled = true;
                }
            });
            
            // =================================================================
            // === 4. INITIALIZATION & AFK SETUP (Updated for Fullscreen) ======
            // =================================================================

            /**
             * Handler for the global fullscreenchange event.
             * Hides the back button when entering fullscreen, shows it when exiting.
             */
            function handleFullscreenChange() {
                if (isDocumentInFullscreen()) {
                    // Hide the back button when entering fullscreen
                    backButton.style.display = 'none';
                    clearTimeout(afkTimer); // Stop AFK timer in fullscreen
                } else {
                    // Show the back button when exiting fullscreen
                    backButton.style.display = 'inline-flex';
                    // Restart the AFK timer only if the player screen is currently active
                    if (playerScreen.style.display !== 'none') {
                        showBackButton(); 
                    }
                }
            }

            document.addEventListener('DOMContentLoaded', () => {
                // Initial check for unlock status
                const isUnlocked = localStorage.getItem('isUnlocked');
                
                if (isUnlocked === 'true') {
                    showPlayer();
                } else {
                    showUnlock();
                }

                // Setup the global event listeners for AFK check
                document.addEventListener('mousemove', handleUserActivity);
                document.addEventListener('keypress', handleUserActivity);
                document.addEventListener('click', handleUserActivity);

                // Add event listener for fullscreen changes (with vendor prefixes for better compatibility)
                document.addEventListener('fullscreenchange', handleFullscreenChange);
                document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
                document.addEventListener('mozfullscreenchange', handleFullscreenChange);
                document.addEventListener('MSFullscreenChange', handleFullscreenChange);
                
                // Add click listener for the back button (if you want it to go back)
                backButton.addEventListener('click', (e) => {
                    e.preventDefault();
                    // Example: Navigate back one page in history
                    window.history.back(); 
                });
            });
        })();
    </script>
</body>
</html>
