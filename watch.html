<!DOCTYPE html>
<html lang="en">
<head>

    <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-HKV7GQ766F"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-HKV7GQ766F');
</script>

<!-- Script to automatically shorten the 'url' parameter to 'film' and remove 'title' -->
<script>
    (function() {
        try {
            const urlParams = new URLSearchParams(window.location.search);
            const movieUrl = urlParams.get('url');
            let needsRewrite = false;

            // Check if the 'url' parameter exists and we need to shorten it
            if (movieUrl) {
                needsRewrite = true;
                // Use a regular expression to find the movie code after '/watch/'
                const movieCodeMatch = movieUrl.match(/\/watch\/([a-zA-Z0-9]+)/);

                if (movieCodeMatch && movieCodeMatch[1]) {
                    const movieCode = movieCodeMatch[1];
                    // Set the new 'film' parameter
                    urlParams.set('film', movieCode);
                    // Remove the old 'url' parameter
                    urlParams.delete('url');
                }
            }
            
            // Check if the 'title' parameter exists and remove it
            if (urlParams.has('title')) {
                needsRewrite = true;
                urlParams.delete('title');
            }

            if(needsRewrite) {
                // Reconstruct the full URL for the address bar
                const newUrl = `${window.location.pathname}?${urlParams.toString()}`;

                // Replace the URL in the browser's history without reloading the page
                window.history.replaceState({ path: newUrl }, '', newUrl);
                console.log('URL has been rewritten.');
            }

        } catch (error) {
            // Log any errors to the console without interrupting the user
            console.error('Error rewriting URL:', error);
        }
    })();
</script>



    <meta name="screen-orientation" content="landscape">
    <link rel="manifest" href="/manifest.json">

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Thirai">

<link rel="apple-touch-icon" href="/static/ios/icon-192x192.png">
<link rel="apple-touch-icon" sizes="152x152" href="/static/ios/icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="/static/ios/icon-180x180.png">
<link rel="apple-touch-icon" sizes="167x167" href="/static/ios/icon-167x167.png">

<link rel="apple-touch-startup-image" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2)" href="/static/splash/launch-750x1334.png">
<link rel="apple-touch-startup-image" media="(device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3)" href="/static/splash/launch-1242x2208.png">
<link rel="apple-touch-startup-image" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3)" href="/static/splash/launch-1125x2436.png">
<link rel="apple-touch-startup-image" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2)" href="/static/splash/launch-828x1792.png">
<link rel="apple-touch-startup-image" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3)" href="/static/splash/launch-1242x2688.png">
<link rel="apple-touch-startup-image" media="(device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3)" href="/static/splash/launch-1080x2340.png">
<link rel="apple-touch-startup-image" media="(device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3)" href="/static/splash/launch-1170x2532.png">
<link rel="apple-touch-startup-image" media="(device-width: 428px) and (device-height: 926px) and (-webkit-device-pixel-ratio: 3)" href="/static/splash/launch-1284x2778.png">

    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Thirai</title>
    <link rel="icon" type="image/png" href="/static/favicon.png"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"/>
    <style>
        /* Base styles to make the player full screen */
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden; /* Prevent scrolling */
            background-color: black; /* Solid black background for video player */
            font-family: 'Inter', sans-serif; /* Use Inter font */
            -webkit-user-select: none; /* Disable text selection on touch devices */
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        /* Main video wrapper to contain video and controls */
        .video-player-wrapper {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: black; /* Ensures no background shows through */
        }

        /* Styles for the video element itself */
        #moviePlayer {
            /* Initial state: slightly zoomed out */
            transform: scale(1); /* Default is now middle zoom */
            transform-origin: center center;
            transition: transform 0.3s ease-in-out; /* Smooth transition for zoom */
            position: relative; /* Ensure position is relative for transform */
            width: 100%; /* Ensure video takes up 100% of its wrapper */
            height: 100%;
            object-fit: contain; /* Video scales to fit, letterboxing if needed */
            display: block;
            /* Hide native controls */
            controls: none;
        }

        .video-player-wrapper video {
            /* These styles are mostly redundant now that #moviePlayer has its own styles */
            width: 100%;
            height: 100%;
            object-fit: cover; /* Video fills the entire screen, cropping if necessary */
            display: block;
            /* Hide native controls */
            controls: none;
        }

        /* Hide default video controls (for various browsers) */
        video::-webkit-media-controls { display: none !important; }
        video::-webkit-media-controls-enclosure { display: none !important; }
        video::-moz-range-track { background: transparent; } /* For Firefox */
        video::-moz-range-thumb { background: transparent; } /* For Firefox */

        /* Custom controls container */
        .custom-controls-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: space-between; /* Push elements to top/bottom */
            align-items: center;
            background: rgba(0, 0, 0, 0.4); /* Semi-transparent overlay for controls */
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 10; /* Ensure controls are above video */
            pointer-events: none; /* Allow clicks to pass through by default */
        }

        .custom-controls-overlay.visible {
            opacity: 1;
            pointer-events: auto; /* Enable clicks when visible */
        }

        /* Top control bar (back, download, title) */
        .top-controls {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center; /* Vertically center items */
            padding: 1.5rem 1.5rem 1rem; /* Adjusted padding: reduced bottom padding to move seekbar up */
            box-sizing: border-box;
        }

        /* Movie Title Styling */
        .movie-title-display {
            color: white;
            font-size: 1.2rem;
            font-weight: bold;
            text-align: center;
            flex-grow: 1; /* Allows it to take available space */
            margin: 0 1rem; /* Add some horizontal margin */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            /* Added to ensure vertical alignment with buttons */
            line-height: 1; /* Adjust line height to match button icon size */
            display: flex; /* Use flex to center text vertically within its container */
            align-items: center; /* Vertically center the text */
            justify-content: center; /* Horizontally center the text */
            height: 1.5rem; /* Match the font-size of the icons for better alignment */
        }

        /* Center control bar (play/pause, skip) */
        .center-controls {
            display: flex;
            align-items: center;
            gap: 2rem; /* Space between central buttons */
        }

        /* Bottom control bar (progress bar) */
        .bottom-controls {
            width: 100%;
            padding: 1rem 1.5rem 2rem; /* Adjusted padding: reduced top padding to move seekbar up */
            box-sizing: border-box;
            display: flex;
            flex-direction: row; /* Arranges items in a row */
            align-items: center; /* Vertically centers items */
            justify-content: center; /* Centers the whole row horizontally */
            gap: 1rem; /* Space between time display and progress bar */
        }

        /* Styling for control buttons */
        .control-button {
            background: rgba(255, 255, 255, 0.2); /* Slightly visible background */
            border: none;
            color: white;
            font-size: 2.2rem; /* Larger icon size for mobile */
            cursor: pointer;
            padding: 0.8rem;
            border-radius: 50%; /* Circular buttons */
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s ease, transform 0.1s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3); /* Subtle shadow */
            -webkit-tap-highlight-color: transparent; /* Remove tap highlight on mobile */
        }

        .control-button:hover:not(:disabled) {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }

        .control-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            box-shadow: none;
        }

        /* Specific size for the play/pause button */
        #playPauseButton {
            font-size: 3.5rem; /* Even larger for main button */
            padding: 1.2rem;
        }

        /* Progress bar styling */
        .progress-bar-container {
            flex-grow: 1; /* Allows progress bar to take available space */
            height: 8px;
            background-color: rgba(255, 255, 255, 0.3);
            border-radius: 10px; /* Increased curve */
            cursor: grab; /* Indicates draggable */
            position: relative;
            margin: 0 1rem; /* Decreased length by adding horizontal margin */
        }

        .progress-bar {
            height: 100%;
            width: 0%;
            background-color: #0d6efd; /* Primary blue for progress */
            border-radius: 10px; /* Increased curve */
            transition: width 0.1s linear;
        }

        .progress-bar-handle {
            position: absolute;
            top: 50%;
            left: 0%;
            transform: translate(-50%, -50%);
            width: 20px; /* Larger handle for mobile touch */
            height: 20px;
            background-color: white;
            border-radius: 50%;
            display: none; /* Hidden by default */
            box-shadow: 0 0 8px rgba(0,0,0,0.6);
            transition: transform 0.1s ease;
        }
        .progress-bar-container:hover .progress-bar-handle,
        .progress-bar-container.dragging .progress-bar-handle {
            display: block;
            transform: translate(-50%, -50%) scale(1.1); /* Slightly larger on hover/drag */
        }

        /* Time display */
        .time-display {
            color: white;
            font-size: 1rem;
            white-space: nowrap;
            order: 2; /* Ensure time display is after progress bar if order changes */
        }
        .progress-bar-container {
            order: 1; /* Ensure progress bar is before time display */
        }

        /* Loading Spinner */
        .spinner-border {
            width: 2rem;
            height: 2rem;
            color: white;
            border-width: 0.25em;
            vertical-align: middle;
            border-radius: 50%;
            animation: spinner-border .75s linear infinite;
            border-right-color: transparent; /* Makes it a spinning arc */
            display: inline-block; /* Required for the animation to show properly */
        }
        @keyframes spinner-border {
            to { transform: rotate(360deg); }
        }

        /* Back and Download buttons styling */
        .top-button {
            background: transparent; /* Made transparent */
            border: none;
            color: white;
            font-size: 1.5rem;
            padding: 0.7rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center; /* Center icon when no text */
            gap: 0.5rem;
            -webkit-tap-highlight-color: transparent;
        }
        .top-button:hover {
            background: rgba(255, 255, 255, 0.1); /* Subtle hover effect */
        }
        .top-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Hidden visually, but accessible for screen readers */
        .visually-hidden {
            position: absolute;
            width: 1px;
            height: 1px;
            margin: -1px;
            padding: 0;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            border: 0;
        }

        /* Custom styles for fullscreen button */
        #fullscreenButton {
            background: transparent; /* Make transparent */
            box-shadow: none; /* Remove shadow */
            padding: 0.5rem; /* Adjust padding for better fit */
            font-size: 1.8rem; /* Smaller icon size for the bottom bar */
        }

        #fullscreenButton:hover:not(:disabled) {
            background: rgba(255, 255, 255, 0.1); /* Subtle hover for transparent button */
            transform: scale(1.1); /* Slightly enlarge on hover */
        }

        /* --- NEW: Share Modal Styles --- */
        .share-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000; /* Ensure it's on top of everything */
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        .share-modal-overlay.visible {
            opacity: 1;
            pointer-events: auto;
        }

        .share-modal-content {
            background: #2c2c2e; /* Dark theme background */
            color: white;
            padding: 2rem;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.5);
            position: relative;
            text-align: center;
            font-family: 'Inter', sans-serif;
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }

        .share-modal-overlay.visible .share-modal-content {
            transform: scale(1);
        }

        .close-share-modal {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            color: #aaa;
            font-size: 2rem;
            cursor: pointer;
            line-height: 1;
            transition: color 0.2s ease;
        }

        .close-share-modal:hover {
            color: white;
        }

        .share-modal-content h2 {
            margin-top: 0;
            margin-bottom: 1.5rem;
            font-weight: 600;
            border-bottom: 1px solid #444;
            padding-bottom: 1rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .share-section {
            margin-bottom: 1.5rem;
        }
        .share-section:last-child {
             margin-bottom: 0;
        }

        .share-section label {
            display: block;
            margin-bottom: 0.5rem;
            color: #ccc;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            text-align: left;
        }

        .code-box {
            background: #1c1c1e;
            padding: 0.8rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.2s ease;
            border: 1px solid #444;
        }

        .code-box:hover {
            background: #3a3a3c;
        }

        #channelCode {
            font-family: 'Courier New', Courier, monospace;
            font-size: 1.2rem;
            font-weight: bold;
            letter-spacing: 1px;
        }
        
        .share-url-text {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            text-align: left;
            flex-grow: 1;
            padding-right: 10px;
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
            color: #ddd;
        }

        .code-box i {
            transition: color 0.3s ease;
        }
        .code-box i.copied {
            color: #28a745; /* Green checkmark */
        }


        #qrCodeContainer {
            background: white;
            padding: 10px;
            border-radius: 8px;
            display: inline-block;
            margin-bottom: 1rem;
            line-height: 0; /* Fix extra space below image */
        }

        #qrCodeContainer img {
            display: block;
            width: 150px;
            height: 150px;
        }

        .copy-notification {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 0.9rem;
            z-index: 2000;
            opacity: 0;
            transition: opacity 0.3s ease, bottom 0.3s ease;
            pointer-events: none;
        }

        .copy-notification.show {
            opacity: 1;
            bottom: 30px;
        }
        /* --- END NEW --- */
    </style>
</head>
<body>
    <div class="video-player-wrapper" id="videoPlayerWrapper">
        <video id="moviePlayer" playsinline webkit-playsinline preload="auto" autoplay>
            </video>

        <div class="custom-controls-overlay" id="customControlsOverlay">
            <div class="top-controls">
                <button id="backButton" class="top-button">
                    <i class="bi bi-arrow-left"></i>
                </button>
                <div class="movie-title-display" id="movieTitleDisplay">Thirai</div>
                <a href="#" id="downloadButton" download="Thirai.mp4" class="top-button">
                    <i class="bi bi-download"></i>
                </a>
                <!-- NEW: SHARE BUTTON ADDED -->
                <button id="shareButton" class="top-button">
                    <i class="bi bi-share"></i>
                </button>
                <button id="magnificationButton" class="top-button">
                    <i class="bi bi-zoom-in"></i>
                </button>
            </div>

            <div class="center-controls">
                <button id="rewindButton" class="control-button">
                    <i class="bi bi-arrow-counterclockwise"></i>
                </button>
                <button id="playPauseButton" class="control-button">
                    <i class="bi bi-play-fill"></i>
                    <div class="spinner-border" role="status" style="display: none;">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </button>
                <button id="forwardButton" class="control-button">
                    <i class="bi bi-arrow-clockwise"></i>
                </button>
            </div>

            <div class="bottom-controls">
                <div class="progress-bar-container" id="progressBarContainer">
                    <div class="progress-bar" id="progressBar"></div>
                    <div class="progress-bar-handle" id="progressBarHandle"></div>
                </div>
                <span class="time-display" id="timeDisplay">00:00 / 00:00</span>
                <button id="fullscreenButton" class="control-button">
                    <i class="bi bi-arrows-fullscreen"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- NEW: SHARE MODAL HTML (UPDATED) -->
    <div id="shareModal" class="share-modal-overlay">
        <div class="share-modal-content">
            <button id="closeShareModal" class="close-share-modal">&times;</button>
            <h2 id="shareModalTitle">Share</h2>
            <div class="share-section">
                <div id="qrCodeContainer"></div>
            </div>
            <div class="share-section">
                <label for="channelCodeBox">Channel Code</label>
                <div id="channelCodeBox" class="code-box" title="Click to copy">
                    <span id="channelCode"></span>
                    <i class="bi bi-clipboard"></i>
                </div>
            </div>
            <div class="share-section">
                 <label for="copyLinkBox">Share Link</label>
                <div id="copyLinkBox" class="code-box" title="Click to copy">
                    <span id="shareUrl" class="share-url-text"></span>
                    <i id="copyLinkIcon" class="bi bi-link-45deg"></i>
                </div>
            </div>
        </div>
    </div>
    <div id="copyNotification" class="copy-notification">Copied to clipboard!</div>
    <!-- END NEW -->


    <script>
        const moviePlayer = document.getElementById('moviePlayer');
        const customControlsOverlay = document.getElementById('customControlsOverlay');
        const playPauseButton = document.getElementById('playPauseButton');
        const playPauseIcon = playPauseButton.querySelector('i');
        const loadingSpinner = playPauseButton.querySelector('.spinner-border');
        const rewindButton = document.getElementById('rewindButton');
        const forwardButton = document.getElementById('forwardButton');
        const progressBarContainer = document.getElementById('progressBarContainer');
        const progressBar = document.getElementById('progressBar');
        const progressBarHandle = document.getElementById('progressBarHandle');
        const timeDisplay = document.getElementById('timeDisplay');
        const backButton = document.getElementById('backButton');
        const videoPlayerWrapper = document.getElementById('videoPlayerWrapper');
        const fullscreenButton = document.getElementById('fullscreenButton');
        const fullscreenIcon = fullscreenButton.querySelector('i');
        const downloadButton = document.getElementById('downloadButton');
        const movieTitleDisplay = document.getElementById('movieTitleDisplay');

        // --- Magnification Elements ---
        const magnificationButton = document.getElementById('magnificationButton');
        const magnificationIcon = magnificationButton.querySelector('i');
        let zoomLevel = 1; // 0: Smaller, 1: Default, 2: Larger

        // --- NEW: Share Modal Elements (UPDATED) ---
        const shareButton = document.getElementById('shareButton');
        const shareModal = document.getElementById('shareModal');
        const closeShareModal = document.getElementById('closeShareModal');
        const shareModalTitle = document.getElementById('shareModalTitle');
        const channelCodeBox = document.getElementById('channelCodeBox');
        const channelCodeSpan = document.getElementById('channelCode');
        const channelCodeIcon = channelCodeBox.querySelector('i');
        const qrCodeContainer = document.getElementById('qrCodeContainer');
        const copyNotification = document.getElementById('copyNotification');
        const copyLinkBox = document.getElementById('copyLinkBox');
        const shareUrlSpan = document.getElementById('shareUrl');
        const copyLinkIcon = document.getElementById('copyLinkIcon');
        // --- END NEW ---

        let isDraggingProgressBar = false;
        let controlsTimeout;
        const FADE_TIMEOUT_SECONDS = 7;
        let lastTapTime = 0;
        const DOUBLE_TAP_THRESHOLD_MS = 300;
        const SEEK_TIME = 10;
        
        let movieKey;

        function formatTime(seconds) {
            if (isNaN(seconds) || seconds < 0) return "00:00";
            seconds = Math.floor(seconds);
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const remainingSeconds = seconds % 60;
            const pad = (num) => String(num).padStart(2, '0');
            if (hours > 0) {
                return `${pad(hours)}:${pad(minutes)}:${pad(remainingSeconds)}`;
            } else {
                return `${pad(minutes)}:${pad(remainingSeconds)}`;
            }
        }

        function showControls() {
            customControlsOverlay.classList.add('visible');
            clearTimeout(controlsTimeout);
            if (!moviePlayer.paused && !moviePlayer.ended) {
                controlsTimeout = setTimeout(() => {
                    customControlsOverlay.classList.remove('visible');
                }, FADE_TIMEOUT_SECONDS * 1000);
            }
        }

        function hideControls() {
            customControlsOverlay.classList.remove('visible');
            clearTimeout(controlsTimeout);
        }

        function toggleControls() {
            if (customControlsOverlay.classList.contains('visible')) {
                hideControls();
            } else {
                showControls();
            }
        }

        moviePlayer.addEventListener('loadedmetadata', () => {
            if (moviePlayer.paused || moviePlayer.ended || moviePlayer.currentTime === 0) {
                showControls();
            }
            if (moviePlayer.readyState < 3) { // HTMLMediaElement.HAVE_FUTURE_DATA
                playPauseIcon.style.display = 'none';
                loadingSpinner.style.display = 'block';
                playPauseButton.disabled = true;
                rewindButton.disabled = true;
                forwardButton.disabled = true;
            }
        });

        videoPlayerWrapper.addEventListener('click', (event) => {
            const currentTime = new Date().getTime();
            const clickedOnControl = event.target.closest('.control-button') || event.target.closest('.top-button') || event.target.closest('.progress-bar-container') || event.target.closest('.movie-title-display');

            if (!clickedOnControl && (currentTime - lastTapTime > DOUBLE_TAP_THRESHOLD_MS)) {
                toggleControls();
            }
        });

        playPauseButton.addEventListener('click', () => {
            if (moviePlayer.paused || moviePlayer.ended) {
                moviePlayer.play();
            } else {
                moviePlayer.pause();
            }
            showControls(); // Ensure controls stay visible or timer resets
        });

        rewindButton.addEventListener('click', () => {
            if (!rewindButton.disabled) {
                moviePlayer.currentTime = Math.max(0, moviePlayer.currentTime - SEEK_TIME);
                showControls(); // Ensure controls stay visible or timer resets
            }
        });

        forwardButton.addEventListener('click', () => {
            if (!forwardButton.disabled) {
                moviePlayer.currentTime = Math.min(moviePlayer.duration, moviePlayer.currentTime + SEEK_TIME);
                showControls(); // Ensure controls stay visible or timer resets
            }
        });

        // --- Loading/Buffering Logic ---
        moviePlayer.addEventListener('waiting', () => {
            playPauseIcon.style.display = 'none';
            loadingSpinner.style.display = 'block';
            playPauseButton.disabled = true;
            rewindButton.disabled = true;
            forwardButton.disabled = true;
            showControls();
        });

        moviePlayer.addEventListener('playing', () => {
            loadingSpinner.style.display = 'none';
            playPauseIcon.style.display = 'block';
            playPauseButton.disabled = false;
            rewindButton.disabled = false;
            forwardButton.disabled = false;
            playPauseIcon.classList.remove('bi-play-fill');
            playPauseIcon.classList.add('bi-pause-fill');
            showControls();
        });

        moviePlayer.addEventListener('canplay', () => {
            if (loadingSpinner.style.display === 'block') {
                loadingSpinner.style.display = 'none';
                playPauseIcon.style.display = 'block';
                playPauseButton.disabled = false;
                rewindButton.disabled = false;
                forwardButton.disabled = false;
            }
            updateProgressBar();
        });

        moviePlayer.addEventListener('play', () => {
            playPauseIcon.classList.remove('bi-play-fill');
            playPauseIcon.classList.add('bi-pause-fill');
            loadingSpinner.style.display = 'none';
            playPauseIcon.style.display = 'block';
            showControls();
        });

        moviePlayer.addEventListener('pause', () => {
            playPauseIcon.classList.remove('bi-pause-fill');
            playPauseIcon.classList.add('bi-play-fill');
            loadingSpinner.style.display = 'none';
            playPauseIcon.style.display = 'block';
            showControls();
        });

        moviePlayer.addEventListener('ended', () => {
            playPauseIcon.classList.remove('bi-pause-fill');
            playPauseIcon.classList.add('bi-play-fill');
            loadingSpinner.style.display = 'none';
            playPauseIcon.style.display = 'block';
            showControls();
            
            if (movieKey) {
                localStorage.removeItem(movieKey);
                console.log(`Video ended, cleared progress for ${movieKey}.`);
            }
        });

        function updateProgressBar() {
            if (!isNaN(moviePlayer.duration) && moviePlayer.duration > 0) {
                const progress = (moviePlayer.currentTime / moviePlayer.duration) * 100;
                progressBar.style.width = `${progress}%`;
                progressBarHandle.style.left = `${progress}%`;
            }
            timeDisplay.textContent = `${formatTime(moviePlayer.currentTime)} / ${formatTime(moviePlayer.duration)}`;
        }

        moviePlayer.addEventListener('timeupdate', updateProgressBar);
        moviePlayer.addEventListener('loadedmetadata', updateProgressBar);

        progressBarContainer.addEventListener('mousedown', (e) => {
            if (moviePlayer.readyState >= 2) {
                isDraggingProgressBar = true;
                progressBarContainer.classList.add('dragging');
                updateSeek(e);
                showControls();
            }
        });

        progressBarContainer.addEventListener('touchstart', (e) => {
            if (moviePlayer.readyState >= 2) {
                isDraggingProgressBar = true;
                progressBarContainer.classList.add('dragging');
                updateSeek(e.touches[0]);
                showControls();
            }
        });

        document.addEventListener('mousemove', (e) => {
            if (isDraggingProgressBar) {
                updateSeek(e);
            }
        });

        document.addEventListener('touchmove', (e) => {
            if (isDraggingProgressBar) {
                updateSeek(e.touches[0]);
            }
        });

        document.addEventListener('mouseup', () => {
            if (isDraggingProgressBar) {
                isDraggingProgressBar = false;
                progressBarContainer.classList.remove('dragging');
                showControls();
            }
        });

        document.addEventListener('touchend', () => {
            if (isDraggingProgressBar) {
                isDraggingProgressBar = false;
                progressBarContainer.classList.remove('dragging');
                showControls();
            }
        });

        function updateSeek(e) {
            const rect = progressBarContainer.getBoundingClientRect();
            let clientX = e.clientX || e.pageX;
            clientX = Math.max(rect.left, Math.min(clientX, rect.right));
            const clickX = clientX - rect.left;
            const percent = clickX / rect.width;
            if (!isNaN(moviePlayer.duration)) {
                moviePlayer.currentTime = moviePlayer.duration * percent;
            }
            updateProgressBar();
        }

        backButton.addEventListener('click', () => {
            window.history.back();
        });

        // --- Fullscreen Logic ---
        fullscreenButton.addEventListener('click', () => {
            if (document.fullscreenElement) {
                document.exitFullscreen();
            } else {
                if (videoPlayerWrapper.requestFullscreen) {
                    videoPlayerWrapper.requestFullscreen();
                } else if (videoPlayerWrapper.webkitRequestFullscreen) { /* Safari */
                    videoPlayerWrapper.webkitRequestFullscreen();
                } else if (videoPlayerWrapper.msRequestFullscreen) { /* IE11 */
                    videoPlayerWrapper.msRequestFullscreen();
                }
            }
            showControls();
        });

        document.addEventListener('fullscreenchange', () => {
            if (document.fullscreenElement) {
                fullscreenIcon.classList.remove('bi-arrows-fullscreen');
                fullscreenIcon.classList.add('bi-arrows-angle-contract');
                if (!moviePlayer.paused) {
                    hideControls();
                }
            } else {
                fullscreenIcon.classList.remove('bi-arrows-angle-contract');
                fullscreenIcon.classList.add('bi-arrows-fullscreen');
                showControls();
            }
        });

        document.addEventListener('webkitfullscreenchange', () => { // For Safari
            if (document.webkitFullscreenElement) {
                fullscreenIcon.classList.remove('bi-arrows-fullscreen');
                fullscreenIcon.classList.add('bi-arrows-angle-contract');
                if (!moviePlayer.paused) {
                    hideControls();
                }
            } else {
                fullscreenIcon.classList.remove('bi-arrows-angle-contract');
                fullscreenIcon.classList.add('bi-arrows-fullscreen');
                showControls();
            }
        });

        // --- Magnification Button Event Listener ---
        magnificationButton.addEventListener('click', () => {
            switch (zoomLevel) {
                case 1:
                    // Zoom out (smaller)
                    moviePlayer.style.transform = 'scale(0.9)';
                    magnificationIcon.classList.remove('bi-zoom-in', 'bi-search');
                    magnificationIcon.classList.add('bi-zoom-out');
                    zoomLevel = 0;
                    break;
                case 0:
                    // Zoom in (larger)
                    moviePlayer.style.transform = 'scale(1.2)';
                    magnificationIcon.classList.remove('bi-zoom-out');
                    magnificationIcon.classList.add('bi-search');
                    zoomLevel = 2;
                    break;
                case 2:
                    // Return to default (normal)
                    moviePlayer.style.transform = 'scale(1)';
                    magnificationIcon.classList.remove('bi-search');
                    magnificationIcon.classList.add('bi-zoom-in');
                    zoomLevel = 1;
                    break;
            }
            showControls(); // Keep controls visible or reset timer after zoom
        });

        // --- Mobile Tap Functionality Refined ---
        document.addEventListener('touchend', (event) => {
            const clickedOnControl = event.target.closest('.control-button') ||
                                     event.target.closest('.top-button') ||
                                     event.target.closest('.progress-bar-container') ||
                                     event.target.closest('.movie-title-display');

            if (clickedOnControl) {
                // If a control was tapped, prevent the main video wrapper tap logic from executing.
                return;
            }

            // Handle taps that are NOT on a control (i.e., taps on the video itself)
            if (moviePlayer.paused || moviePlayer.ended || moviePlayer.readyState < 2) {
                const currentTime = new Date().getTime();
                if (currentTime - lastTapTime > DOUBLE_TAP_THRESHOLD_MS) {
                    toggleControls();
                }
                lastTapTime = currentTime;
                return;
            }

            // Logic for double-tap seeking on playing video
            const currentTime = new Date().getTime();
            const tapX = event.changedTouches[0].clientX;

            if (currentTime - lastTapTime < DOUBLE_TAP_THRESHOLD_MS) {
                const videoWidth = videoPlayerWrapper.offsetWidth;
                if (tapX < videoWidth / 2) {
                    moviePlayer.currentTime = Math.max(0, moviePlayer.currentTime - SEEK_TIME);
                } else {
                    moviePlayer.currentTime = Math.min(moviePlayer.duration, moviePlayer.currentTime + SEEK_TIME);
                }
                lastTapTime = 0; // Reset lastTapTime after double tap
                showControls(); // Show controls after seeking
            } else {
                // Single tap on video area to toggle controls
                lastTapTime = currentTime;
                toggleControls();
            }
        });

        // --- Keyboard Functionality ---
        document.addEventListener('keydown', (event) => {
            const isInputFocused = document.activeElement && (document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'TEXTAREA');
            const isModalOpen = shareModal.classList.contains('visible');

            if (isInputFocused || isModalOpen) {
                if (isModalOpen && event.key === 'Escape') {
                    closeTheModal();
                }
                return;
            }

            switch (event.key) {
                case ' ': // Spacebar
                    event.preventDefault(); // Prevent page scrolling
                    playPauseButton.click();
                    break;
                case 'ArrowLeft': // Left Arrow key
                    event.preventDefault();
                    rewindButton.click();
                    break;
                case 'ArrowRight': // Right Arrow key
                    event.preventDefault();
                    forwardButton.click();
                    break;
                case 'f':
                case 'F': // 'f' or 'F' key for fullscreen
                    event.preventDefault();
                    fullscreenButton.click();
                    break;
            }
        });
        
        // --- Video Fetch Logic ---
        async function fetchMovieSource() {
            // Display loading state
            playPauseIcon.style.display = 'none';
            loadingSpinner.style.display = 'block';
            playPauseButton.disabled = true;
            rewindButton.disabled = true;
            forwardButton.disabled = true;

            const urlParams = new URLSearchParams(window.location.search);
            const filmCode = urlParams.get('film');
            let movieUrl = urlParams.get('url'); // Keep for fallback

            // Prioritize the new 'film' parameter
            if (filmCode) {
                movieUrl = `https://einthusan.tv/movie/watch/${filmCode}/`;
                console.log(`Reconstructed movie URL from film code: ${movieUrl}`);
            }
            
            if (movieUrl) {
                try {
                    const response = await fetch(`https://thirai-watch.onrender.com/watch?url=${encodeURIComponent(movieUrl)}`);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const data = await response.json();
                    
                    if (data && data.video_url) {
                        moviePlayer.src = data.video_url;
                        moviePlayer.load();
                        downloadButton.href = data.video_url;
                        movieTitleDisplay.textContent = data.title;
                        document.title = data.title;
                        console.log(`Successfully fetched video source: ${data.video_url}`);
                        
                        movieKey = `movie_progress_${data.title}`;
                        
                        const savedTime = localStorage.getItem(movieKey);
                        if (savedTime && moviePlayer.duration > 0 && parseFloat(savedTime) > 0 && parseFloat(savedTime) < moviePlayer.duration) {
                            moviePlayer.currentTime = parseFloat(savedTime);
                            console.log(`Resuming ${data.title} at ${formatTime(parseFloat(savedTime))}.`);
                        }
                        updateProgressBar();

                    } else {
                        console.error('API response is missing the video URL.');
                        loadingSpinner.style.display = 'none';
                        playPauseIcon.style.display = 'block';
                    }
                } catch (error) {
                    console.error('Failed to fetch movie source:', error);
                    loadingSpinner.style.display = 'none';
                    playPauseIcon.style.display = 'block';
                }
            } else {
                console.error('No movie URL or film code provided in the query parameter.');
                loadingSpinner.style.display = 'none';
                playPauseIcon.style.display = 'block';
            }
        }
        
        // --- Save Progress Logic ---
        document.addEventListener('DOMContentLoaded', fetchMovieSource);
        
        let saveInterval;
        moviePlayer.addEventListener('play', () => {
            clearInterval(saveInterval);
            saveInterval = setInterval(() => {
                if (movieKey) {
                    localStorage.setItem(movieKey, moviePlayer.currentTime.toString());
                }
            }, 5000);
        });

        moviePlayer.addEventListener('pause', () => {
            clearInterval(saveInterval);
            if (movieKey) {
                localStorage.setItem(movieKey, moviePlayer.currentTime.toString());
            }
        });

        window.addEventListener('beforeunload', () => {
            if (!moviePlayer.ended && moviePlayer.currentTime > 0) {
                if (movieKey) {
                    localStorage.setItem(movieKey, moviePlayer.currentTime.toString());
                    console.log(`Saved progress on unload for ${movieKey}: ${moviePlayer.currentTime}s`);
                }
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            showControls();
        });

        moviePlayer.addEventListener('play', () => {
            showControls();
        });

        moviePlayer.addEventListener('canplaythrough', () => {
            if (loadingSpinner.style.display === 'block') {
                loadingSpinner.style.display = 'none';
                playPauseIcon.style.display = 'block';
                playPauseButton.disabled = false;
                rewindButton.disabled = false;
                forwardButton.disabled = false;
            }
        });

        // --- NEW: Share Modal Logic (UPDATED) ---

        // Function to show a temporary notification
        function showCopyNotification() {
            copyNotification.classList.add('show');
            setTimeout(() => {
                copyNotification.classList.remove('show');
            }, 2000);
        }

        // Open Share Modal
        shareButton.addEventListener('click', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const filmCode = urlParams.get('film');

            if (filmCode) {
                // Set content
                shareModalTitle.textContent = movieTitleDisplay.textContent;
                channelCodeSpan.textContent = filmCode;
                const currentUrl = window.location.href;
                shareUrlSpan.textContent = currentUrl;
                
                // Generate QR Code
                const qrCodeUrl = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(currentUrl)}&qzone=1&bgcolor=ffffff`;
                qrCodeContainer.innerHTML = `<img src="${qrCodeUrl}" alt="QR Code for link">`;

                // Show modal
                shareModal.style.display = 'flex';
                setTimeout(() => shareModal.classList.add('visible'), 10);
            } else {
                alert('Channel Code not found in URL.');
            }
            showControls(); // Keep controls visible
        });

        // Function to close the modal
        function closeTheModal() {
            shareModal.classList.remove('visible');
            setTimeout(() => {
                shareModal.style.display = 'none';
            }, 300); // Wait for transition to finish
        }
        
        // Add close listeners
        closeShareModal.addEventListener('click', closeTheModal);
        
        shareModal.addEventListener('click', (event) => {
            if (event.target === shareModal) {
                closeTheModal();
            }
        });

        // Copy Channel Code to clipboard
        channelCodeBox.addEventListener('click', () => {
            const code = channelCodeSpan.textContent;
            navigator.clipboard.writeText(code).then(() => {
                showCopyNotification();
                channelCodeIcon.classList.remove('bi-clipboard');
                channelCodeIcon.classList.add('bi-check-lg', 'copied');
                setTimeout(() => {
                    channelCodeIcon.classList.remove('bi-check-lg', 'copied');
                    channelCodeIcon.classList.add('bi-clipboard');
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy channel code: ', err);
            });
        });

        // Copy full link to clipboard
        copyLinkBox.addEventListener('click', () => {
            const url = shareUrlSpan.textContent;
            navigator.clipboard.writeText(url).then(() => {
                showCopyNotification();
                copyLinkIcon.classList.remove('bi-link-45deg');
                copyLinkIcon.classList.add('bi-check-lg', 'copied');
                setTimeout(() => {
                    copyLinkIcon.classList.remove('bi-check-lg', 'copied');
                    copyLinkIcon.classList.add('bi-link-45deg');
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy link: ', err);
            });
        });
        // --- END NEW ---

    </script>
</body>
</html>
