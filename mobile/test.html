<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Thirai TV</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"/>
    <style>
        html, body {
            margin: 0; padding: 0; width: 100%; height: 100%;
            overflow: hidden; background-color: black;
            font-family: 'Inter', sans-serif;
            -webkit-user-select: none; user-select: none;
        }

        /* TV Focus Highlights */
        :focus {
            outline: 6px solid #0d6efd !important;
            outline-offset: 4px;
            background: rgba(13, 110, 253, 0.5) !important;
            transform: scale(1.15);
            z-index: 20;
        }

        .video-player-wrapper {
            position: relative; width: 100%; height: 100%;
            display: flex; justify-content: center; align-items: center;
            background-color: black;
        }

        #moviePlayer {
            width: 100%; height: 100%;
            object-fit: contain;
            transition: transform 0.3s ease;
        }

        .custom-controls-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column;
            justify-content: space-between;
            background: linear-gradient(to top, rgba(0,0,0,0.9) 0%, transparent 30%, transparent 70%, rgba(0,0,0,0.9) 100%);
            opacity: 0; transition: opacity 0.4s ease;
            z-index: 10; pointer-events: none;
        }

        .custom-controls-overlay.visible {
            opacity: 1; pointer-events: auto;
        }

        /* Enlarged UI for TV viewing distances */
        .top-controls, .bottom-controls {
            padding: 40px 60px;
            display: flex; align-items: center; gap: 30px;
        }

        .movie-title-display {
            color: white; font-size: 2.5rem; font-weight: bold;
            flex-grow: 1; text-align: center;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        }

        .center-controls {
            display: flex; justify-content: center; align-items: center; gap: 60px;
        }

        .control-button, .top-button {
            background: rgba(255, 255, 255, 0.15);
            border: none; color: white;
            padding: 20px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 3rem; cursor: pointer;
            transition: all 0.2s ease;
        }

        #playPauseButton {
            width: 120px; height: 120px; font-size: 5rem;
        }

        .progress-bar-container {
            flex-grow: 1; height: 15px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px; position: relative;
        }

        .progress-bar {
            height: 100%; background-color: #0d6efd;
            border-radius: 10px; width: 0%;
        }

        .time-display {
            color: white; font-size: 1.8rem; font-weight: 500;
            min-width: 220px; text-align: right;
        }

        .spinner-border {
            width: 4rem; height: 4rem;
            border: 0.4em solid white; border-right-color: transparent;
            border-radius: 50%; animation: spin .75s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="video-player-wrapper" id="videoPlayerWrapper">
        <video id="moviePlayer" playsinline preload="auto" autoplay></video>

        <div class="custom-controls-overlay" id="customControlsOverlay">
            <div class="top-controls">
                <button id="backButton" class="top-button"><i class="bi bi-arrow-left"></i></button>
                <div class="movie-title-display" id="movieTitleDisplay">Thirai</div>
                <button id="magnificationButton" class="top-button"><i class="bi bi-zoom-in"></i></button>
            </div>

            <div class="center-controls">
                <button id="rewindButton" class="control-button"><i class="bi bi-arrow-counterclockwise"></i></button>
                <button id="playPauseButton" class="control-button">
                    <i class="bi bi-play-fill" id="playPauseIcon"></i>
                    <div class="spinner-border" id="loadingSpinner" style="display: none;"></div>
                </button>
                <button id="forwardButton" class="control-button"><i class="bi bi-arrow-clockwise"></i></button>
            </div>

            <div class="bottom-controls">
                <div class="progress-bar-container" id="progressBarContainer" tabindex="0">
                    <div class="progress-bar" id="progressBar"></div>
                </div>
                <span class="time-display" id="timeDisplay">00:00 / 00:00</span>
                <button id="volumeButton" class="top-button"><i class="bi bi-volume-up-fill"></i></button>
                <button id="fullscreenButton" class="top-button"><i class="bi bi-arrows-fullscreen"></i></button>
            </div>
        </div>
    </div>

    <script>
        const moviePlayer = document.getElementById('moviePlayer');
        const overlay = document.getElementById('customControlsOverlay');
        const playPauseBtn = document.getElementById('playPauseButton');
        const playPauseIcon = document.getElementById('playPauseIcon');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const movieTitleDisplay = document.getElementById('movieTitleDisplay');
        const progressBar = document.getElementById('progressBar');
        const timeDisplay = document.getElementById('timeDisplay');

        let controlsTimeout;
        let zoomLevel = 1;
        let movieKey;

        // --- TV SPATIAL NAVIGATION ---
        const navRows = [
            ['backButton', 'magnificationButton'],
            ['rewindButton', 'playPauseButton', 'forwardButton'],
            ['progressBarContainer', 'volumeButton', 'fullscreenButton']
        ];
        let currentRow = 1;
        let currentCol = 1;

        function updateFocus() {
            const id = navRows[currentRow][currentCol];
            const el = document.getElementById(id);
            if (el) {
                el.focus();
                showControls();
            }
        }

        document.addEventListener('keydown', (e) => {
            showControls();
            switch(e.key) {
                case 'ArrowUp':
                    if (currentRow > 0) {
                        currentRow--;
                        currentCol = Math.min(currentCol, navRows[currentRow].length - 1);
                    }
                    break;
                case 'ArrowDown':
                    if (currentRow < navRows.length - 1) {
                        currentRow++;
                        currentCol = Math.min(currentCol, navRows[currentRow].length - 1);
                    }
                    break;
                case 'ArrowLeft':
                    if (document.activeElement.id === 'progressBarContainer') {
                        moviePlayer.currentTime -= 30;
                    } else if (currentCol > 0) {
                        currentCol--;
                    }
                    break;
                case 'ArrowRight':
                    if (document.activeElement.id === 'progressBarContainer') {
                        moviePlayer.currentTime += 30;
                    } else if (currentCol < navRows[currentRow].length - 1) {
                        currentCol++;
                    }
                    break;
                case 'Enter':
                    // Default behavior handles click on focused element
                    break;
                case 'Escape':
                case 'Backspace':
                case 'GoBack':
                    if (overlay.classList.contains('visible')) {
                        hideControls();
                    } else {
                        window.history.back();
                    }
                    break;
            }
            updateFocus();
        });

        // --- CORE PLAYER LOGIC ---
        function showControls() {
            overlay.classList.add('visible');
            clearTimeout(controlsTimeout);
            if (!moviePlayer.paused) {
                controlsTimeout = setTimeout(hideControls, 7000);
            }
        }

        function hideControls() {
            overlay.classList.remove('visible');
            if (document.activeElement) document.activeElement.blur();
        }

        function formatTime(seconds) {
            if (isNaN(seconds)) return "00:00";
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = Math.floor(seconds % 60);
            const pad = (n) => String(n).padStart(2, '0');
            return h > 0 ? `${pad(h)}:${pad(m)}:${pad(s)}` : `${pad(m)}:${pad(s)}`;
        }

        // --- EVENT LISTENERS ---
        playPauseBtn.addEventListener('click', () => {
            moviePlayer.paused ? moviePlayer.play() : moviePlayer.pause();
        });

        document.getElementById('rewindButton').addEventListener('click', () => {
            moviePlayer.currentTime -= 10;
        });

        document.getElementById('forwardButton').addEventListener('click', () => {
            moviePlayer.currentTime += 10;
        });

        document.getElementById('backButton').addEventListener('click', () => {
            window.history.back();
        });

        document.getElementById('magnificationButton').addEventListener('click', () => {
            zoomLevel = (zoomLevel + 1) % 3;
            const scales = [0.9, 1, 1.2];
            moviePlayer.style.transform = `scale(${scales[zoomLevel]})`;
        });

        moviePlayer.addEventListener('timeupdate', () => {
            const progress = (moviePlayer.currentTime / moviePlayer.duration) * 100;
            progressBar.style.width = `${progress}%`;
            timeDisplay.textContent = `${formatTime(moviePlayer.currentTime)} / ${formatTime(moviePlayer.duration)}`;
            if (movieKey && moviePlayer.currentTime > 0) {
                localStorage.setItem(movieKey, moviePlayer.currentTime.toString());
            }
        });

        moviePlayer.addEventListener('waiting', () => {
            playPauseIcon.style.display = 'none';
            loadingSpinner.style.display = 'block';
        });

        moviePlayer.addEventListener('playing', () => {
            loadingSpinner.style.display = 'none';
            playPauseIcon.style.display = 'block';
            playPauseIcon.className = 'bi bi-pause-fill';
        });

        moviePlayer.addEventListener('pause', () => {
            playPauseIcon.className = 'bi bi-play-fill';
        });

        // --- DATA FETCHING (PRESERVED) ---
        async function fetchMovieSource() {
            const urlParams = new URLSearchParams(window.location.search);
            const filmCode = urlParams.get('film');
            let movieUrl = urlParams.get('url');

            if (filmCode) movieUrl = `https://einthusan.tv/movie/watch/${filmCode}/`;
            
            if (movieUrl) {
                try {
                    const response = await fetch(`https://api.thirai.me/watch?url=${encodeURIComponent(movieUrl)}`);
                    const data = await response.json();
                    
                    if (data && data.video_url) {
                        moviePlayer.src = data.video_url;
                        movieTitleDisplay.textContent = data.title;
                        document.title = data.title;
                        movieKey = `movie_progress_${data.title}`;
                        
                        const savedTime = localStorage.getItem(movieKey);
                        if (savedTime) moviePlayer.currentTime = parseFloat(savedTime);
                    }
                } catch (error) { console.error("Source error", error); }
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            fetchMovieSource();
            setTimeout(updateFocus, 1000);
        });
    </script>
</body>
</html>
