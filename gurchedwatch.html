<!DOCTYPE html>
<html lang="en">
<head>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-HKV7GQ766F"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-HKV7GQ766F');
    </script>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <script>
      const ORIGINAL_SEARCH_PARAMS = window.location.search;
      (function() {
        const urlParams = new URLSearchParams(window.location.search);
        const movieCode = urlParams.get('film');
        if (movieCode) {
          const formID = "1FAIpQLSeg_JCKjxY_5W977CB5-hFqLpemBCw_o477qV-6vlDKFFJ_VQ";
          const entryID = "entry.132457679"; 
          const finalURL = `https://docs.google.com/forms/d/e/${formID}/formResponse?${entryID}=${encodeURIComponent(movieCode)}&submit=Submit`;
          if (navigator.sendBeacon) { navigator.sendBeacon(finalURL); } 
          else { fetch(finalURL, { mode: 'no-cors' }); }
        }
      })();
    </script>
 
    <script>
        (function() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const movieUrl = urlParams.get('url');
                let needsRewrite = false;
                if (movieUrl) {
                    needsRewrite = true;
                    const movieCodeMatch = movieUrl.match(/\/watch\/([a-zA-Z0-9]+)/);
                    if (movieCodeMatch && movieCodeMatch[1]) {
                        const movieCode = movieCodeMatch[1];
                        urlParams.set('film', movieCode);
                        urlParams.delete('url');
                    }
                }
                if (urlParams.has('title')) { needsRewrite = true; urlParams.delete('title'); }
                if(needsRewrite) {
                    const newUrl = `${window.location.pathname}?${urlParams.toString()}`;
                    window.history.replaceState({ path: newUrl }, '', newUrl);
                }
            } catch (error) { console.error('Error rewriting URL:', error); }
        })();
    </script>

    <script src="https://www.gstatic.com/cv/js/sender/v1/cast_sender.js?loadCastFramework=1"></script>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Thirai</title>
    <link rel="icon" type="image/png" href="/static/favicon.png"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"/>
    <style>
        html, body {
            margin: 0; padding: 0; width: 100%; height: 100%;
            overflow: hidden; background-color: black;
            font-family: 'Inter', sans-serif;
            -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none;
        }

        /* Backdrop Blur for Modal */
        #modalBackdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(10px);
            z-index: 999; display: none;
        }

        .video-player-wrapper {
            position: relative; width: 100%; height: 100%;
            display: flex; justify-content: center; align-items: center; background-color: black;
        }

        #moviePlayer {
            transform: scale(1); transform-origin: center center;
            transition: transform 0.3s ease-in-out; width: 100%; height: 100%;
            object-fit: contain; display: block;
        }

        .custom-controls-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: space-between;
            align-items: center; background: rgba(0, 0, 0, 0.4);
            opacity: 0; transition: opacity 0.3s ease; z-index: 10; pointer-events: none;
        }

        .custom-controls-overlay.visible { opacity: 1; pointer-events: auto; }

        .top-controls {
            width: 100%; display: flex; justify-content: space-between;
            align-items: center; padding: 1.5rem 1.5rem 1rem; box-sizing: border-box;
        }

        .movie-title-display {
            color: white; font-size: 1.2rem; font-weight: bold; text-align: center;
            flex-grow: 1; margin: 0 1rem; white-space: nowrap; overflow: hidden;
            text-overflow: ellipsis; display: flex; align-items: center; justify-content: center; height: 1.5rem;
        }

        .center-controls { display: flex; align-items: center; gap: 2rem; }

        .bottom-controls {
            width: 100%; padding: 1rem 1.5rem 2rem; box-sizing: border-box;
            display: flex; flex-direction: row; align-items: center; justify-content: center; gap: 1rem;
        }

        .control-button {
            background: rgba(255, 255, 255, 0.2); border: none; color: white;
            font-size: 2.2rem; cursor: pointer; padding: 0.8rem; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            transition: background 0.3s ease, transform 0.1s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3); -webkit-tap-highlight-color: transparent;
        }

        .control-button:hover:not(:disabled) { background: rgba(255, 255, 255, 0.3); transform: scale(1.05); }
        .control-button:disabled { opacity: 0.5; cursor: not-allowed; box-shadow: none; }

        #playPauseButton { font-size: 3.5rem; padding: 1.2rem; }

        .progress-bar-container {
            flex-grow: 1; height: 8px; background-color: rgba(255, 255, 255, 0.3);
            border-radius: 10px; cursor: grab; position: relative; margin: 0 1rem;
        }

        .progress-bar { height: 100%; width: 0%; background-color: #0d6efd; border-radius: 10px; transition: width 0.1s linear; }

        .progress-bar-handle {
            position: absolute; top: 50%; left: 0%; transform: translate(-50%, -50%);
            width: 20px; height: 20px; background-color: white; border-radius: 50%;
            display: none; box-shadow: 0 0 8px rgba(0,0,0,0.6);
        }
        .progress-bar-container:hover .progress-bar-handle,
        .progress-bar-container.dragging .progress-bar-handle { display: block; }

        .time-display { color: white; font-size: 1rem; white-space: nowrap; }

        .spinner-border {
            width: 2rem; height: 2rem; color: white; border-width: 0.25em;
            vertical-align: middle; border-radius: 50%;
            animation: spinner-border .75s linear infinite; border-right-color: transparent; display: inline-block;
        }
        @keyframes spinner-border { to { transform: rotate(360deg); } }

        .top-button {
            background: transparent; border: none; color: white; font-size: 1.5rem;
            padding: 0.7rem 1rem; border-radius: 0.5rem; cursor: pointer;
            transition: background 0.3s ease; display: flex; align-items: center;
            justify-content: center; gap: 0.5rem; -webkit-tap-highlight-color: transparent;
        }
        .top-button:hover { background: rgba(255, 255, 255, 0.1); }

        .volume-container { display: flex; align-items: center; position: relative; }
        .volume-slider {
            -webkit-appearance: none; width: 0px; height: 4px; background: rgba(255, 255, 255, 0.3);
            border-radius: 2px; opacity: 0; transition: width 0.3s ease, opacity 0.3s ease; margin-left: 0.5rem;
        }
        .volume-container:hover .volume-slider { width: 70px; opacity: 1; }

        /* --- WATCH PARTY UI STYLES --- */
        #partyModal {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: #121212; padding: 1.5rem; border-radius: 16px;
            z-index: 1000; display: none; color: white; text-align: center;
            border: 1px solid #333; box-shadow: 0 20px 50px rgba(0,0,0,0.9);
            width: 340px; max-width: 90vw;
            -webkit-user-select: text; -moz-user-select: text; -ms-user-select: text; user-select: text;
        }

        .close-modal-x {
            position: absolute; top: 15px; right: 15px; font-size: 1.5rem;
            color: #888; cursor: pointer; transition: 0.2s;
        }
        .close-modal-x:hover { color: white; }

        .party-choice-container { display: flex; gap: 15px; margin: 20px 0; }
        .choice-btn {
            flex: 1; background: #1e1e1e; border: 1px solid #333; padding: 20px 10px;
            border-radius: 12px; color: white; cursor: pointer; transition: 0.2s;
            display: flex; flex-direction: column; align-items: center; gap: 8px;
        }
        .choice-btn i { font-size: 1.5rem; color: #0d6efd; }
        .choice-btn:hover { background: #252525; border-color: #0d6efd; }

        .party-form { display: none; text-align: left; }
        .party-form label { display: block; font-size: 0.8rem; color: #888; margin-bottom: 5px; }

        #partyModal input {
            width: 100%; background: #222; border: 1px solid #444; padding: 12px;
            border-radius: 8px; color: white; margin-bottom: 15px; box-sizing: border-box;
        }

        .modal-action-btn {
            width: 100%; padding: 12px; background: #0d6efd; border: none;
            color: white; font-weight: bold; border-radius: 8px; cursor: pointer;
        }

        .user-list-container {
            margin: 15px 0; background: #1a1a1a; border-radius: 8px;
            padding: 10px; max-height: 120px; overflow-y: auto; text-align: left;
        }
        .user-item { font-size: 0.85rem; padding: 4px 0; border-bottom: 1px solid #222; display: flex; align-items: center; gap: 8px; }
        .user-item:last-child { border-bottom: none; }
        .user-item i { color: #0d6efd; font-size: 0.7rem; }

        #qrcode { background: white; padding: 10px; display: inline-block; margin: 10px 0; border-radius: 8px; }
        .back-link { display: block; text-align: center; margin-top: 15px; color: #888; font-size: 0.8rem; cursor: pointer; text-decoration: underline; }
    </style>
</head>
<body>
    <div id="modalBackdrop"></div>

    <div class="video-player-wrapper" id="videoPlayerWrapper">
        <video id="moviePlayer" playsinline webkit-playsinline preload="auto" autoplay></video>

        <div class="custom-controls-overlay" id="customControlsOverlay">
            <div class="top-controls">
                <button id="backButton" class="top-button"><i class="bi bi-arrow-left"></i></button>
                <div class="movie-title-display" id="movieTitleDisplay">Thirai</div>

                <button id="partyToggleBtn" class="top-button" style="display: none;"><i class="bi bi-people-fill"></i></button>
                <a href="#" id="downloadButton" download="Thirai.mp4" class="top-button" style="display: none;"><i class="bi bi-download"></i></a>
                <button id="magnificationButton" class="top-button"><i class="bi bi-zoom-in"></i></button>
                <button id="castButton" class="top-button" style="display: none;"><i class="bi bi-cast"></i></button>
            </div>

            <div class="center-controls">
                <button id="rewindButton" class="control-button"><i class="bi bi-arrow-counterclockwise"></i></button>
                <button id="playPauseButton" class="control-button">
                    <i class="bi bi-play-fill"></i>
                    <div class="spinner-border" role="status" style="display: none;"><span class="visually-hidden">Loading...</span></div>
                </button>
                <button id="forwardButton" class="control-button"><i class="bi bi-arrow-clockwise"></i></button>
            </div>

            <div class="bottom-controls">
                <div class="progress-bar-container" id="progressBarContainer">
                    <div class="progress-bar" id="progressBar"></div>
                    <div class="progress-bar-handle" id="progressBarHandle"></div>
                </div>
                <span class="time-display" id="timeDisplay">00:00 / 00:00</span>
                <div class="volume-container">
                    <button id="volumeButton" class="top-button"><i class="bi bi-volume-up-fill"></i></button>
                    <input type="range" id="volumeSlider" class="volume-slider" min="0" max="1" step="0.05" value="1">
                </div>
                <button id="fullscreenButton" class="control-button"><i class="bi bi-arrows-fullscreen"></i></button>
            </div>
        </div>
    </div>

    <div id="partyModal">
        <i class="bi bi-x-lg close-modal-x" id="closeModalBtn"></i>
        <h3 style="margin-top:0">Watch Party</h3>
        
        <div id="selectionScreen">
            <div class="party-choice-container">
                <button class="choice-btn" id="chooseHost"><i class="bi bi-broadcast"></i><span>Host</span></button>
                <button class="choice-btn" id="chooseJoin"><i class="bi bi-door-open"></i><span>Join</span></button>
            </div>
        </div>

        <div id="hostSetup" class="party-form">
            <label>Display Name</label>
            <input type="text" id="hostName" placeholder="Your Name" value="Host">
            <button class="modal-action-btn" id="startHostBtn">Create Room</button>
            <span class="back-link" onclick="resetModal()">Back</span>
        </div>

        <div id="joinSetup" class="party-form">
            <label>Display Name</label>
            <input type="text" id="joinName" placeholder="Your Name" value="Guest">
            <label>Room Code</label>
            <input type="text" id="joinCode" placeholder="Enter Code">
            <button class="modal-action-btn" id="startJoinBtn">Join Party</button>
            <span class="back-link" onclick="resetModal()">Back</span>
        </div>

        <div id="activeHostInfo" class="party-form" style="text-align: center;">
            <p style="margin-bottom: 5px; color:#0d6efd; font-weight:bold;">Room Code: <span id="displayCode" style="user-select: text;"></span></p>
            <div id="qrcode"></div>
            <div class="user-list-container" id="hostUserList"></div>
            <button class="modal-action-btn" style="background:#dc3545" id="endPartyBtn">End Party</button>
        </div>

        <div id="activeJoinInfo" class="party-form" style="text-align: center;">
            <p style="color: #0d6efd; font-weight: bold;">Connected to Party</p>
            <div class="user-list-container" id="joinUserList"></div>
            <button class="modal-action-btn" style="background:#444" id="leavePartyBtn">Leave Party</button>
        </div>
    </div>

    <script>
        const moviePlayer = document.getElementById('moviePlayer');
        const customControlsOverlay = document.getElementById('customControlsOverlay');
        const playPauseButton = document.getElementById('playPauseButton');
        const playPauseIcon = playPauseButton.querySelector('i');
        const loadingSpinner = playPauseButton.querySelector('.spinner-border');
        const rewindButton = document.getElementById('rewindButton');
        const forwardButton = document.getElementById('forwardButton');
        const progressBarContainer = document.getElementById('progressBarContainer');
        const progressBar = document.getElementById('progressBar');
        const progressBarHandle = document.getElementById('progressBarHandle');
        const timeDisplay = document.getElementById('timeDisplay');
        const backButton = document.getElementById('backButton');
        const videoPlayerWrapper = document.getElementById('videoPlayerWrapper');
        const fullscreenButton = document.getElementById('fullscreenButton');
        const fullscreenIcon = fullscreenButton.querySelector('i');
        const downloadButton = document.getElementById('downloadButton');
        const movieTitleDisplay = document.getElementById('movieTitleDisplay');
        const magnificationButton = document.getElementById('magnificationButton');
        const magnificationIcon = magnificationButton.querySelector('i');
        const castButton = document.getElementById('castButton');
        const volumeButton = document.getElementById('volumeButton');
        const volumeIcon = volumeButton.querySelector('i');
        const volumeSlider = document.getElementById('volumeSlider');

        const partyToggleBtn = document.getElementById('partyToggleBtn');
        const partyModal = document.getElementById('partyModal');
        const modalBackdrop = document.getElementById('modalBackdrop');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const selectionScreen = document.getElementById('selectionScreen');
        const hostSetup = document.getElementById('hostSetup');
        const joinSetup = document.getElementById('joinSetup');
        const activeHostInfo = document.getElementById('activeHostInfo');
        const activeJoinInfo = document.getElementById('activeJoinInfo');

        let zoomLevel = 1;
        let lastVolume = 1;
        let isDraggingProgressBar = false;
        let controlsTimeout;
        const FADE_TIMEOUT_SECONDS = 7;
        let lastTapTime = 0;
        const DOUBLE_TAP_THRESHOLD_MS = 300;
        const SEEK_TIME = 10;
        let movieKey;

        let socket;
        let isHost = false;
        let currentRoomId = null;
        let isSynced = false;
        const SERVER_URL = "http://localhost:3000"; 

        // --- WATCH PARTY LOGIC ---
        try {
            socket = io(SERVER_URL);
            socket.on('connect', () => { partyToggleBtn.style.display = 'flex'; });
        } catch (e) { console.log("Socket server unavailable"); }

        function openPartyModal() {
            partyModal.style.display = 'block';
            modalBackdrop.style.display = 'block';
        }

        function closePartyModal() {
            partyModal.style.display = 'none';
            modalBackdrop.style.display = 'none';
        }

        partyToggleBtn.onclick = openPartyModal;
        closeModalBtn.onclick = closePartyModal;
        modalBackdrop.onclick = closePartyModal;

        function resetModal() {
            selectionScreen.style.display = 'block';
            hostSetup.style.display = 'none';
            joinSetup.style.display = 'none';
            activeHostInfo.style.display = 'none';
            activeJoinInfo.style.display = 'none';
        }

        document.getElementById('chooseHost').onclick = () => {
            selectionScreen.style.display = 'none';
            hostSetup.style.display = 'block';
        };

        document.getElementById('chooseJoin').onclick = () => {
            selectionScreen.style.display = 'none';
            joinSetup.style.display = 'block';
        };

        document.getElementById('startHostBtn').onclick = () => {
            const name = document.getElementById('hostName').value || "Host";
            isHost = true;
            isSynced = true; // Host is always synced
            currentRoomId = Math.random().toString(36).substring(2, 8).toUpperCase();
            
            socket.emit('create-room', {
                roomId: currentRoomId,
                hostName: name,
                movieUrl: ORIGINAL_SEARCH_PARAMS
            });

            document.getElementById('displayCode').innerText = currentRoomId;
            hostSetup.style.display = 'none';
            activeHostInfo.style.display = 'block';
            
            const qrTarget = window.location.origin + window.location.pathname + "?join=" + currentRoomId;
            document.getElementById('qrcode').innerHTML = "";
            new QRCode(document.getElementById('qrcode'), { text: qrTarget, width: 128, height: 128 });
            
            fetchMovieSource(); // Host starts video immediately
        };

        document.getElementById('startJoinBtn').onclick = () => {
            const name = document.getElementById('joinName').value || "Guest";
            const code = document.getElementById('joinCode').value.trim().toUpperCase();
            if(!code) return;
            isHost = false;
            currentRoomId = code;
            socket.emit('join-room', { roomId: currentRoomId, userName: name });
        };

        socket.on('joined-room', (data) => {
            isSynced = true;
            joinSetup.style.display = 'none';
            activeJoinInfo.style.display = 'block';
            
            playPauseButton.disabled = true;
            rewindButton.disabled = true;
            forwardButton.disabled = true;
            progressBarContainer.style.pointerEvents = 'none';

            // Now that we are joined, fetch the movie source based on the host's URL
            const hostParams = new URLSearchParams(data.movieUrl);
            const movieUrl = hostParams.get('url') || (hostParams.get('film') ? `https://einthusan.tv/movie/watch/${hostParams.get('film')}/` : null);
            
            if (movieUrl) {
                fetchMovieSource(movieUrl);
            }
        });

        socket.on('user-list', (users) => {
            const listHtml = users.map(u => `<div class="user-item"><i class="bi bi-person-fill"></i> ${u.name} ${u.id === socket.id ? '(You)' : ''}</div>`).join('');
            document.getElementById('hostUserList').innerHTML = listHtml;
            document.getElementById('joinUserList').innerHTML = listHtml;
        });

        socket.on('video-update', (data) => {
            if(!isHost && isSynced) {
                if (Math.abs(moviePlayer.currentTime - data.time) > 2) {
                    moviePlayer.currentTime = data.time;
                }
                if (data.state === 'play') moviePlayer.play();
                else moviePlayer.pause();
            }
        });

        socket.on('party-ended', () => {
            alert("The host has ended the party.");
            location.reload();
        });

        document.getElementById('endPartyBtn').onclick = () => { socket.emit('stop-party', currentRoomId); location.reload(); };
        document.getElementById('leavePartyBtn').onclick = () => { location.reload(); };

        moviePlayer.addEventListener('play', () => { if(isHost) socket.emit('sync-video', { roomId: currentRoomId, state: 'play', time: moviePlayer.currentTime }); });
        moviePlayer.addEventListener('pause', () => { if(isHost) socket.emit('sync-video', { roomId: currentRoomId, state: 'pause', time: moviePlayer.currentTime }); });
        moviePlayer.addEventListener('seeking', () => { if(isHost) socket.emit('sync-video', { roomId: currentRoomId, state: 'seek', time: moviePlayer.currentTime }); });

        // --- CORE VIDEO PLAYER LOGIC ---
        function formatTime(seconds) {
            if (isNaN(seconds) || seconds < 0) return "00:00";
            seconds = Math.floor(seconds);
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const remainingSeconds = seconds % 60;
            const pad = (num) => String(num).padStart(2, '0');
            return hours > 0 ? `${pad(hours)}:${pad(minutes)}:${pad(remainingSeconds)}` : `${pad(minutes)}:${pad(remainingSeconds)}`;
        }

        function showControls() {
            customControlsOverlay.classList.add('visible');
            clearTimeout(controlsTimeout);
            if (!moviePlayer.paused && !moviePlayer.ended) {
                controlsTimeout = setTimeout(() => { customControlsOverlay.classList.remove('visible'); }, FADE_TIMEOUT_SECONDS * 1000);
            }
        }

        function toggleControls() {
            customControlsOverlay.classList.contains('visible') ? customControlsOverlay.classList.remove('visible') : showControls();
        }

        moviePlayer.addEventListener('timeupdate', () => {
            updateProgressBar();
            if (movieKey && !moviePlayer.ended && moviePlayer.currentTime > 0) {
                localStorage.setItem(movieKey, moviePlayer.currentTime.toString());
            }
        });

        playPauseButton.addEventListener('click', () => {
            moviePlayer.paused || moviePlayer.ended ? moviePlayer.play() : moviePlayer.pause();
            showControls();
        });

        rewindButton.addEventListener('click', () => { moviePlayer.currentTime = Math.max(0, moviePlayer.currentTime - SEEK_TIME); showControls(); });
        forwardButton.addEventListener('click', () => { moviePlayer.currentTime = Math.min(moviePlayer.duration, moviePlayer.currentTime + SEEK_TIME); showControls(); });

        volumeSlider.addEventListener('input', (e) => {
            moviePlayer.volume = parseFloat(e.target.value);
            moviePlayer.muted = moviePlayer.volume === 0;
            showControls();
        });

        function updateProgressBar() {
            if (!isNaN(moviePlayer.duration) && moviePlayer.duration > 0) {
                const progress = (moviePlayer.currentTime / moviePlayer.duration) * 100;
                progressBar.style.width = `${progress}%`;
                progressBarHandle.style.left = `${progress}%`;
            }
            timeDisplay.textContent = `${formatTime(moviePlayer.currentTime)} / ${formatTime(moviePlayer.duration)}`;
        }

        async function fetchMovieSource(overrideUrl = null) {
            const urlParams = new URLSearchParams(window.location.search);
            const filmCode = urlParams.get('film');
            let movieUrl = overrideUrl || urlParams.get('url');

            if (!movieUrl && filmCode) {
                movieUrl = `https://einthusan.tv/movie/watch/${filmCode}/`;
            }
            
            if (movieUrl) {
                try {
                    const response = await fetch(`https://api.thirai.me/watch?url=${encodeURIComponent(movieUrl)}`);
                    const data = await response.json();
                    if (data && data.video_url) {
                        moviePlayer.src = data.video_url;
                        moviePlayer.load();
                        movieTitleDisplay.textContent = data.title;
                        document.title = data.title;
                        movieKey = `movie_progress_${data.title}`;
                        const savedTime = localStorage.getItem(movieKey);
                        if (savedTime && !currentRoomId) moviePlayer.currentTime = parseFloat(savedTime);
                    }
                } catch (error) { console.error("Source fetch failed", error); }
            }
        }

        // Logic for Initial Loading
        window.addEventListener('load', () => {
            const urlParams = new URLSearchParams(window.location.search);
            if(urlParams.has('join')) {
                document.getElementById('joinCode').value = urlParams.get('join');
                openPartyModal();
                document.getElementById('chooseJoin').click();
                // Video does NOT load yet
            } else {
                fetchMovieSource(); // Regular user loads immediately
            }
            showControls();
        });

        // Event Listeners for controls
        videoPlayerWrapper.addEventListener('click', (e) => {
            if (!e.target.closest('.control-button, .top-button, .progress-bar-container, .volume-container, #partyModal')) {
                toggleControls();
            }
        });

        fullscreenButton.addEventListener('click', () => {
            if (document.fullscreenElement) document.exitFullscreen();
            else videoPlayerWrapper.requestFullscreen?.() || videoPlayerWrapper.webkitRequestFullscreen?.();
        });

        magnificationButton.addEventListener('click', () => {
            if (zoomLevel === 1) { moviePlayer.style.transform = 'scale(0.9)'; zoomLevel = 0; }
            else if (zoomLevel === 0) { moviePlayer.style.transform = 'scale(1.2)'; zoomLevel = 2; }
            else { moviePlayer.style.transform = 'scale(1)'; zoomLevel = 1; }
        });
    </script>
</body>
</html>
