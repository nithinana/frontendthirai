<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Thirai TV</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"/>
    <style>
        html, body {
            margin: 0; padding: 0; width: 100%; height: 100%;
            overflow: hidden; background-color: black;
            font-family: 'Inter', sans-serif;
            -webkit-user-select: none; user-select: none;
        }

        /* TV Focus Highlights - Uses Scale & Shadow to avoid moving other items */
        :focus {
            outline: 4px solid #0d6efd !important;
            outline-offset: 4px;
            background: rgba(13, 110, 253, 0.5) !important;
            transform: scale(1.1);
            z-index: 20;
        }

        .video-player-wrapper {
            position: relative; width: 100%; height: 100%;
            display: flex; justify-content: center; align-items: center;
            background-color: black;
        }

        #moviePlayer {
            width: 100%; height: 100%;
            object-fit: contain;
        }

        .custom-controls-overlay {
            position: absolute; inset: 0;
            display: flex; flex-direction: column;
            justify-content: space-between;
            background: linear-gradient(to top, rgba(0,0,0,0.9) 0%, transparent 30%, transparent 70%, rgba(0,0,0,0.9) 100%);
            opacity: 0; transition: opacity 0.4s ease;
            z-index: 10; pointer-events: none;
        }

        .custom-controls-overlay.visible {
            opacity: 1; pointer-events: auto;
        }

        .top-controls, .bottom-controls {
            padding: 40px 60px;
            display: flex; align-items: center; gap: 30px;
        }

        .movie-title-display {
            color: white; font-size: 2.5rem; font-weight: bold;
            flex-grow: 1; text-align: center;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        }

        .center-controls {
            display: flex; justify-content: center; align-items: center; gap: 60px;
        }

        .control-button, .top-button {
            background: rgba(255, 255, 255, 0.15);
            border: none; color: white;
            padding: 20px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 3rem; cursor: pointer;
            transition: transform 0.2s ease, background 0.2s ease;
        }

        #playPauseButton { width: 120px; height: 120px; font-size: 5rem; }

        /* FIX: Progress Bar doesn't push layout on hover */
        .progress-container {
            flex-grow: 1;
            height: 60px; /* Larger hit area */
            display: flex;
            align-items: center;
            position: relative;
        }

        #seekBar {
            width: 100%;
            cursor: pointer;
            accent-color: #0d6efd;
            height: 12px;
            transition: transform 0.2s ease;
        }

        /* Enlarge bar on focus/hover without shifting anything */
        #seekBar:focus, #seekBar:hover {
            transform: scaleY(1.8);
        }

        .time-display {
            color: white; font-size: 1.8rem; font-weight: 500;
            min-width: 250px; text-align: right;
            font-variant-numeric: tabular-nums;
        }

        .spinner-border {
            width: 4rem; height: 4rem;
            border: 0.4em solid white; border-right-color: transparent;
            border-radius: 50%; animation: spin .75s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="video-player-wrapper">
        <video id="moviePlayer" playsinline autoplay></video>

        <div class="custom-controls-overlay" id="customControlsOverlay">
            <div class="top-controls">
                <button id="backButton" class="top-button"><i class="bi bi-arrow-left"></i></button>
                <div class="movie-title-display" id="movieTitleDisplay">Loading...</div>
                <button id="magnificationButton" class="top-button"><i class="bi bi-zoom-in"></i></button>
            </div>

            <div class="center-controls">
                <button id="rewindButton" class="control-button"><i class="bi bi-arrow-counterclockwise"></i></button>
                <button id="playPauseButton" class="control-button">
                    <i class="bi bi-play-fill" id="playPauseIcon"></i>
                    <div class="spinner-border" id="loadingSpinner" style="display: none;"></div>
                </button>
                <button id="forwardButton" class="control-button"><i class="bi bi-arrow-clockwise"></i></button>
            </div>

            <div class="bottom-controls">
                <div class="progress-container">
                    <input type="range" id="seekBar" value="0" step="0.1" min="0">
                </div>
                <span class="time-display" id="timeDisplay">00:00 / 00:00</span>
                <button id="volumeButton" class="top-button"><i class="bi bi-volume-up-fill"></i></button>
            </div>
        </div>
    </div>

    <script>
        const moviePlayer = document.getElementById('moviePlayer');
        const overlay = document.getElementById('customControlsOverlay');
        const playPauseBtn = document.getElementById('playPauseButton');
        const playPauseIcon = document.getElementById('playPauseIcon');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const seekBar = document.getElementById('seekBar');
        const timeDisplay = document.getElementById('timeDisplay');
        const volumeBtn = document.getElementById('volumeButton');

        // TV Navigation Map
        const navRows = [
            ['backButton', 'magnificationButton'],
            ['rewindButton', 'playPauseButton', 'forwardButton'],
            ['seekBar', 'volumeButton']
        ];
        let currentRow = 1, currentCol = 1;

        function updateFocus() {
            const el = document.getElementById(navRows[currentRow][currentCol]);
            if (el) { el.focus(); showControls(); }
        }

        // --- SEEKING LOGIC ---
        // Immediate UI update when sliding
        seekBar.addEventListener('input', () => {
            const seekTo = (seekBar.value / 100) * moviePlayer.duration;
            timeDisplay.textContent = `${formatTime(seekTo)} / ${formatTime(moviePlayer.duration)}`;
        });

        // Actual seek only happens when interaction ends (better for TV/Remotes)
        seekBar.addEventListener('change', () => {
            moviePlayer.currentTime = (seekBar.value / 100) * moviePlayer.duration;
        });

        // --- VOLUME LOGIC ---
        volumeBtn.addEventListener('click', () => {
            moviePlayer.muted = !moviePlayer.muted;
            volumeBtn.innerHTML = moviePlayer.muted ? 
                '<i class="bi bi-volume-mute-fill"></i>' : '<i class="bi bi-volume-up-fill"></i>';
        });

        // --- CORE FUNCTIONS ---
        function formatTime(s) {
            if (isNaN(s)) return "00:00";
            const h = Math.floor(s / 3600);
            const m = Math.floor((s % 3600) / 60);
            const rs = Math.floor(s % 60);
            return h > 0 ? `${h}:${String(m).padStart(2,'0')}:${String(rs).padStart(2,'0')}` : 
                           `${String(m).padStart(2,'0')}:${String(rs).padStart(2,'0')}`;
        }

        moviePlayer.addEventListener('timeupdate', () => {
            // Only update slider if user isn't currently dragging it
            if (!document.activeElement || document.activeElement.id !== 'seekBar') {
                const progress = (moviePlayer.currentTime / moviePlayer.duration) * 100;
                seekBar.value = progress || 0;
                timeDisplay.textContent = `${formatTime(moviePlayer.currentTime)} / ${formatTime(moviePlayer.duration)}`;
            }
        });

        moviePlayer.addEventListener('loadedmetadata', () => {
            seekBar.max = 100;
        });

        // Keyboard/Remote Navigation
        document.addEventListener('keydown', (e) => {
            showControls();
            if(e.key === 'ArrowUp' && currentRow > 0) currentRow--;
            else if(e.key === 'ArrowDown' && currentRow < 2) currentRow++;
            else if(e.key === 'ArrowLeft' && currentCol > 0) currentCol--;
            else if(e.key === 'ArrowRight' && currentCol < navRows[currentRow].length-1) currentCol++;
            else if(e.key === 'Backspace') window.history.back();
            updateFocus();
        });

        let timeout;
        function showControls() {
            overlay.classList.add('visible');
            clearTimeout(timeout);
            if(!moviePlayer.paused) timeout = setTimeout(() => overlay.classList.remove('visible'), 5000);
        }

        playPauseBtn.addEventListener('click', () => {
            moviePlayer.paused ? moviePlayer.play() : moviePlayer.pause();
        });

        moviePlayer.addEventListener('playing', () => {
            playPauseIcon.className = 'bi bi-pause-fill';
            loadingSpinner.style.display = 'none';
            playPauseIcon.style.display = 'block';
        });

        moviePlayer.addEventListener('waiting', () => {
            loadingSpinner.style.display = 'block';
            playPauseIcon.style.display = 'none';
        });

        // Existing source fetching logic (abbreviated for clarity)
        async function fetchMovieSource() {
            const urlParams = new URLSearchParams(window.location.search);
            const movieUrl = urlParams.get('url');
            if (movieUrl) {
                const res = await fetch(`https://api.thirai.me/watch?url=${encodeURIComponent(movieUrl)}`);
                const data = await res.json();
                if (data.video_url) {
                    moviePlayer.src = data.video_url;
                    document.getElementById('movieTitleDisplay').textContent = data.title;
                }
            }
        }
        fetchMovieSource();
    </script>
</body>
</html>
