<!DOCTYPE html>
<html lang="en">
<head>

    <script async src="https://www.googletagmanager.com/gtag/js?id=G-HKV7GQ766F"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-HKV7GQ766F');
</script>


    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thirai</title>

    <link rel="manifest" href="/manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Thirai">
    <link rel="apple-touch-icon" href="/static/ios/icon-192x192.png">
    <link rel="icon" type="image/png" href="/static/favicon.png" id="faviconLink"/>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <style>
        /* --- GLOBAL STYLES & THEME VARIABLES --- */
        :root {
            --primary-color: #0d6efd;
            --secondary-color: #6c757d;
            --bg-color: #ffffff;
            --text-color: #212529;
            --card-bg-color: #f8f9fa;
            --input-bg-color: #ffffff;
            --input-border-color: #ced4da;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --transition-speed: 0.5s;
        }

        body.dark-mode {
            --bg-color: #121212;
            --text-color: #e0e0e0;
            --card-bg-color: #242424;
            --input-bg-color: #333333;
            --input-border-color: #444444;
            --shadow-color: rgba(0, 0, 0, 0.5);
        }

        body, html {
            height: 100%;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color var(--transition-speed), color var(--transition-speed);
        }

        .no-scroll {
            overflow: hidden !important;
        }

        /* --- LOADING OVERLAY --- */
        #loadingOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            opacity: 1;
            transition: opacity 0.5s ease;
        }

        .spinner-border {
            width: 3rem;
            height: 3rem;
            color: var(--primary-color) !important;
        }

        #overlayLogo {
            max-width: 200px;
            margin-bottom: 20px;
        }
        
        #slowNetworkMessage {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 10px 20px;
            background-color: var(--card-bg-color);
            border-radius: 8px;
            box-shadow: 0 2px 10px var(--shadow-color);
            display: none; /* Hidden by default */
            z-index: 9999; 
            text-align: center;
            opacity: 0.9;
        }

        /* --- NEW: BACK BUTTON STYLES (MATCHED DARK MODE) --- */
        .back-button {
            position: fixed;
            top: 20px;
            left: 20px;
            font-size: 24px;
            text-decoration: none;
            cursor: pointer;
            z-index: 1001;
            padding: 10px;
            border-radius: 8px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.5); /* Stronger shadow for contrast */
            
            /* Dark grey, semi-transparent look */
            background-color: rgba(33, 37, 41, 0.7); /* Slightly darker/more opaque than before */
            color: #ffffff; /* White icon/text */
            opacity: 1; 
            transition: opacity 0.5s ease-in-out, background-color 0.2s ease, box-shadow 0.5s ease; 
        }

        .back-button:hover {
            /* Hover feedback with darker color */
            background-color: rgba(51, 51, 51, 0.9); /* #333 with high opacity */
            opacity: 1; 
        }
        
        /* --- NEW: UNLOCK SCREEN STYLES (UPDATED FOR DARK MODE) --- */

        #unlock-screen {
            /* Must be 'none' initially, will be changed to 'flex' by JS if access is locked */
            display: none; 
            justify-content: center;
            align-items: center;
            height: 100vh;
            width: 100%;
            flex-direction: column;
            position: fixed; /* Use fixed to cover the entire viewport */
            top: 0; left: 0;
            background-color: var(--bg-color); /* Match body background variable */
            z-index: 9998; /* High z-index to cover everything except loading overlay (9999) */
            color: var(--text-color);
        }

        #unlock-screen .container {
            text-align: center;
            background-color: var(--card-bg-color); /* Match card background variable */
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5); /* Match join.html shadow */
            max-width: 90%;
            width: 400px;
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: background-color 0.5s ease, box-shadow 0.5s ease; /* Added transition */
        }

        #unlock-screen #logo {
            max-width: 175px;
            margin-bottom: 12px;
        }

        /* Ensure heading is visible */
        #unlock-screen h2 {
            color: var(--text-color);
        }

        .code-input-container {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 25px;
        }

        .code-input {
            width: 40px;
            height: 50px;
            text-align: center;
            font-size: 1.8em;
            font-weight: bold;
            color: var(--text-color); /* Dark mode text color variable */
            background-color: var(--input-bg-color); /* Dark input background variable */
            border: 2px solid var(--input-border-color); /* Darker border variable */
            border-radius: 8px;
            outline: none;
            transition: border-color 0.2s ease, background-color 0.5s ease, color 0.5s ease;
        }

        .code-input:focus {
            border-color: #0d6efd;
        }

        /* --- Input Autofill Styling for Dark Mode --- */
        input::-webkit-autofill,
        input:-webkit-autofill:hover,
        input:-webkit-autofill:focus,
        input:-webkit-autofill:active {
            -webkit-box-shadow: 0 0 0 30px #222 inset !important; /* Fixed dark background */
            -webkit-text-fill-color: #fff !important; /* Fixed white text */
        }

        /* Join Button styles (using bootstrap primary color) */
        .join-button {
            width: 100%;
            padding: 15px;
            background-color: #0d6efd;
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            cursor: pointer;
            transition: background-color 0.2s ease;
            margin-bottom: 25px;
        }

        .join-button:hover {
            background-color: #0b5ed7; /* Darken slightly on hover */
        }

        .join-button:disabled {
            background-color: #555;
            cursor: not-allowed;
        }

        #error-message {
            color: #dc3545;
            font-size: 0.9em;
            display: none;
            margin-top: 25px;
            text-align: center;
        }
        
        /* --- Header and Navigation --- */
        .app-header {
            background-color: var(--card-bg-color);
            padding: 10px 0;
            box-shadow: 0 2px 4px var(--shadow-color);
            position: sticky;
            top: 0;
            z-index: 1000;
            transition: background-color var(--transition-speed);
        }

        #headerLogo {
            max-height: 40px; 
            height: 40px; /* Default height */
            width: auto;
            transition: all 0.5s ease;
        }

        .search-form {
            max-width: 400px;
            width: 100%;
        }

        .form-control {
            background-color: var(--input-bg-color);
            color: var(--text-color);
            border-color: var(--input-border-color);
            transition: background-color var(--transition-speed), border-color var(--transition-speed), color var(--transition-speed);
        }

        .form-control:focus {
            background-color: var(--input-bg-color);
            color: var(--text-color);
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        }

        .highlight-red {
            border-color: #dc3545 !important;
            box-shadow: 0 0 0 0.25rem rgba(220, 53, 69, 0.25) !important;
        }
        
        /* --- Promo Banner (Carousel) --- */
        .promo-banner-container {
            padding: 0;
            margin-top: -10px; /* Pulls it up slightly to blend with header shadow */
            transition: transform 0.5s ease, opacity 0.5s ease, height 0.5s ease;
            overflow: hidden;
            height: 350px; /* Fixed height for consistent look */
        }
        
        .promo-banner-container.hidden {
            transform: translateY(-100%);
            opacity: 0;
            height: 0;
        }

        #popularSlider {
            width: 100%;
            height: 100%;
        }

        .carousel-item {
            height: 350px;
            background-size: cover;
            background-position: center top;
            transition: transform 0.6s ease-in-out;
        }

        .carousel-caption {
            position: absolute;
            top: 0; bottom: 0;
            left: 0; right: 0;
            background: linear-gradient(to bottom, rgba(0,0,0,0.1) 0%, rgba(0,0,0,0.7) 100%);
            text-align: left;
            padding-bottom: 20px;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            align-items: flex-start;
            color: white;
            padding-left: 5%;
            padding-right: 5%;
        }
        
        .carousel-caption h3 {
            font-size: 1.5rem;
            margin-bottom: 10px;
        }

        .carousel-caption .btn {
            background-color: var(--primary-color);
            border: none;
            color: white;
            font-weight: bold;
            transition: background-color 0.2s;
        }

        /* --- Content Sections --- */
        .data-section {
            margin-bottom: 30px;
            transition: opacity 0.5s ease, transform 0.5s ease;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .section-header h2 {
            font-size: 1.5rem;
            margin: 0;
            color: var(--text-color);
        }

        /* --- Scroller Container and Controls --- */
        .movies-scroller-wrapper {
            position: relative;
        }

        .movies-scroller {
            display: flex;
            gap: 16px;
            overflow-x: auto;
            scroll-snap-type: x mandatory;
            padding-bottom: 10px; /* Space for scrollbar */
            -ms-overflow-style: none; /* IE and Edge */
            scrollbar-width: none; /* Firefox */
        }

        .movies-scroller::-webkit-scrollbar {
            display: none; /* Chrome, Safari and Opera */
        }
        
        /* Fixed width for scroll items */
        .movies-scroller > .col {
            flex-shrink: 0;
            width: 120px; /* Mobile size */
            scroll-snap-align: start;
        }

        @media (min-width: 576px) {
            .movies-scroller > .col {
                width: 140px; /* Small screen size */
            }
        }
        @media (min-width: 992px) {
            .movies-scroller > .col {
                width: 160px; /* Desktop size */
            }
        }
        @media (min-width: 1400px) {
            .movies-scroller > .col {
                width: 180px; /* Extra large size */
            }
        }
        

        .scroll-btn {
            position: absolute;
            top: 50%;
            transform: translateY(calc(-50% - 5px)); /* Adjusted for padding-bottom */
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            border: none;
            padding: 15px 10px;
            border-radius: 5px;
            cursor: pointer;
            z-index: 10;
            transition: background-color 0.2s, opacity 0.3s;
            opacity: 1;
        }

        .scroll-btn-prev {
            left: 0;
            border-top-left-radius: 0;
            border-bottom-left-radius: 0;
        }

        .scroll-btn-next {
            right: 0;
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;
        }

        .scroll-btn:disabled {
            opacity: 0;
            cursor: default;
        }
        
        .movies-scroller-wrapper.is-at-start .scroll-btn-prev,
        .movies-scroller-wrapper.is-at-end .scroll-btn-next {
            opacity: 0;
            pointer-events: none;
        }
        
        /* --- Movie Card --- */
        .movie-card {
            background-color: var(--card-bg-color);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 8px var(--shadow-color);
            height: 100%;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            position: relative;
        }

        .movie-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
        }
        
        .movie-link {
            text-decoration: none;
            color: inherit;
            display: block;
        }

        .movie-img {
            width: 100%;
            height: auto;
            aspect-ratio: 2 / 3;
            display: block;
        }

        .movie-title-text {
            color: var(--text-color);
            padding: 5px;
            font-size: 0.8rem;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* --- Footer and Modals --- */
        footer {
            background-color: var(--card-bg-color);
            color: var(--text-color);
            padding: 20px 0;
            margin-top: 30px;
            border-top: 1px solid var(--input-border-color);
            transition: background-color var(--transition-speed);
        }

        footer a {
            color: var(--primary-color);
            text-decoration: none;
        }

        .modal-content {
            background-color: var(--card-bg-color);
            color: var(--text-color);
        }

        .modal-header {
            border-bottom-color: var(--input-border-color);
        }

        .modal-footer {
            border-top-color: var(--input-border-color);
        }
        
        .btn-close {
            filter: var(--text-color);
        }

    </style>
</head>
<body class="no-scroll">

    <div id="loadingOverlay">
        <img id="overlayLogo" src="/static/thiraiwhite.png" alt="Thirai Logo">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <div id="slowNetworkMessage" class="text-muted">
            The network seems slow. Please wait a moment...
        </div>
    </div>
    
    <a href="javascript:history.back()" class="back-button" aria-label="Go back" style="display: none;">
        <i class="bi bi-arrow-left"></i>
    </a>
    
    <div id="unlock-screen">
        <div class="container">
            <img id="logo" src="/static/thiraiblack.png" alt="Thirai Logo"> 
            <h2>Enter the unlock PIN</h2>
            <div class="code-input-container" id="codeInputContainer">
                <input type="text" class="code-input" id="code1" maxlength="1" pattern="[0-9]" inputmode="numeric" autocomplete="off" autocapitalize="none">
                <input type="text" class="code-input" id="code2" maxlength="1" pattern="[0-9]" inputmode="numeric" autocomplete="off" autocapitalize="none">
                <input type="text" class="code-input" id="code3" maxlength="1" pattern="[0-9]" inputmode="numeric" autocomplete="off" autocapitalize="none">
                <input type="text" class="code-input" id="code4" maxlength="1" pattern="[0-9]" inputmode="numeric" autocomplete="off" autocapitalize="none">
            </div>
            <button class="join-button" id="unlockButton" disabled>Unlock Access</button>
            <div id="error-message"></div>
        </div>
    </div>

    <header class="app-header" style="display: none;">
        <div class="container-fluid">
            <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <a href="index.html" id="logoLink">
                        <img id="headerLogo" src="/static/thiraiwhite.png" alt="Thirai Logo" data-height="40">
                    </a>
                    
                    <button class="btn btn-outline-primary ms-3 d-none d-md-inline-flex align-items-center" id="mediaTypeButton" title="Switch to TV Shows">
                        <i class="bi bi-film me-2"></i>
                        <span id="mediaTypeText">Movies</span>
                    </button>
                </div>

                <form class="search-form d-flex mx-3" role="search" id="searchForm">
                    <input class="form-control me-2" type="search" placeholder="Search movies or TV shows..." aria-label="Search" id="searchInput">
                    <button class="btn btn-primary" type="submit"><i class="bi bi-search"></i></button>
                </form>

                <div class="dropdown">
                    <button class="btn btn-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="bi bi-gear-fill"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><h6 class="dropdown-header">Theme</h6></li>
                        <li><a class="dropdown-item theme-option" href="#" data-theme="dark"><i class="bi bi-moon-fill me-2"></i> Dark Mode</a></li>
                        <li><a class="dropdown-item theme-option" href="#" data-theme="light"><i class="bi bi-sun-fill me-2"></i> Light Mode</a></li>
                        <li><a class="dropdown-item theme-option" href="#" data-theme="system"><i class="bi bi-laptop-fill me-2"></i> System Default</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#" id="aboutButton"><i class="bi bi-info-circle-fill me-2"></i> About</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </header>

    <main class="container-fluid mt-4" style="display: none;">
        
        <div class="promo-banner-container mb-4">
            <div id="popularSlider" class="carousel slide" data-bs-ride="carousel">
                <div class="carousel-indicators" id="slider-indicators">
                    </div>
                <div class="carousel-inner" id="slider-inner">
                    </div>
                <button class="carousel-control-prev" type="button" data-bs-target="#popularSlider" data-bs-slide="prev">
                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Previous</span>
                </button>
                <button class="carousel-control-next" type="button" data-bs-target="#popularSlider" data-bs-slide="next">
                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Next</span>
                </button>
            </div>
        </div>
        
        <div id="searchResultsSection" class="data-section" style="display: none;">
            <div class="section-header">
                <h2 class="mb-0">Search results for "<span id="searchQueryDisplay"></span>"</h2>
                <button class="btn btn-sm btn-outline-secondary" id="backToMainBtn"><i class="bi bi-arrow-left"></i> Back to Main</button>
            </div>
            
            <div id="section-search-movies" class="data-section">
                <h3 class="h5">Movies</h3>
                <div class="movies-scroller-wrapper">
                    <button class="scroll-btn scroll-btn-prev" id="prev-btn-search-movies" disabled><i class="bi bi-chevron-left"></i></button>
                    <div class="movies-scroller row flex-nowrap" id="movies-row-search-movies">
                        </div>
                    <button class="scroll-btn scroll-btn-next" id="next-btn-search-movies" disabled><i class="bi bi-chevron-right"></i></button>
                </div>
            </div>
            
            <div id="section-search-tv" class="data-section">
                <h3 class="h5">TV Shows</h3>
                <div class="movies-scroller-wrapper">
                    <button class="scroll-btn scroll-btn-prev" id="prev-btn-search-tv" disabled><i class="bi bi-chevron-left"></i></button>
                    <div class="movies-scroller row flex-nowrap" id="movies-row-search-tv">
                        </div>
                    <button class="scroll-btn scroll-btn-next" id="next-btn-search-tv" disabled><i class="bi bi-chevron-right"></i></button>
                </div>
            </div>
            
        </div>
        
        <div id="section-trending" class="data-section">
            <div class="section-header">
                <h2>Trending This Week</h2>
            </div>
            <div class="movies-scroller-wrapper">
                <button class="scroll-btn scroll-btn-prev" id="prev-btn-trending" disabled><i class="bi bi-chevron-left"></i></button>
                <div class="movies-scroller row flex-nowrap" id="movies-row-trending">
                    </div>
                <button class="scroll-btn scroll-btn-next" id="next-btn-trending" disabled><i class="bi bi-chevron-right"></i></button>
            </div>
        </div>

        <div id="section-now-playing" class="data-section">
            <div class="section-header">
                <h2>Now Playing in Theatres</h2>
            </div>
            <div class="movies-scroller-wrapper">
                <button class="scroll-btn scroll-btn-prev" id="prev-btn-now-playing" disabled><i class="bi bi-chevron-left"></i></button>
                <div class="movies-scroller row flex-nowrap" id="movies-row-now-playing">
                    </div>
                <button class="scroll-btn scroll-btn-next" id="next-btn-now-playing" disabled><i class="bi bi-chevron-right"></i></button>
            </div>
        </div>

        <div id="section-top-rated" class="data-section">
            <div class="section-header">
                <h2>Top Rated</h2>
            </div>
            <div class="movies-scroller-wrapper">
                <button class="scroll-btn scroll-btn-prev" id="prev-btn-top-rated" disabled><i class="bi bi-chevron-left"></i></button>
                <div class="movies-scroller row flex-nowrap" id="movies-row-top-rated">
                    </div>
                <button class="scroll-btn scroll-btn-next" id="next-btn-top-rated" disabled><i class="bi bi-chevron-right"></i></button>
            </div>
        </div>
        
    </main>

    <footer>
        <div class="container-fluid text-center">
            <p class="mb-1">
                <a href="#" id="footerAboutButton" data-bs-toggle="modal" data-bs-target="#aboutModal">About</a> | 
                <a href="#">Contact</a>
            </p>
            <p class="mb-0 text-muted" style="font-size: 0.8rem;">Content powered by The Movie Database (TMDB).</p>
        </div>
    </footer>
    
    <div class="modal fade" id="aboutModal" tabindex="-1" aria-labelledby="aboutModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="aboutModalLabel">About Thirai</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Thirai is a non-commercial web application designed for browsing and discovering movies and TV shows using The Movie Database (TMDB) API.</p>
                    <p>This is a Beta version, subject to changes and new features.</p>
                    <h6>Features:</h6>
                    <ul>
                        <li>Dynamic Movie/TV Show switching.</li>
                        <li>Carousel banner of popular titles.</li>
                        <li>Search functionality for movies and TV shows.</li>
                        <li>Dark/Light/System theme support.</li>
                    </ul>
                    <p class="text-muted" style="font-size: 0.85rem;">Disclaimer: This application does not host or stream any copyrighted content. All data is provided by TMDB.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // --- TMDB API Configuration (Kept from beta.html) ---
        const TMDB_API_KEY = '926e94b0f70b5bed8417b679652366ab';
        const TMDB_BASE_URL = 'https://api.themoviedb.org/3';
        const TMDB_IMG_BASE_URL = 'https://image.tmdb.org/t/p/w500';
        const TMDB_BACKDROP_BASE_URL = 'https://image.tmdb.org/t/p/original'; 

        // --- GLOBAL STATE (Kept from beta.html) ---
        let currentMediaType = 'movie'; // 'movie' or 'tv'
        const mainCategories = ['popular', 'trending', 'now-playing', 'top-rated'];

        // --- ACCESS CONTROL CONSTANTS (From player.html) ---
        const CORRECT_PIN = "1451"; 
        const MAX_ATTEMPTS = 5;
        const LOCKOUT_DURATION_MS = 15 * 60 * 1000; 
        const AFK_TIMEOUT_MS = 3000; // 3 seconds for inactivity fade (UNUSED here, but kept for context if you use player.html's logic)

        // --- Element Selectors (Combined) ---
        const body = document.body;
        const faviconLink = document.getElementById('faviconLink');
        const headerLogo = document.getElementById('headerLogo');
        const overlayLogo = document.getElementById('overlayLogo');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const slowNetworkMessage = document.getElementById('slowNetworkMessage');
        let initialLoadComplete = false;
        const logoLink = document.getElementById('logoLink');
        const themeOptions = document.querySelectorAll('.theme-option');
        
        // --- NEW MEDIA TYPE BUTTON ELEMENTS ---
        const mediaTypeButton = document.getElementById('mediaTypeButton');
        const mediaTypeText = document.getElementById('mediaTypeText');
        
        // --- SEARCH ELEMENTS ---
        const searchResultsSection = document.getElementById('searchResultsSection');
        const searchQueryDisplay = document.getElementById('searchQueryDisplay');
        const searchMoviesRow = document.getElementById('movies-row-search-movies');
        const searchTvRow = document.getElementById('movies-row-search-tv');
        const backToMainBtn = document.getElementById('backToMainBtn');
        
        // --- PIN ACCESS CONTROL ELEMENTS (From player.html) ---
        const unlockScreen = document.getElementById('unlock-screen');
        // Main content is everything not the unlock screen (header and main)
        const mainContentElements = [document.querySelector('header'), document.querySelector('main')];
        const inputs = document.querySelectorAll('.code-input');
        const unlockButton = document.getElementById('unlockButton');
        const errorMessage = document.getElementById('error-message');
        const backButton = document.querySelector('.back-button'); // Also used for AFK fade

        // --- Data Tracking ---
        const categoryPages = {}; 
        let lockoutInterval = null;
        let afkTimer; // AFK timer is not used for this page, but declared.

        // Loading timer (Unchanged)
        const loadingTimer = setTimeout(() => {
            if (!initialLoadComplete) {
                slowNetworkMessage.style.display = 'flex';
            }
        }, 7000);
        
        // Update Logo Height (Unchanged)
        function updateLogoHeight() {
            const logoHeight = headerLogo.getAttribute('data-height');
            if (logoHeight) {
                headerLogo.style.height = `${logoHeight}px`;
            }
        }
        
        // --- THEME MANAGEMENT (Unchanged) ---
        function updateThemeAssets(isDarkMode) {
            const lightLogo = '/static/thiraiblack.png';
            const darkLogo = '/static/thiraiwhite.png';
            
            faviconLink.href = isDarkMode ? '/static/favicon.png' : '/static/faviconlight.png';
            headerLogo.src = isDarkMode ? darkLogo : lightLogo;
            overlayLogo.src = isDarkMode ? darkLogo : lightLogo;
            
            // Also update the logo on the unlock screen (it's always visible there)
            const unlockLogo = document.getElementById('logo');
            if (unlockLogo) {
                unlockLogo.src = isDarkMode ? darkLogo : lightLogo;
            }
        }

        function applyTheme(theme) {
            let isDarkMode;
            if (theme === 'dark') {
                body.classList.add('dark-mode');
                localStorage.setItem('theme', 'dark');
                isDarkMode = true;
            } else if (theme === 'light') {
                body.classList.remove('dark-mode');
                localStorage.setItem('theme', 'light');
                isDarkMode = false;
            } else { // System default
                localStorage.removeItem('theme');
                isDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
                if (isDarkMode) {
                    body.classList.add('dark-mode');
                } else {
                    body.classList.remove('dark-mode');
                }
            }
            updateThemeAssets(isDarkMode);
        }
        
        // --- UNLOCK LOGIC FUNCTIONS (From player.html) ---
        
        function checkInputs() {
            let allFilled = true;
            inputs.forEach(input => {
                if (input.value.length === 0 || !/^\d$/.test(input.value)) {
                    allFilled = false;
                }
            });
            const isLocked = isLockedOut();
            unlockButton.disabled = !allFilled || isLocked;
            
            if (allFilled && !isLocked) {
                errorMessage.style.display = 'none';
            }
        }
        
        function isLockedOut() {
            const lockoutTimestamp = localStorage.getItem('lockoutTimestamp');
            if (lockoutTimestamp) {
                const now = new Date().getTime();
                const lockoutEnd = parseInt(lockoutTimestamp) + LOCKOUT_DURATION_MS;
                
                if (now < lockoutEnd) {
                    const remainingTimeMs = lockoutEnd - now;
                    const totalSeconds = Math.ceil(remainingTimeMs / 1000);
                    const remainingMinutes = Math.floor(totalSeconds / 60);
                    const remainingSeconds = totalSeconds % 60;

                    errorMessage.textContent = `Too many failed attempts. Try again in ${remainingMinutes}:${remainingSeconds.toString().padStart(2, '0')}.`;
                    errorMessage.style.display = 'block';
                    return true;
                } else {
                    localStorage.removeItem('lockoutTimestamp');
                    localStorage.setItem('attemptCount', '0');
                    clearInterval(lockoutInterval);
                    lockoutInterval = null;
                    errorMessage.style.display = 'none';
                    return false;
                }
            }
            return false;
        }
        
        function checkLockoutStatus() {
            if (isLockedOut()) {
                unlockButton.disabled = true;
                if (!lockoutInterval) {
                    lockoutInterval = setInterval(checkLockoutStatus, 1000); 
                }
            } else {
                if (lockoutInterval) {
                    clearInterval(lockoutInterval);
                    lockoutInterval = null;
                }
                checkInputs(); 
            }
        }

        // --- DISPLAY MANAGER (Modified from player.html's showPlayer/showUnlock) ---

        function showContent() {
            // Hide unlock screen
            unlockScreen.style.display = 'none';
            body.classList.remove('no-scroll');
            
            // Show main content elements
            mainContentElements.forEach(el => el.style.display = 'block');
            
            // Continue with the main content loading process
            loadPopularBanner(currentMediaType);
            loadAllMainCategories();
        }

        function showUnlock() {
            // Hide main content elements
            mainContentElements.forEach(el => el.style.display = 'none');
            
            // Display unlock screen
            unlockScreen.style.display = 'flex';
            body.classList.add('no-scroll');

            // Hide back button
            backButton.style.display = 'none';
            clearTimeout(afkTimer);
            
            // Check for existing lockout status
            checkLockoutStatus();
        }
        
        // --- SCROLL LOGIC (Unchanged) ---
        function updateScrollButtonsVisibility(scrollContainer, prevBtn, nextBtn) {
            if (!scrollContainer || !prevBtn || !nextBtn) return;
            const wrapper = scrollContainer.closest('.movies-scroller-wrapper');
            if (!wrapper) return;

            const atStart = scrollContainer.scrollLeft <= 5;
            const atEnd = scrollContainer.scrollLeft + scrollContainer.clientWidth >= scrollContainer.scrollWidth - 5;
            const isScrollable = scrollContainer.scrollWidth > scrollContainer.clientWidth;

            prevBtn.disabled = atStart;
            nextBtn.disabled = atEnd || !isScrollable;

            wrapper.classList.toggle('is-at-start', atStart || !isScrollable);
            wrapper.classList.toggle('is-at-end', atEnd || !isScrollable);
        }

        // --- CONTENT LOADING & DISPLAY (Modified to be called by showContent) ---

        /**
         * Toggles the visibility between the main content and the search results,
         * animating the popular banner away.
         * @param {boolean} showSearch - True to show search results, false to show main content.
         */
        function toggleContentDisplay(showSearch) {
            const bannerContainer = document.querySelector('.promo-banner-container');
            const mainContentSections = document.querySelectorAll('.data-section');
            
            // 1. Manage Search Mode
            if (showSearch) {
                // Hide main content
                bannerContainer.classList.add('hidden'); // Collapse Banner
                
                mainContentSections.forEach(section => { 
                    // Hide main category sections with fade-out
                    if (!section.id.includes('search')) {
                        section.style.opacity = '0';
                        section.style.transform = 'translateY(10px)'; 
                        // Wait for fade before setting display: none
                        setTimeout(() => { section.style.display = 'none'; }, 500);
                    }
                });
                
                // Show search results container and fade it in
                searchResultsSection.style.opacity = '0';
                searchResultsSection.style.display = 'block';
                
                setTimeout(() => {
                    searchResultsSection.style.opacity = '1';
                }, 10);

            } else {
                // 2. Exiting Search Mode (Show Main Content)
                
                // Fade out search results container
                searchResultsSection.style.opacity = '0';
                
                // After the fade-out duration, complete the transition
                setTimeout(() => {
                    searchResultsSection.style.display = 'none';
                    
                    // Show main content & fade in smoothly using loadAllMainCategories logic
                    loadAllMainCategories();
                    
                    // Reveal Banner (triggers smooth transition back)
                    bannerContainer.classList.remove('hidden');
                }, 300); // 300ms for search fade-out
            }
        }
        
        /**
         * Loads all main category sections based on the currentMediaType with a fade transition.
         */
        function loadAllMainCategories() {
            const mainContentSections = document.querySelectorAll('.data-section');
            const sectionsToFade = Array.from(mainContentSections).filter(section => !section.id.includes('search'));

            // 1. Fade out the current content (if visible)
            sectionsToFade.forEach(section => {
                section.style.opacity = '0';
                section.style.transform = 'translateY(10px)'; // Optional slide effect
            });

            // Wait for the fade-out to finish (500ms matches the CSS transition)
            setTimeout(() => {
                
                // 2. Clear all containers and show spinners for main categories
                mainCategories.forEach(category => {
                    const container = document.getElementById(`movies-row-${category}`);
                    const section = document.getElementById(`section-${category}`);
                    
                    // Reset 'Now Playing' display status before loading
                    if (category === 'now-playing') {
                        section.style.display = (currentMediaType === 'movie' ? 'block' : 'none');
                    }
                    
                    if (container) {
                        // Ensure section is visible for the spinner to show before load (if not 'none')
                        if (section.style.display !== 'none') {
                           section.style.display = 'block'; 
                           container.innerHTML = `<div class="spinner-border text-primary m-4" role="status"><span class="visually-hidden">Loading ${category}...</span></div>`;
                        } else {
                           container.innerHTML = ''; // Ensure hidden sections are empty
                        }
                    }
                });

                // 3. Reload all categories
                let completedLoads = 0;
                // Only wait for the first page of *all* visible categories to ensure smooth fade-in
                const visibleCategories = mainCategories.filter(cat => cat !== 'now-playing' || currentMediaType === 'movie');
                const totalInitialLoads = visibleCategories.length;
                
                // Re-hide overlay message if it was shown during a slow load
                slowNetworkMessage.style.display = 'none';

                const checkCompletion = () => {
                    completedLoads++;
                    // Only fade back in when the first page of all visible categories is loaded
                    if (completedLoads >= totalInitialLoads) {
                         // 4. Fade back in
                        sectionsToFade.forEach(section => {
                            if (section.style.display !== 'none') { // Only fade in sections that are displayed
                                section.style.opacity = '1';
                                section.style.transform = 'translateY(0)';
                            }
                        });
                        
                        // Handle initial site load completion
                        if (!initialLoadComplete) {
                            initialLoadComplete = true;
                            clearTimeout(loadingTimer);
                            loadingOverlay.style.opacity = '0';
                            setTimeout(() => {
                                loadingOverlay.style.display = 'none';
                            }, 500);
                        }
                    }
                };
                
                mainCategories.forEach(category => {
                    // Reset page tracking
                    categoryPages[category] = 1; 
                    
                    // Do not load 'now-playing' if media type is 'tv'
                    if (category === 'now-playing' && currentMediaType === 'tv') return;

                    // Only load the first page and use its completion to trigger the fade-in
                    const loadPromise = loadTmdbCategory(category, 1).finally(() => {
                        // This counts towards the checkCompletion total
                        checkCompletion();
                    });

                    // Start pre-loading page 2 as soon as page 1 is requested
                    loadTmdbCategory(category, 2);
                    categoryPages[category] = 3; 
                });
                
                // Manually re-trigger scroll button visibility after load
                setTimeout(() => {
                     document.querySelectorAll('.data-section').forEach(section => {
                        const category = section.id.replace('section-', '');
                        const scrollContainer = document.getElementById(`movies-row-${category}`);
                        const prevBtn = document.getElementById(`prev-btn-${category}`);
                        const nextBtn = document.getElementById(`next-btn-${category}`);
                        if (scrollContainer && prevBtn) {
                             updateScrollButtonsVisibility(scrollContainer, prevBtn, nextBtn);
                        }
                    });
                }, 500);

            }, 500);
        }

        /**
         * Switches the global media type state, updates the button, and reloads content.
         */
        function toggleMediaType() {
            const newType = currentMediaType === 'movie' ? 'tv' : 'movie';
            
            // 1. Update Global State
            currentMediaType = newType;
            
            // 2. Update Button UI
            if (newType === 'movie') {
                mediaTypeText.textContent = 'Movies';
                mediaTypeButton.title = 'Switch to TV Shows';
            } else {
                mediaTypeText.textContent = 'TV Shows';
                mediaTypeButton.title = 'Switch to Movies';
            }
            
            // 3. Reload Content
            loadPopularBanner(newType); 
            loadAllMainCategories();
        }
        
        // Main function to load movie/TV show data for a category
        async function loadTmdbCategory(category, pageToLoad) {
            const moviesContainer = document.getElementById(`movies-row-${category}`);
            
            // Determine media type for the endpoint.
            const type = currentMediaType; 

            let endpoint = '';
            switch (category) {
                case 'popular':
                    endpoint = `/${type}/popular`;
                    break;
                case 'trending':
                    endpoint = `/trending/${type}/week`; 
                    break;
                case 'now-playing':
                    if (currentMediaType === 'tv') {
                        return;
                    } 
                    endpoint = '/movie/now_playing';
                    break;
                case 'top-rated': 
                    endpoint = `/${type}/top_rated`;
                    break;
                default:
                    console.error('Invalid category:', category);
                    return;
            }

            const url = `${TMDB_BASE_URL}${endpoint}?api_key=${TMDB_API_KEY}&page=${pageToLoad}`;

            try {
                const res = await fetch(url);
                if (!res.ok) throw new Error('Network response was not ok.');
                
                const data = await res.json();
                moviesContainer.dataset.totalPages = data.total_pages;

                // Clear only the loading/error message for the current container
                if (pageToLoad === 1) {
                    moviesContainer.innerHTML = ''; 
                }

                if (!data.results || data.results.length === 0) {
                    if (pageToLoad === 1) {
                        const emptyMessage = document.createElement('div');
                        emptyMessage.className = 'text-muted my-3 empty-or-error-message';
                        emptyMessage.textContent = `No ${type} items found for this category.`;
                        moviesContainer.appendChild(emptyMessage);
                    }
                } else {
                    const itemsHtml = data.results.map(item => {
                        // Use the type from the outer scope, which matches the endpoint used
                        const mediaType = type; 
                        
                        const title = item.title || item.name; 
                        const posterPath = item.poster_path ? `${TMDB_IMG_BASE_URL}${item.poster_path}` : 'https://via.placeholder.com/400x600?text=No+Image';
                        
                        let detailsUrl;
                        if (mediaType === 'tv') {
                            detailsUrl = `/show.html?${item.id}`; 
                        } else {
                            detailsUrl = `/player.html?${item.id}`;
                        }

                        return `
                            <div class="col">
                                <div class="movie-card" data-media-type="${mediaType}">
                                    <a href="${detailsUrl}" class="movie-link" title="${title.replace(/"/g, '&quot;')}">
                                        <img src="${posterPath}" class="movie-img" alt="${title.replace(/"/g, '&quot;')}" onerror="this.src='https://via.placeholder.com/400x600?text=No+Image'" loading="lazy">
                                        <div class="movie-title-text">${title}</div>
                                    </a>
                                </div>
                            </div>
                        `;
                    }).join('');
                    moviesContainer.insertAdjacentHTML('beforeend', itemsHtml);
                }
            } catch (error) {
                console.error(`Error loading content for ${category}:`, error);
                if (pageToLoad === 1) {
                    const errorMessage = document.createElement('div');
                    errorMessage.className = 'text-danger my-3 empty-or-error-message';
                    errorMessage.textContent = `Could not load ${category} items. Please try again later.`;
                    moviesContainer.appendChild(errorMessage);
                }
            } finally {
                if (moviesContainer) {
                    moviesContainer.dataset.isLoading = 'false';
                }
            }
        }
        
        // --- Initial Page Load and Event Binding (Modified to start with unlock check) ---
        document.addEventListener('DOMContentLoaded', function() {
            applyTheme(localStorage.getItem('theme') || 'system');
            updateLogoHeight();
            
            // --- START ACCESS CHECK ---
            const isUnlocked = localStorage.getItem('isUnlocked');
            
            if (isUnlocked === 'true') {
                showContent();
            } else {
                showUnlock();
            }
            
            // --- PIN INPUT EVENT LISTENERS (From player.html) ---
            inputs.forEach((input, index) => {
                input.addEventListener('keyup', (e) => {
                    if (e.key === 'Backspace' && input.value === '') {
                        if (index > 0) inputs[index - 1].focus();
                    }
                    checkInputs();
                });
                
                input.addEventListener('input', () => {
                    let value = input.value.replace(/[^0-9]/g, '').charAt(0);
                    input.value = value;
                    
                    if (input.value.length === 1 && index < inputs.length - 1) {
                        inputs[index + 1].focus();
                    } else if (index === inputs.length - 1) {
                         unlockButton.focus(); 
                    }
                    checkInputs();
                });
                
                input.addEventListener('paste', (e) => {
                    e.preventDefault();
                    const pasteCode = (e.clipboardData || window.clipboardData).getData('text').trim().replace(/[^0-9]/g, '').slice(0, 4);

                    for (let i = 0; i < pasteCode.length; i++) {
                        if (inputs[i]) inputs[i].value = pasteCode[i];
                    }

                    const lastFilledIndex = pasteCode.length > 0 ? pasteCode.length - 1 : 0;
                    if (inputs[lastFilledIndex + 1]) {
                        inputs[lastFilledIndex + 1].focus();
                    } else if (inputs[lastFilledIndex]) {
                        inputs[lastFilledIndex].blur();
                    }
                    checkInputs();
                });
            });

            unlockButton.addEventListener('click', () => {
                if (isLockedOut()) return;
                
                let enteredPin = Array.from(inputs).map(input => input.value).join('');

                if (enteredPin === CORRECT_PIN) {
                    // --- SUCCESS ---
                    localStorage.setItem('isUnlocked', 'true'); 
                    localStorage.setItem('premium_isUnlocked', 'true'); 
                    localStorage.setItem('attemptCount', '0');
                    localStorage.removeItem('lockoutTimestamp');
                    
                    showContent(); // Success leads to main content
                } else {
                    // --- FAILURE ---
                    let currentAttempts = parseInt(localStorage.getItem('attemptCount') || '0');
                    currentAttempts++;
                    localStorage.setItem('attemptCount', currentAttempts.toString());
                    
                    if (currentAttempts >= MAX_ATTEMPTS) {
                        localStorage.setItem('lockoutTimestamp', new Date().getTime().toString());
                        errorMessage.textContent = `Maximum attempts reached (${MAX_ATTEMPTS}). Access locked.`;
                        checkLockoutStatus(); 
                    } else {
                        const remaining = MAX_ATTEMPTS - currentAttempts;
                        errorMessage.textContent = `Incorrect PIN. ${remaining} attempts remaining.`;
                        errorMessage.style.display = 'block';
                    }
                    
                    inputs.forEach(input => input.value = '');
                    inputs[0].focus();
                    unlockButton.disabled = true;
                }
            });
            // --- END ACCESS CHECK LOGIC ---


            // --- REMAINING EVENT LISTENERS (Kept from beta.html) ---

            if (window.matchMedia) {
                window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
                    if (!localStorage.getItem('theme')) {
                        applyTheme('system');
                    }
                });
            }
            
            themeOptions.forEach(option => {
                option.addEventListener('click', (event) => {
                    event.preventDefault();
                    applyTheme(event.currentTarget.dataset.theme);
                });
            });
            
            document.getElementById('aboutButton').addEventListener('click', function (event) {
                event.preventDefault();
                const aboutModal = new bootstrap.Modal(document.getElementById('aboutModal'));
                aboutModal.show();
            });
            
            // --- SEARCH EVENT LISTENERS (Updated to call toggleContentDisplay) ---
            const searchForm = document.getElementById('searchForm');
            const searchInput = document.getElementById('searchInput');

            if (searchForm) {
                searchForm.addEventListener('submit', (e) => {
                    e.preventDefault(); 
                    const searchQuery = searchInput.value.trim();
                    if (searchQuery === '') {
                        searchInput.classList.add('highlight-red');
                        searchInput.focus();
                    } else {
                        searchInput.classList.remove('highlight-red');
                        handleSearch(searchQuery);
                    }
                });
            }

            if (searchInput) {
                searchInput.addEventListener('input', () => {
                    if (searchInput.value.trim() !== '') {
                        searchInput.classList.remove('highlight-red');
                    }
                });
            }

            if (backToMainBtn) {
                backToMainBtn.addEventListener('click', () => {
                    toggleContentDisplay(false); // Show main content & banner
                    searchInput.value = ''; // Clear search input
                });
            }
            
            // --- NEW: MEDIA TYPE TOGGLE LISTENER ---
            if (mediaTypeButton) {
                mediaTypeButton.addEventListener('click', toggleMediaType);
            }

            // --- SCROLL BUTTON LISTENERS (Modified to use new mainCategories list) ---
            const scrollButtons = document.querySelectorAll('.scroll-btn');
            scrollButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const category = button.id.split('-').pop();
                    const scrollContainer = document.getElementById(`movies-row-${category}`);
                    if (!scrollContainer) return;

                    const movieCard = scrollContainer.querySelector('.movie-card');
                    if (!movieCard) return;
                    const movieCardWidth = movieCard.offsetWidth;
                    const scrollAmount = movieCardWidth * 3 + (16 * 3); 

                    if (button.classList.contains('scroll-btn-prev')) {
                        scrollContainer.scrollBy({ left: -scrollAmount, behavior: 'smooth' });
                    } 
                    else if (button.classList.contains('scroll-btn-next')) {
                        scrollContainer.scrollBy({ left: scrollAmount, behavior: 'smooth' });

                        const isNearEnd = scrollContainer.scrollLeft + scrollContainer.clientWidth >= scrollContainer.scrollWidth - (scrollAmount * 2);
                        const isLoading = scrollContainer.dataset.isLoading === 'true';
                        const nextPageToLoad = categoryPages[category];
                        const totalPages = parseInt(scrollContainer.dataset.totalPages || '999');

                        if (isNearEnd && !isLoading && nextPageToLoad <= totalPages) {
                            scrollContainer.dataset.isLoading = 'true';
                            loadTmdbCategory(category, nextPageToLoad).then(() => {
                                categoryPages[category]++;
                            });
                        }
                    }
                });
            });

            const categorySections = document.querySelectorAll('.data-section');
            categorySections.forEach(section => {
                const category = section.id.replace('section-', '');
                const scrollContainer = document.getElementById(`movies-row-${category}`);
                const prevBtn = document.getElementById(`prev-btn-${category}`);
                const nextBtn = document.getElementById(`next-btn-${category}`);

                if (scrollContainer) {
                    updateScrollButtonsVisibility(scrollContainer, prevBtn, nextBtn);
                    scrollContainer.addEventListener('scroll', () => {
                        updateScrollButtonsVisibility(scrollContainer, prevBtn, nextBtn);
                    });

                    const observer = new MutationObserver(() => {
                        updateScrollButtonsVisibility(scrollContainer, prevBtn, nextBtn);
                    });
                    observer.observe(scrollContainer, { childList: true });
                }
            });
            
            // Check for initial query parameter on page load (optional)
            const urlParams = new URLSearchParams(window.location.search);
            const initialQuery = urlParams.get('q');
            if (initialQuery) {
                searchInput.value = initialQuery;
                // Only search if already unlocked
                if (localStorage.getItem('isUnlocked') === 'true') {
                     handleSearch(initialQuery);
                }
            }
        });
        
        // --- BANNER & SEARCH RESULTS RENDERERS (Unchanged logic) ---

        /**
         * Renders the search results into the appropriate rows.
         */
        function renderSearchResults(items, type) {
            const container = type === 'movie' ? searchMoviesRow : searchTvRow;
            const section = type === 'movie' ? document.getElementById('section-search-movies') : document.getElementById('section-search-tv');
            
            container.innerHTML = ''; // Clear previous results
            
            if (items.length === 0) {
                // If no results, hide the entire section
                section.style.display = 'none';
                return;
            }

            // If results exist, ensure the section is visible
            section.style.display = 'block';

            const itemsHtml = items.map(item => {
                const title = item.title || item.name; 
                const posterPath = item.poster_path ? `${TMDB_IMG_BASE_URL}${item.poster_path}` : 'https://via.placeholder.com/400x600?text=No+Image';
                
                // Use the correct detail page based on media type
                const detailsUrl = type === 'tv' ? `/show.html?${item.id}` : `/player.html?${item.id}`;

                return `
                    <div class="col">
                        <div class="movie-card" data-media-type="${type}">
                            <a href="${detailsUrl}" class="movie-link" title="${title.replace(/"/g, '&quot;')}">
                                <img src="${posterPath}" class="movie-img" alt="${title.replace(/"/g, '&quot;')}" onerror="this.src='https://via.placeholder.com/400x600?text=No+Image'" loading="lazy">
                                <div class="movie-title-text">${title}</div>
                            </a>
                        </div>
                    </div>
                `;
            }).join('');
            
            container.insertAdjacentHTML('beforeend', itemsHtml);
        }

        async function handleSearch(query) {
            searchQueryDisplay.textContent = query;
            toggleContentDisplay(true); // Show search results container & hide main sections + banner

            // Clear previous results and show loading spinners
            searchMoviesRow.innerHTML = `<div class="spinner-border text-primary m-4" role="status"><span class="visually-hidden">Loading Movies...</span></div>`;
            searchTvRow.innerHTML = `<div class="spinner-border text-primary m-4" role="status"><span class="visually-hidden">Loading TV Shows...</span></div>`;

            // Use search/multi to get both movies and TV shows
            const url = `${TMDB_BASE_URL}/search/multi?api_key=${TMDB_API_KEY}&query=${encodeURIComponent(query)}`;

            try {
                const res = await fetch(url);
                if (!res.ok) throw new Error('Search API failed.');
                
                const data = await res.json();
                
                // Filter results by media_type AND ensure they have a poster_path
                const movieResults = data.results.filter(item => item.media_type === 'movie' && item.poster_path);
                const tvResults = data.results.filter(item => item.media_type === 'tv' && item.poster_path);

                renderSearchResults(movieResults, 'movie');
                renderSearchResults(tvResults, 'tv');

            } catch (error) {
                console.error('Error during multi-search:', error);
                searchMoviesRow.innerHTML = `<div class="text-danger m-4">Error loading movie results.</div>`;
                searchTvRow.innerHTML = `<div class="text-danger m-4">Error loading TV show results.</div>`;
            }
        }
        
        /**
         * Loads the popular banner for the specified media type.
         * @param {string} type - 'movie' or 'tv'.
         */
        async function loadPopularBanner(type = 'movie') {
            const indicatorsContainer = document.getElementById('slider-indicators');
            const innerContainer = document.getElementById('slider-inner');
            
            const endpoint = `/${type}/popular`; 
            const url = `${TMDB_BASE_URL}${endpoint}?api_key=${TMDB_API_KEY}&page=1`;

            try {
                const res = await fetch(url);
                if (!res.ok) throw new Error('Failed to fetch banner data');
                const data = await res.json();
                
                const topItems = data.results.filter(item => item.backdrop_path).slice(0, 5);

                if (topItems.length === 0) {
                     innerContainer.innerHTML = `<div class="carousel-item active" style="background-color: var(--card-bg-color);"><div class="carousel-caption"><h3>No popular ${type} content found.</h3></div></div>`;
                     return;
                }

                let indicatorsHtml = '';
                let innerHtml = '';

                topItems.forEach((item, index) => {
                    const isActive = index === 0 ? 'active' : '';
                    const title = item.title || item.name;
                    const backdropUrl = `${TMDB_BACKDROP_BASE_URL}${item.backdrop_path}`;
                    
                    // Determine the correct detail URL based on the media type
                    const playerUrl = type === 'tv' ? `/show.html?${item.id}` : `/player.html?${item.id}`;

                    // Add indicator
                    indicatorsHtml += `
                        <button type="button" data-bs-target="#popularSlider" data-bs-slide-to="${index}" class="${isActive}" aria-current="${isActive ? 'true' : 'false'}" aria-label="Slide ${index + 1}"></button>
                    `;

                    // Add slide
                    innerHtml += `
                        <div class="carousel-item ${isActive}" style="background-image: url('${backdropUrl}')">
                            <div class="carousel-caption">
                                <h3>${title}</h3>
                                <a href="${playerUrl}" class="btn">
                                    <i class="bi bi-play-fill"></i> Watch Now
                                </a>
                            </div>
                        </div>
                    `;
                });

                indicatorsContainer.innerHTML = indicatorsHtml;
                innerContainer.innerHTML = innerHtml;

            } catch (error) {
                console.error('Error loading popular banner:', error);
                innerContainer.innerHTML = `<div class="carousel-item active" style="background-color: var(--card-bg-color);"><div class="carousel-caption"><h3>Could not load popular content.</h3></div></div>`;
            }
        }
    </script>
</body>
</html>
