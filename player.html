<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Thirai - Video Player</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"/>
    <style>
        /* --- BASE STYLES --- */
        body, html {
            margin: 0;
            padding: 0;
            overflow: hidden; 
            height: 100%;
            width: 100%;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #000;
            color: #e0e0e0;
        }

        /* --- CONTROLS OVERLAY (Header) --- */
        /* This container holds both the back button and the server switcher */
        .controls-layer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            padding: 20px;
            box-sizing: border-box;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            z-index: 1001;
            background: linear-gradient(to bottom, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0) 100%);
            opacity: 1;
            transition: opacity 0.5s ease-in-out, transform 0.3s ease;
            pointer-events: auto; /* Allow clicking buttons */
        }

        /* Hide controls when AFK */
        .controls-layer.afk-fade {
            opacity: 0; 
            pointer-events: none;
        }

        /* --- BACK BUTTON --- */
        .back-button {
            font-size: 20px;
            text-decoration: none;
            cursor: pointer;
            padding: 10px 15px;
            border-radius: 8px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background-color: rgba(255, 255, 255, 0.1); 
            backdrop-filter: blur(5px);
            color: #ffffff;
            border: 1px solid rgba(255,255,255,0.1);
            transition: all 0.2s ease;
        }

        .back-button:hover {
            background-color: rgba(255, 255, 255, 0.2);
            transform: scale(1.05);
        }

        /* --- SERVER SWITCHER --- */
        .server-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: flex-end;
            max-width: 70%;
        }

        .server-btn {
            background-color: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #aaa;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            transition: all 0.2s ease;
            text-transform: capitalize;
        }

        .server-btn:hover {
            background-color: rgba(255, 255, 255, 0.15);
            color: #fff;
        }

        .server-btn.active {
            background-color: #0d6efd; /* Blue accent */
            color: white;
            border-color: #0d6efd;
            box-shadow: 0 0 10px rgba(13, 110, 253, 0.4);
        }

        /* --- UNLOCK SCREEN --- */
        #unlock-screen {
            display: none; 
            justify-content: center;
            align-items: center;
            height: 100vh;
            width: 100%;
            flex-direction: column;
            position: absolute; 
            top: 0; left: 0;
            background-color: #121212;
            z-index: 2000; /* Above controls */
        }
        
        .container {
            text-align: center;
            background-color: #1a1a1a;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.7);
            max-width: 90%;
            width: 400px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        #logo {
            max-width: 175px;
            margin-bottom: 20px;
        }

        #unlock-screen h2 {
            color: #ffffff;
            margin-bottom: 20px;
            font-weight: 400;
        }

        .code-input-container {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-bottom: 30px;
        }

        .code-input {
            width: 45px;
            height: 55px;
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            color: #fff;
            background-color: #2c2c2c;
            border: 2px solid #3d3d3d;
            border-radius: 8px;
            outline: none;
            transition: all 0.3s ease;
        }
        
        .code-input:focus {
            border-color: #0d6efd;
            background-color: #333;
            transform: translateY(-2px);
        }

        .join-button {
            width: 100%;
            padding: 14px;
            background-color: #0d6efd;
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease;
            margin-bottom: 20px;
        }
        
        .join-button:hover {
            background-color: #0b5ed7;
        }

        .join-button:disabled {
            background-color: #444;
            color: #888;
            cursor: not-allowed;
        }

        #error-message {
            color: #ff6b6b;
            font-size: 0.9em;
            display: none;
            margin-top: 10px;
        }
        
        /* --- PLAYER AREA --- */
        #player-screen {
            width: 100vw;
            height: 100vh;
            background: #000;
            display: flex; 
            flex-direction: column; 
            justify-content: center;
            align-items: center;
        }
        
        #movie-iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        
        #player-error {
            color: #ff6b6b;
            font-size: 1.2em;
            text-align: center;
            padding: 20px;
        }
    </style>
</head>
<body>
    
    <div class="controls-layer" id="controlsLayer">
        <a href="javascript:history.back()" class="back-button" aria-label="Go back">
            <i class="bi bi-arrow-left"></i> &nbsp; Back
        </a>

        <div class="server-list" id="serverList">
            </div>
    </div>
    
    <div id="unlock-screen">
        <div class="container">
            <img id="logo" src="./static/thiraiwhite.png" alt="Thirai Logo"> 
            <h2>Enter PIN</h2>
            <div class="code-input-container" id="codeInputContainer">
                <input type="text" class="code-input" id="code1" maxlength="1" pattern="[0-9]" inputmode="numeric" autocomplete="off">
                <input type="text" class="code-input" id="code2" maxlength="1" pattern="[0-9]" inputmode="numeric" autocomplete="off">
                <input type="text" class="code-input" id="code3" maxlength="1" pattern="[0-9]" inputmode="numeric" autocomplete="off">
                <input type="text" class="code-input" id="code4" maxlength="1" pattern="[0-9]" inputmode="numeric" autocomplete="off">
            </div>
            <button class="join-button" id="unlockButton" disabled>Unlock</button>
            <div id="error-message"></div>
        </div>
    </div>

    <div id="player-screen">
        <p>Initializing Player...</p>
    </div>

    <script>
        (function() { 
            // --- CONSTANTS ---
            const CORRECT_PIN = "1451"; 
            const MAX_ATTEMPTS = 5;
            const LOCKOUT_DURATION_MS = 15 * 60 * 1000; 
            const AFK_TIMEOUT_MS = 3000; 
            const TV_PREFIX = 'tv=';

            // --- SERVERS CONFIGURATION ---
            // Mapping names to IDs for the UI
            const SERVERS = [
                { id: 1, name: "Rakan" },
                { id: 2, name: "Bard" },
                { id: 3, name: "Xayah" },
                { id: 4, name: "Ekko" },
                { id: 5, name: "Naafiri" },
                { id: 6, name: "Ryze" }
            ];

            // --- DOM ELEMENTS ---
            const unlockScreen = document.getElementById('unlock-screen');
            const playerScreen = document.getElementById('player-screen');
            const inputs = document.querySelectorAll('.code-input');
            const unlockButton = document.getElementById('unlockButton');
            const errorMessage = document.getElementById('error-message');
            const controlsLayer = document.getElementById('controlsLayer');
            const serverList = document.getElementById('serverList');
            const logo = document.getElementById('logo'); 

            let lockoutInterval = null;
            let afkTimer; 
            
            // Current Video State
            let currentParams = {
                type: null, // 'movie' or 'tv'
                id: null,
                season: null,
                episode: null
            };

            // =================================================================
            // === 1. USER ACTIVITY & UI FADING ================================
            // =================================================================

            function hideControls() {
                if (playerScreen.style.display !== 'none') {
                     controlsLayer.classList.add('afk-fade');
                }
            }

            function showControls() {
                controlsLayer.classList.remove('afk-fade');
                clearTimeout(afkTimer);
                if (playerScreen.style.display !== 'none') {
                    afkTimer = setTimeout(hideControls, AFK_TIMEOUT_MS);
                }
            }
            
            function handleUserActivity() {
                showControls();
            }

            // =================================================================
            // === 2. URL PARSING & SERVER LOGIC ===============================
            // =================================================================

            function displayPlayerError(message) {
                playerScreen.innerHTML = `<h1>Error</h1><p id="player-error">${message}</p>`;
            }

            function parseUrl() {
                const queryString = window.location.search.substring(1);
                
                if (!queryString) {
                    return false;
                }

                if (queryString.startsWith(TV_PREFIX)) {
                    // TV Format: ?tv=ID/SEASON/EPISODE
                    currentParams.type = 'tv';
                    const tvDetails = queryString.substring(TV_PREFIX.length); 
                    const parts = tvDetails.split('/'); 

                    if (parts.length === 3 && parts.every(p => p)) {
                        currentParams.id = parts[0];
                        currentParams.season = parts[1];
                        currentParams.episode = parts[2];
                        return true;
                    } 
                } else {
                    // Movie Format: ?ID
                    currentParams.type = 'movie';
                    currentParams.id = queryString;
                    if (currentParams.id) return true;
                }
                return false;
            }

            function getEmbedUrl(serverNumber, params) {
                let src = "";
                
                if (params.type === 'movie') {
                    switch (serverNumber) {
                        case 1: src = `https://vidsrc.cc/v2/embed/movie/${params.id}?autoPlay=false`; break; // Rakan
                        case 2: src = `https://moviesapi.club/movie/${params.id}`; break; // Bard
                        case 3: src = `https://vidsrc.me/embed/movie?tmdb=${params.id}`; break; // Xayah
                        case 4: src = `https://player.videasy.net/movie/${params.id}`; break; // Ekko
                        case 5: src = `https://vidfast.pro/movie/${params.id}`; break; // Naafiri
                        case 6: src = `https://vidlink.pro/movie/${params.id}?title=true&poster=true&autoplay=false`; break; // Ryze
                    }
                } else if (params.type === 'tv') {
                    switch (serverNumber) {
                        case 1: src = `https://vidsrc.cc/v2/embed/tv/${params.id}/${params.season}/${params.episode}?autoPlay=false`; break; // Rakan
                        case 2: src = `https://moviesapi.club/tv/${params.id}-${params.season}-${params.episode}`; break; // Bard
                        case 3: src = `https://vidsrc.me/embed/tv?tmdb=${params.id}&season=${params.season}&episode=${params.episode}`; break; // Xayah
                        case 4: src = `https://player.videasy.net/tv/${params.id}/${params.season}/${params.episode}?nextEpisode=true&episodeSelector=true`; break; // Ekko
                        case 5: src = `https://vidfast.pro/tv/${params.id}/${params.season}/${params.episode}`; break; // Naafiri
                        case 6: src = `https://vidlink.pro/tv/${params.id}/${params.season}/${params.episode}?title=true&poster=true&autoplay=false&nextbutton=true`; break; // Ryze
                    }
                }
                return src;
            }

            function loadServer(serverNumber) {
                // Save preference
                localStorage.setItem('preferredServer', serverNumber);

                // Update UI Buttons
                document.querySelectorAll('.server-btn').forEach(btn => {
                    btn.classList.remove('active');
                    if (parseInt(btn.dataset.server) === serverNumber) {
                        btn.classList.add('active');
                    }
                });

                const embedSrc = getEmbedUrl(serverNumber, currentParams);
                
                if (embedSrc) {
                    const iframe = document.createElement('iframe');
                    iframe.setAttribute('id', 'movie-iframe');
                    iframe.setAttribute('src', embedSrc);
                    iframe.setAttribute('allowfullscreen', 'true');
                    // Allow necessary scripts for these providers
                    iframe.setAttribute('sandbox', 'allow-scripts allow-same-origin allow-forms allow-presentation');
                    
                    playerScreen.innerHTML = '';
                    playerScreen.appendChild(iframe);
                    console.log(`Loaded ${currentParams.type} on Server ${serverNumber} (${SERVERS[serverNumber-1].name})`);
                } else {
                    displayPlayerError("Could not generate stream URL.");
                }
            }

            function initPlayer() {
                const isValid = parseUrl();
                if (!isValid) {
                    displayPlayerError('Invalid URL format.<br>Movie: <code>?12345</code><br>TV: <code>?tv=12345/1/1</code>');
                    return;
                }

                // Create Server Buttons
                serverList.innerHTML = '';
                SERVERS.forEach(server => {
                    const btn = document.createElement('div');
                    btn.className = 'server-btn';
                    btn.textContent = server.name;
                    btn.dataset.server = server.id;
                    btn.addEventListener('click', () => loadServer(server.id));
                    serverList.appendChild(btn);
                });

                // Load preferred server or default to 1 (Rakan)
                const savedServer = parseInt(localStorage.getItem('preferredServer') || '1');
                loadServer(savedServer);
            }

            // =================================================================
            // === 3. UNLOCK LOGIC (Standard) ==================================
            // =================================================================
            
            function showPlayer() {
                unlockScreen.style.display = 'none';
                playerScreen.style.display = 'flex';
                controlsLayer.style.display = 'flex'; // Show controls
                
                initPlayer();
                showControls(); 
            }

            function showUnlock() {
                playerScreen.style.display = 'none';
                controlsLayer.style.display = 'none'; // Hide controls on lock screen
                unlockScreen.style.display = 'flex';
                checkLockoutStatus();
            }
            
            function checkInputs() {
                let allFilled = true;
                inputs.forEach(input => {
                    if (input.value.length === 0 || !/^\d$/.test(input.value)) {
                        allFilled = false;
                    }
                });
                const isLocked = isLockedOut();
                unlockButton.disabled = !allFilled || isLocked;
                
                if (allFilled && !isLocked) errorMessage.style.display = 'none';
            }
            
            function isLockedOut() {
                const lockoutTimestamp = localStorage.getItem('lockoutTimestamp');
                if (lockoutTimestamp) {
                    const now = new Date().getTime();
                    const lockoutEnd = parseInt(lockoutTimestamp) + LOCKOUT_DURATION_MS;
                    
                    if (now < lockoutEnd) {
                        const remainingTimeMs = lockoutEnd - now;
                        const totalSeconds = Math.ceil(remainingTimeMs / 1000);
                        const remainingMinutes = Math.floor(totalSeconds / 60);
                        const remainingSeconds = totalSeconds % 60;
                        errorMessage.textContent = `Too many failed attempts. Try again in ${remainingMinutes}:${remainingSeconds.toString().padStart(2, '0')}.`;
                        errorMessage.style.display = 'block';
                        return true;
                    } else {
                        localStorage.removeItem('lockoutTimestamp');
                        localStorage.setItem('attemptCount', '0');
                        clearInterval(lockoutInterval);
                        lockoutInterval = null;
                        errorMessage.style.display = 'none';
                        return false;
                    }
                }
                return false;
            }
            
            function checkLockoutStatus() {
                if (isLockedOut()) {
                    unlockButton.disabled = true;
                    if (!lockoutInterval) lockoutInterval = setInterval(checkLockoutStatus, 1000); 
                } else {
                    if (lockoutInterval) { clearInterval(lockoutInterval); lockoutInterval = null; }
                    checkInputs(); 
                }
            }

            // --- Event Listeners for Input ---
            inputs.forEach((input, index) => {
                input.addEventListener('keyup', (e) => {
                    if (e.key === 'Backspace' && input.value === '') {
                        if (index > 0) inputs[index - 1].focus();
                    }
                    checkInputs();
                });
                input.addEventListener('input', () => {
                    let value = input.value.replace(/[^0-9]/g, '').charAt(0);
                    input.value = value;
                    if (input.value.length === 1 && index < inputs.length - 1) {
                        inputs[index + 1].focus();
                    } else if (index === inputs.length - 1) {
                         unlockButton.focus(); 
                    }
                    checkInputs();
                });
                input.addEventListener('paste', (e) => {
                    e.preventDefault();
                    const pasteCode = (e.clipboardData || window.clipboardData).getData('text').trim().replace(/[^0-9]/g, '').slice(0, 4);
                    for (let i = 0; i < pasteCode.length; i++) if (inputs[i]) inputs[i].value = pasteCode[i];
                    checkInputs();
                });
            });

            unlockButton.addEventListener('click', () => {
                if (isLockedOut()) return;
                let enteredPin = Array.from(inputs).map(input => input.value).join('');

                if (enteredPin === CORRECT_PIN) {
                    localStorage.setItem('isUnlocked', 'true'); 
                    localStorage.setItem('attemptCount', '0');
                    localStorage.removeItem('lockoutTimestamp');
                    showPlayer();
                } else {
                    let currentAttempts = parseInt(localStorage.getItem('attemptCount') || '0');
                    currentAttempts++;
                    localStorage.setItem('attemptCount', currentAttempts.toString());
                    
                    if (currentAttempts >= MAX_ATTEMPTS) {
                        localStorage.setItem('lockoutTimestamp', new Date().getTime().toString());
                        errorMessage.textContent = `Access locked.`;
                        checkLockoutStatus(); 
                    } else {
                        errorMessage.textContent = `Incorrect PIN. ${MAX_ATTEMPTS - currentAttempts} attempts remaining.`;
                        errorMessage.style.display = 'block';
                    }
                    inputs.forEach(input => input.value = '');
                    inputs[0].focus();
                    unlockButton.disabled = true;
                }
            });
            
            // =================================================================
            // === 4. INITIALIZATION ===========================================
            // =================================================================

            document.addEventListener('DOMContentLoaded', () => {
                const isUnlocked = localStorage.getItem('isUnlocked');
                
                if (isUnlocked === 'true') {
                    showPlayer();
                } else {
                    showUnlock();
                }

                // Global Activity Listeners
                document.addEventListener('mousemove', handleUserActivity);
                document.addEventListener('keypress', handleUserActivity);
                document.addEventListener('click', handleUserActivity);
                document.addEventListener('touchstart', handleUserActivity);
            });
        })();
    </script>
</body>
</html>
