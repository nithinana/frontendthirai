<!DOCTYPE html>
<html lang="en">
<head>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-HKV7GQ766F"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-HKV7GQ766F');

        const ORIGINAL_SEARCH_PARAMS = window.location.search;
        (function() {
            const urlParams = new URLSearchParams(window.location.search);
            const movieCode = urlParams.get('film');
            if (movieCode) {
                const formID = "1FAIpQLSeg_JCKjxY_5W977CB5-hFqLpemBCw_o477qV-6vlDKFFJ_VQ";
                const entryID = "entry.132457679"; 
                const finalURL = `https://docs.google.com/forms/d/e/${formID}/formResponse?${entryID}=${encodeURIComponent(movieCode)}&submit=Submit`;
                if (navigator.sendBeacon) { navigator.sendBeacon(finalURL); } 
                else { fetch(finalURL, { mode: 'no-cors' }); }
            }
        })();
    </script>

    <script src="https://www.gstatic.com/cv/js/sender/v1/cast_sender.js?loadCastFramework=1"></script>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Thirai Pro Player</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"/>
    
    <style>
        html, body {
            margin: 0; padding: 0; width: 100%; height: 100%;
            overflow: hidden; background-color: black;
            font-family: 'Inter', sans-serif; color: white;
            -webkit-user-select: none; user-select: none;
        }

        .video-player-wrapper {
            position: relative; width: 100%; height: 100%;
            display: flex; justify-content: center; align-items: center;
        }

        #moviePlayer {
            width: 100%; height: 100%; object-fit: contain;
            transition: transform 0.3s ease;
        }

        /* Controls Overlay */
        .custom-controls-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: space-between;
            background: linear-gradient(to bottom, rgba(0,0,0,0.7) 0%, transparent 20%, transparent 80%, rgba(0,0,0,0.7) 100%);
            opacity: 0; transition: opacity 0.3s ease; z-index: 10; pointer-events: none;
        }
        .custom-controls-overlay.visible { opacity: 1; pointer-events: auto; }

        .top-controls, .bottom-controls { padding: 1.5rem; display: flex; align-items: center; gap: 1rem; }
        .center-controls { display: flex; align-items: center; gap: 2rem; align-self: center; }

        .control-button, .top-button {
            background: rgba(255, 255, 255, 0.15); border: none; color: white;
            cursor: pointer; border-radius: 50%; display: flex; align-items: center;
            justify-content: center; transition: all 0.2s;
        }
        .control-button { width: 50px; height: 50px; font-size: 1.5rem; }
        #playPauseButton { width: 80px; height: 80px; font-size: 3rem; background: rgba(255,255,255,0.25); }
        .top-button { background: transparent; border-radius: 8px; padding: 10px; font-size: 1.4rem; }
        .control-button:hover, .top-button:hover { background: rgba(255,255,255,0.3); }

        /* Progress Bar */
        .progress-container { flex-grow: 1; height: 6px; background: rgba(255,255,255,0.2); border-radius: 3px; position: relative; cursor: pointer; }
        .progress-filled { height: 100%; background: #0d6efd; width: 0%; border-radius: 3px; }
        .ab-loop-marker { position: absolute; height: 12px; width: 4px; background: orange; top: -3px; display: none; }

        /* Advanced Settings Menu */
        #settingsMenu {
            position: absolute; right: 20px; bottom: 80px;
            background: rgba(20, 20, 20, 0.95); border-radius: 12px;
            padding: 15px; width: 250px; display: none; flex-direction: column; gap: 10px;
            border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .setting-item { display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem; }
        .setting-item select, .setting-item input { background: #333; color: white; border: none; padding: 4px; border-radius: 4px; }

        /* Nerd Stats Overlay */
        #nerdStats {
            position: absolute; top: 70px; left: 20px;
            background: rgba(0,0,0,0.8); padding: 10px; border-radius: 8px;
            font-family: monospace; font-size: 0.75rem; display: none; pointer-events: none;
        }

        /* Subtitle Styling Overlay */
        #subtitleTrack {
            position: absolute; bottom: 15%; width: 100%; text-align: center;
            pointer-events: none; transition: all 0.2s;
        }
        #subtitleText {
            display: inline-block; padding: 5px 15px; background: rgba(0,0,0,0.7);
            border-radius: 4px; font-size: 1.5rem; color: #fff;
        }
    </style>
</head>
<body>

    <div class="video-player-wrapper" id="videoPlayerWrapper">
        <video id="moviePlayer" playsinline preload="auto" autoplay></video>
        
        <div id="nerdStats">
            Bitrate: <span id="stat-bitrate">0</span> kbps<br>
            Dropped Frames: <span id="stat-dropped">0</span><br>
            Resolution: <span id="stat-res">0x0</span><br>
            Buffer: <span id="stat-buffer">0</span>s
        </div>

        <div id="subtitleTrack"><span id="subtitleText" style="display:none;"></span></div>

        <div class="custom-controls-overlay" id="controls">
            <div class="top-controls">
                <button class="top-button" id="backBtn"><i class="bi bi-arrow-left"></i></button>
                <div id="title" style="flex-grow:1; text-align:center; font-weight:bold;">Thirai Pro</div>
                <button class="top-button" id="nerdBtn"><i class="bi bi-info-circle"></i></button>
                <button class="top-button" id="magnifyBtn"><i class="bi bi-zoom-in"></i></button>
            </div>

            <div class="center-controls">
                <button class="control-button" id="prevFrame" title="Prev Frame"><i class="bi bi-chevron-left"></i></button>
                <button class="control-button" id="rwBtn"><i class="bi bi-arrow-counterclockwise"></i></button>
                <button id="playPauseButton" class="control-button"><i class="bi bi-play-fill"></i></button>
                <button class="control-button" id="ffBtn"><i class="bi bi-arrow-clockwise"></i></button>
                <button class="control-button" id="nextFrame" title="Next Frame"><i class="bi bi-chevron-right"></i></button>
            </div>

            <div class="bottom-controls">
                <span id="currentTime">00:00</span>
                <div class="progress-container" id="progressRoot">
                    <div class="progress-filled" id="progressBar"></div>
                    <div id="markerA" class="ab-loop-marker"></div>
                    <div id="markerB" class="ab-loop-marker"></div>
                </div>
                <span id="totalTime">00:00</span>
                <button class="top-button" id="abLoopBtn" title="Set A-B Loop"><i class="bi bi-repeat"></i></button>
                <button class="top-button" id="settingsBtn"><i class="bi bi-gear-fill"></i></button>
                <button class="top-button" id="fsBtn"><i class="bi bi-arrows-fullscreen"></i></button>
            </div>

            <div id="settingsMenu">
                <div class="setting-item">
                    <span>Playback Speed</span>
                    <select id="speedSel">
                        <option value="0.5">0.5x</option><option value="1" selected>Normal</option>
                        <option value="1.25">1.25x</option><option value="1.5">1.5x</option>
                        <option value="2">2x</option>
                    </select>
                </div>
                <div class="setting-item">
                    <span>A-V Sync (ms)</span>
                    <input type="number" id="avSync" value="0" step="50" style="width:60px;">
                </div>
                <div class="setting-item">
                    <span>Sub Size</span>
                    <input type="range" id="subSize" min="16" max="48" value="24">
                </div>
            </div>
        </div>
    </div>

    <script>
        const player = document.getElementById('moviePlayer');
        const controls = document.getElementById('controls');
        const settingsMenu = document.getElementById('settingsMenu');
        const nerdStats = document.getElementById('nerdStats');
        
        let loopA = null, loopB = null;
        let zoom = 1;

        // --- Core Playback ---
        document.getElementById('playPauseButton').onclick = () => {
            player.paused ? player.play() : player.pause();
        };

        player.onplay = () => document.querySelector('#playPauseButton i').className = 'bi bi-pause-fill';
        player.onpause = () => document.querySelector('#playPauseButton i').className = 'bi bi-play-fill';

        // --- Frame Stepping (assuming 24fps) ---
        document.getElementById('nextFrame').onclick = () => { player.pause(); player.currentTime += (1/24); };
        document.getElementById('prevFrame').onclick = () => { player.pause(); player.currentTime -= (1/24); };

        // --- A-B Looping Logic ---
        document.getElementById('abLoopBtn').onclick = function() {
            if (loopA === null) {
                loopA = player.currentTime;
                document.getElementById('markerA').style.left = (loopA / player.duration * 100) + '%';
                document.getElementById('markerA').style.display = 'block';
                this.style.color = '#0d6efd';
            } else if (loopB === null) {
                loopB = player.currentTime;
                document.getElementById('markerB').style.left = (loopB / player.duration * 100) + '%';
                document.getElementById('markerB').style.display = 'block';
                this.style.color = 'orange';
            } else {
                loopA = null; loopB = null;
                document.getElementById('markerA').style.display = 'none';
                document.getElementById('markerB').style.display = 'none';
                this.style.color = 'white';
            }
        };

        player.ontimeupdate = () => {
            const p = (player.currentTime / player.duration) * 100;
            document.getElementById('progressBar').style.width = p + '%';
            document.getElementById('currentTime').innerText = formatTime(player.currentTime);
            document.getElementById('totalTime').innerText = formatTime(player.duration);

            if (loopA !== null && loopB !== null && player.currentTime >= loopB) {
                player.currentTime = loopA;
            }

            // Update Nerd Stats
            if (nerdStats.style.display === 'block') {
                document.getElementById('stat-res').innerText = `${player.videoWidth}x${player.videoHeight}`;
                document.getElementById('stat-buffer').innerText = player.buffered.length ? 
                    (player.buffered.end(player.buffered.length-1) - player.currentTime).toFixed(2) : 0;
            }
        };

        // --- UI Interactions ---
        document.getElementById('settingsBtn').onclick = (e) => {
            e.stopPropagation();
            settingsMenu.style.display = settingsMenu.style.display === 'flex' ? 'none' : 'flex';
        };

        document.getElementById('nerdBtn').onclick = () => {
            nerdStats.style.display = nerdStats.style.display === 'block' ? 'none' : 'block';
        };

        document.getElementById('magnifyBtn').onclick = () => {
            zoom = zoom === 1 ? 1.3 : (zoom === 1.3 ? 0.8 : 1);
            player.style.transform = `scale(${zoom})`;
        };

        document.getElementById('speedSel').onchange = (e) => player.playbackRate = e.target.value;
        
        document.getElementById('subSize').oninput = (e) => {
            document.getElementById('subtitleText').style.fontSize = e.target.value + 'px';
        };

        // --- Utility ---
        function formatTime(s) {
            const h = Math.floor(s / 3600);
            const m = Math.floor((s % 3600) / 60);
            const sec = Math.floor(s % 60);
            return `${h > 0 ? h+':' : ''}${m.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')}`;
        }

        // --- Fetch Source (From Original Code) ---
        async function fetchSource() {
            const urlParams = new URLSearchParams(window.location.search);
            const filmCode = urlParams.get('film');
            if (filmCode) {
                try {
                    const res = await fetch(`https://api.thirai.me/watch?url=${encodeURIComponent(`https://einthusan.tv/movie/watch/${filmCode}/`)}`);
                    const data = await res.json();
                    if (data.video_url) {
                        player.src = data.video_url;
                        document.getElementById('title').innerText = data.title;
                    }
                } catch (e) { console.error("Load failed"); }
            }
        }

        // Tap to show/hide
        document.getElementById('videoPlayerWrapper').onclick = (e) => {
            if (e.target.id === 'videoPlayerWrapper' || e.target.id === 'moviePlayer') {
                controls.classList.toggle('visible');
                settingsMenu.style.display = 'none';
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            fetchSource();
            controls.classList.add('visible');
        });
        
        document.getElementById('fsBtn').onclick = () => {
            if (!document.fullscreenElement) document.documentElement.requestFullscreen();
            else document.exitFullscreen();
        };
        
        document.getElementById('backBtn').onclick = () => window.history.back();
    </script>
</body>
</html>
